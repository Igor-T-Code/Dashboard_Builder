<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Automotive Architecture Builder v2</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- jsPDF für PDF-Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas für Canvas-Screenshot -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Automotive Component Library -->
  <script src="components-library.js"></script>
  <!-- Utility Functions -->
  <script src="src/utils.js"></script>
  <!-- Validation Engine -->
  <script src="src/validator.js"></script>
  <!-- State Manager with Undo/Redo -->
  <script src="src/stateManager.js"></script>

  <style>
    /* ============================================
       AUDI DESIGN SYSTEM 2025
       Clean, Minimal, Grey-focused
       Official Audi CI Colors
       ============================================ */

    :root {
      /* Audi Brand Colors - Primary */
      --audi-black: #000000;
      --audi-white: #FFFFFF;
      --audi-red: #EB0D3F;  /* Signal Red - nur für Warnungen */

      /* Audi Grey Scale (Official CI) - Hauptpalette */
      --color-brand-50: #F2F2F2;   /* Lightest Grey */
      --color-brand-100: #E5E5E5;
      --color-brand-200: #D9D9D9;
      --color-brand-300: #B3B3B3;
      --color-brand-400: #999999;
      --color-brand-500: #666666;  /* Mid Grey - Primary */
      --color-brand-600: #4C4C4C;  /* Dark Grey */
      --color-brand-700: #333333;  /* Darker */
      --color-brand-800: #1A1A1A;
      --color-brand-900: #000000;  /* Black */

      /* Semantic Colors */
      --color-success: #0DA20D;    /* Audi Green */
      --color-success-light: #E8F5E8;
      --color-warning: #F59E0B;
      --color-warning-light: #FEF3C7;
      --color-error: #EB0D3F;      /* Audi Signal Red */
      --color-error-light: #FDE8EC;
      --color-info: #666666;
      --color-info-light: #F2F2F2;

      /* Audi Grey Scale - Neutral */
      --slate-50: #F2F2F2;
      --slate-100: #E5E5E5;
      --slate-200: #D9D9D9;
      --slate-300: #B3B3B3;
      --slate-400: #999999;
      --slate-500: #666666;
      --slate-600: #4C4C4C;
      --slate-700: #333333;
      --slate-800: #1A1A1A;
      --slate-900: #000000;

      /* Shadows - subtle */
      --shadow-glass: 0 2px 4px rgba(0, 0, 0, 0.04), 0 4px 8px rgba(0, 0, 0, 0.04);
      --shadow-glass-lg: 0 4px 8px rgba(0, 0, 0, 0.06), 0 8px 16px rgba(0, 0, 0, 0.06);
      --shadow-glass-xl: 0 8px 16px rgba(0, 0, 0, 0.08), 0 16px 32px rgba(0, 0, 0, 0.08);
      --shadow-node: 0 1px 3px rgba(0, 0, 0, 0.06), 0 2px 6px rgba(0, 0, 0, 0.04);
      --shadow-node-hover: 0 2px 6px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.06);

      /* Border Radius - minimal/clean */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
      width: 100%;
      height: 100%;
      /* Audi 2025 - Clean grey gradient */
      background: linear-gradient(180deg, #FFFFFF 0%, #F2F2F2 100%);
    }

    ::selection {
      background: rgba(0, 0, 0, 0.15);
    }

    /* ============== LAYOUT ============== */
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }

    /* ============== TOOLBAR (Glass Header) ============== */
    .toolbar {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow:
        0 4px 6px -1px rgba(0, 0, 0, 0.05),
        0 10px 15px -3px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }
    .toolbar h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--slate-800);
      margin: 0;
      letter-spacing: -0.3px;
      background: linear-gradient(135deg, var(--color-brand-600) 0%, var(--color-brand-500) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .toolbar-actions {
      display: flex;
      gap: 8px;
    }
    .toolbar-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: 1px solid var(--slate-200);
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.8);
      color: var(--slate-600);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .toolbar-btn:hover {
      background: var(--slate-100);
      border-color: var(--slate-300);
      color: var(--slate-800);
    }
    .toolbar-btn-danger {
      color: var(--color-error);
      border-color: rgba(235, 13, 63, 0.2);
    }
    .toolbar-btn-danger:hover {
      background: var(--color-error-light);
      border-color: var(--color-error);
      color: var(--color-error);
    }
    .toolbar-btn-primary {
      background: linear-gradient(135deg, #333333 0%, #1A1A1A 100%);
      color: white;
      border-color: #333;
    }
    .toolbar-btn-primary:hover {
      background: linear-gradient(135deg, #444444 0%, #2A2A2A 100%);
      border-color: #444;
      color: white;
    }
    .toolbar-btn.build-mode-active {
      background: linear-gradient(135deg, var(--color-brand-500) 0%, var(--color-brand-600) 100%);
      color: white;
      border-color: var(--color-brand-500);
    }
    .toolbar-btn.build-mode-active:hover {
      background: linear-gradient(135deg, var(--color-brand-600) 0%, var(--color-brand-700) 100%);
    }

    /* ============== BUILD MODE ============== */
    body.build-mode .usecase-panel {
      display: none !important;
    }
    body.build-mode .usecase-library {
      display: none !important;
    }
    body.build-mode .canvas-row {
      height: 100% !important;
    }
    body.build-mode .canvas-area {
      flex: 1 !important;
    }
    body.build-mode .canvas {
      background: #f8f9fa !important;
    }
    body.build-mode .workspace {
      height: calc(100vh - 56px) !important;
    }
    .toolbar-divider {
      width: 1px;
      height: 24px;
      background: var(--slate-200);
      margin: 0 8px;
    }

    /* ============== SYSTEM VIEW MODAL ============== */
    .system-view-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      overflow: auto;
      padding: 30px;
    }
    .system-view-overlay.open {
      display: block;
    }
    .system-view-container {
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      border-radius: var(--radius-xl);
      overflow: hidden;
    }
    .system-view-header {
      background: linear-gradient(135deg, #333333 0%, #1A1A1A 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .system-view-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .system-view-header-actions {
      display: flex;
      gap: 10px;
    }
    .system-view-header-btn {
      padding: 10px 18px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .system-view-header-btn.export {
      background: white;
      color: #333;
    }
    .system-view-header-btn.export:hover {
      background: #f0f0f0;
    }
    .system-view-header-btn.close {
      background: rgba(255,255,255,0.15);
      color: white;
    }
    .system-view-header-btn.close:hover {
      background: rgba(255,255,255,0.25);
    }
    .system-view-stats {
      display: flex;
      gap: 30px;
      padding: 20px 30px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    .system-view-stat {
      text-align: center;
    }
    .system-view-stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #333;
    }
    .system-view-stat-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .system-view-content {
      padding: 0;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    .system-view-canvas-wrapper {
      padding: 20px;
      background: #fafafa;
      border-bottom: 1px solid #eee;
    }
    .system-view-canvas {
      width: 100%;
      height: 400px;
      background: white;
      border: 1px solid #e5e5e5;
      border-radius: var(--radius-lg);
      position: relative;
      overflow: hidden;
    }
    .system-view-canvas-inner {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0;
    }
    .system-view-canvas-block {
      position: absolute;
      width: 120px;
      height: 60px;
      background: white;
      border: 2px solid #333;
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: #333;
      text-align: center;
      padding: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .system-view-canvas-block-cat {
      font-size: 8px;
      font-weight: 400;
      color: #999;
      margin-top: 2px;
    }
    .system-view-usecases-section {
      padding: 20px 25px;
      background: white;
    }
    .system-view-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .system-view-usecases {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .system-view-usecase {
      background: #f8f8f8;
      border: 2px solid #e5e5e5;
      border-radius: var(--radius-lg);
      padding: 10px 15px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .system-view-usecase:hover {
      border-color: #ccc;
      background: #f0f0f0;
    }
    .system-view-usecase.selected {
      border-color: #333;
      background: white;
    }
    .system-view-usecase-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid #ccc;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .system-view-usecase.selected .system-view-usecase-checkbox {
      background: #333;
      border-color: #333;
    }
    .system-view-usecase.selected .system-view-usecase-checkbox svg {
      display: block;
    }
    .system-view-usecase-checkbox svg {
      display: none;
      color: white;
    }
    .system-view-usecase-info {
      flex: 1;
    }
    .system-view-usecase-title {
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .system-view-usecase-meta {
      font-size: 11px;
      color: #999;
    }
    .system-view-empty {
      text-align: center;
      padding: 60px 40px;
      color: #999;
    }

    /* ============== MAIN LAYOUT ============== */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
      min-width: 0;
    }

    /* ============== SIDEBAR (Glass Subtle) ============== */
    .sidebar {
      width: 240px;
      min-width: 240px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-right: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sidebar-header {
      padding: 12px 16px;
      background: linear-gradient(135deg, #333333 0%, #1A1A1A 100%);
      color: white;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .sidebar-actions {
      padding: 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(255, 255, 255, 0.4);
    }
    .sidebar-btn {
      width: 100%;
      padding: 10px 14px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--slate-700);
      text-align: left;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }
    .sidebar-btn:hover {
      background: linear-gradient(135deg, #333333 0%, #1A1A1A 100%);
      color: white;
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      transform: translateY(-1px);
    }
    .sidebar-btn:active {
      transform: translateY(0);
    }
    .sidebar-btn:last-child {
      margin-bottom: 0;
    }
    .sidebar-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148, 163, 184, 0.3), transparent);
      margin: 10px 0;
    }
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .sidebar-content::-webkit-scrollbar {
      width: 6px;
    }
    .sidebar-content::-webkit-scrollbar-track {
      background: transparent;
    }
    .sidebar-content::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.3);
      border-radius: var(--radius-sm);
    }
    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.5);
    }

    /* ============== CATEGORIES (Glass Cards) ============== */
    .category {
      margin-bottom: 8px;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: var(--shadow-node);
    }
    .category-header {
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      color: var(--slate-700);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.15s ease;
    }
    .category-header:hover {
      background: rgba(255, 255, 255, 0.8);
    }
    .category-header .toggle {
      font-size: 10px;
      color: var(--slate-400);
      transition: transform 0.2s ease;
    }
    .category-items {
      display: none;
      padding: 8px;
      background: rgba(255, 255, 255, 0.3);
    }
    .category.open .category-items { display: block; }
    .category.open .toggle { transform: rotate(90deg); }

    .block-item {
      padding: 10px 12px;
      margin: 4px 0;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-left: 3px solid var(--color-brand-500);
      cursor: grab;
      font-size: 12px;
      font-weight: 500;
      color: var(--slate-700);
      border-radius: var(--radius-sm);
      transition: all 0.15s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    .block-item:hover {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: var(--shadow-node-hover);
      transform: translateY(-1px);
    }

    .add-block-btn, .add-category-btn {
      width: 100%;
      margin: 6px 0;
      padding: 8px 12px;
      background: transparent;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--slate-500);
      border-radius: var(--radius-sm);
      transition: all 0.15s ease;
    }
    .add-block-btn:hover, .add-category-btn:hover {
      background: rgba(0, 0, 0, 0.08);
      border-color: var(--color-brand-400);
      color: var(--color-brand-600);
    }

    /* ============== DRAG & DROP SORTING ============== */
    .category.dragging {
      opacity: 0.5;
      transform: scale(0.98);
    }
    .category.drag-over {
      border: 2px dashed var(--color-brand-500);
      background: rgba(0, 0, 0, 0.05);
    }
    .block-item.dragging-sort {
      opacity: 0.5;
      transform: scale(0.95);
    }
    .block-item.drag-over-sort {
      border-top: 3px solid var(--color-brand-500);
      margin-top: -3px;
    }
    .block-item.drag-over-sort-bottom {
      border-bottom: 3px solid var(--color-brand-500);
      margin-bottom: -3px;
    }
    .category-items.drag-over-category {
      background: rgba(0, 0, 0, 0.08) !important;
      min-height: 50px;
    }
    .drag-handle {
      cursor: grab;
      opacity: 0.4;
      transition: opacity 0.15s;
      margin-right: 6px;
      display: inline-flex;
      align-items: center;
    }
    .drag-handle:hover {
      opacity: 1;
    }
    .drag-handle:active {
      cursor: grabbing;
    }

    /* ============== WORKSPACE ============== */
    .workspace {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      overflow: hidden;
    }

    /* Canvas Row */
    .canvas-row {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-width: 0;
    }

    /* ============== CANVAS AREA ============== */
    .canvas-area {
      flex: 1;
      position: relative;
      overflow: auto;
      min-width: 0;
      background: #FFFFFF;
    }
    .canvas {
      position: relative;
      width: 15000px;
      height: 10000px;
      background: #FFFFFF;
      background-image: radial-gradient(rgba(148, 163, 184, 0.3) 1px, transparent 1px);
      background-size: 20px 20px;
      transform-origin: top left;
    }
    .canvas.no-grid {
      background-image: none;
    }

    /* Canvas Controls (Zoom & Grid) */
    .canvas-controls {
      position: absolute;
      bottom: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      z-index: 100;
    }
    .canvas-grid-toggle {
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background 0.2s ease;
    }
    .canvas-grid-toggle:hover {
      background: rgba(0, 0, 0, 0.8);
    }
    .canvas-grid-toggle.active {
      background: rgba(30, 30, 30, 0.9);
    }
    .canvas-grid-toggle svg {
      width: 14px;
      height: 14px;
    }
    .canvas-zoom-btn {
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 6px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      width: 28px;
      height: 28px;
    }
    .canvas-zoom-btn:hover {
      background: rgba(0, 0, 0, 0.8);
      transform: scale(1.05);
    }
    .canvas-zoom-btn:active {
      transform: scale(0.95);
    }
    .canvas-zoom-btn svg {
      width: 16px;
      height: 16px;
    }
    .canvas-zoom-display {
      position: relative;
      bottom: auto;
      right: auto;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 500;
      z-index: 50;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .canvas-zoom-display.visible {
      opacity: 1;
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: var(--radius-md);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      min-width: 160px;
      z-index: 10000;
      padding: 4px 0;
      display: none;
    }
    .context-menu.visible {
      display: block;
    }
    .context-menu-item {
      padding: 8px 14px;
      font-size: 12px;
      color: var(--slate-700);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.1s ease;
    }
    .context-menu-item:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    .context-menu-item.danger {
      color: #DC2626;
    }
    .context-menu-item.danger:hover {
      background: rgba(220, 38, 38, 0.1);
    }
    .context-menu-item .icon-svg {
      width: 14px;
      height: 14px;
      opacity: 0.7;
    }
    .context-menu-divider {
      height: 1px;
      background: rgba(0, 0, 0, 0.08);
      margin: 4px 0;
    }

    /* ============== CANVAS HEADER (Glass) ============== */
    .canvas-header {
      position: sticky;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: var(--slate-800);
      padding: 16px 24px;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: var(--shadow-glass);
    }
    .canvas-header h2 {
      font-size: 17px;
      font-weight: 600;
      margin: 0;
      color: var(--slate-800);
    }
    .canvas-header .uc-phase-badge {
      padding: 5px 12px;
      background: linear-gradient(135deg, #333333 0%, #1A1A1A 100%);
      color: white;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
    }
    .canvas-header .uc-status-badge {
      padding: 5px 12px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: var(--slate-600);
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
    }

    /* ============== EMPTY CANVAS STATE ============== */
    .canvas-empty {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: var(--slate-400);
    }
    .canvas-empty .icon {
      font-size: 56px;
      margin-bottom: 16px;
      opacity: 0.8;
    }
    .canvas-empty h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--slate-600);
      margin-bottom: 8px;
    }
    .canvas-empty p {
      font-size: 13px;
      color: var(--slate-500);
    }

    /* ============== USE CASE PANEL (Glass) ============== */
    .usecase-panel {
      width: 340px;
      min-width: 340px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-left: 1px solid rgba(255, 255, 255, 0.4);
      display: flex;
      flex-direction: column;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.04);
    }
    .usecase-panel-header {
      padding: 14px 20px;
      background: linear-gradient(135deg, #333333 0%, #1A1A1A 100%);
      color: white;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .usecase-panel-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .usecase-panel-content::-webkit-scrollbar {
      width: 6px;
    }
    .usecase-panel-content::-webkit-scrollbar-track {
      background: transparent;
    }
    .usecase-panel-content::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.15);
      border-radius: var(--radius-sm);
    }
    .usecase-panel label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: var(--slate-600);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 6px;
      margin-top: 16px;
    }
    .usecase-panel label:first-child { margin-top: 0; }

    /* Use Case Panel - Inline Row für Name + Phase */
    .usecase-panel .uc-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: start;
    }
    .usecase-panel .uc-row label {
      margin-top: 0;
    }

    /* ============== GLASS INPUTS ============== */
    .usecase-panel input,
    .usecase-panel select,
    .usecase-panel textarea {
      width: 100%;
      padding: 11px 14px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-family: inherit;
      color: var(--slate-700);
      transition: all 0.2s ease;
    }
    .usecase-panel input:hover,
    .usecase-panel select:hover,
    .usecase-panel textarea:hover {
      background: rgba(255, 255, 255, 0.85);
      border-color: rgba(148, 163, 184, 0.3);
    }
    .usecase-panel input:focus,
    .usecase-panel select:focus,
    .usecase-panel textarea:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(0, 0, 0, 0.5);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }
    .usecase-panel textarea {
      min-height: 80px;
      resize: vertical;
    }
    .usecase-panel select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }

    /* ============== STATS (Glass Cards) ============== */
    .usecase-panel .uc-stats {
      display: flex;
      gap: 10px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid rgba(148, 163, 184, 0.15);
    }
    .usecase-panel .uc-stat {
      flex: 1;
      text-align: center;
      padding: 14px 10px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-node);
    }
    .usecase-panel .uc-stat-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--color-brand-600);
    }
    .usecase-panel .uc-stat-label {
      font-size: 10px;
      font-weight: 500;
      color: var(--slate-500);
      text-transform: uppercase;
      margin-top: 4px;
    }

    /* ============== USE CASE LIBRARY (Glass) ============== */
    .usecase-library {
      height: 18vh;
      min-height: 140px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255, 255, 255, 0.4);
      display: flex;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.04);
    }
    .usecase-column {
      flex: 1;
      border-right: 1px solid rgba(148, 163, 184, 0.15);
      display: flex;
      flex-direction: column;
    }
    .usecase-column:last-child { border-right: none; }
    .usecase-column-header {
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.5);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--slate-600);
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      text-align: center;
    }
    .usecase-column-content {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
    }
    .usecase-card {
      padding: 10px 12px;
      margin-bottom: 6px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.15s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    .usecase-card:hover {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: var(--shadow-node);
      transform: translateY(-1px);
    }
    .usecase-card.active {
      background: linear-gradient(135deg, #333333 0%, #1A1A1A 100%);
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .usecase-card .uc-name {
      font-weight: 600;
    }
    .usecase-card .uc-info {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 3px;
    }

    .add-usecase-btn {
      margin: 8px;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.04) 0%, rgba(0, 0, 0, 0.02) 100%);
      border: 1.5px dashed var(--color-brand-300);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--color-brand-600);
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .add-usecase-btn:hover {
      background: linear-gradient(135deg, #333333 0%, #1A1A1A 100%);
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateY(-1px);
    }
    .add-usecase-btn .icon-svg {
      width: 16px;
      height: 16px;
    }
    
    /* ============== CANVAS BLOCKS (Glass Node) ============== */
    .canvas-block {
      position: absolute;
      min-width: 150px;
      max-width: 190px;
      padding: 14px;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: var(--radius-lg);
      cursor: move;
      user-select: none;
      font-size: 12px;
      text-align: center;
      box-shadow:
        0 2px 8px -2px rgba(0, 0, 0, 0.08),
        0 4px 12px -4px rgba(0, 0, 0, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      transition: all 0.2s ease;
    }
    .canvas-block:hover {
      box-shadow:
        0 4px 12px -2px rgba(0, 0, 0, 0.12),
        0 8px 20px -4px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      transform: translateY(-2px);
    }
    .canvas-block.selected {
      box-shadow:
        0 0 0 2px rgba(0, 0, 0, 0.5),
        0 4px 12px -2px rgba(0, 0, 0, 0.15),
        0 8px 20px -4px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      border-color: transparent;
    }

    /* Anforderungs-Status Glow */
    .canvas-block.reqs-complete {
      box-shadow:
        0 0 20px 4px rgba(34, 197, 94, 0.35),
        0 0 40px 8px rgba(34, 197, 94, 0.15),
        0 2px 8px -2px rgba(0, 0, 0, 0.08),
        0 4px 16px -4px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      border-color: rgba(34, 197, 94, 0.4);
    }
    .canvas-block.reqs-complete:hover {
      box-shadow:
        0 0 24px 6px rgba(34, 197, 94, 0.45),
        0 0 48px 10px rgba(34, 197, 94, 0.2),
        0 4px 12px -2px rgba(0, 0, 0, 0.12),
        0 8px 20px -4px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      transform: translateY(-2px);
    }
    .canvas-block.reqs-incomplete {
      box-shadow:
        0 0 20px 4px rgba(239, 68, 68, 0.35),
        0 0 40px 8px rgba(239, 68, 68, 0.15),
        0 2px 8px -2px rgba(0, 0, 0, 0.08),
        0 4px 16px -4px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      border-color: rgba(239, 68, 68, 0.4);
    }
    .canvas-block.reqs-incomplete:hover {
      box-shadow:
        0 0 24px 6px rgba(239, 68, 68, 0.45),
        0 0 48px 10px rgba(239, 68, 68, 0.2),
        0 4px 12px -2px rgba(0, 0, 0, 0.12),
        0 8px 20px -4px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      transform: translateY(-2px);
    }
    .canvas-block.selected.reqs-complete {
      box-shadow:
        0 0 0 2px rgba(34, 197, 94, 0.7),
        0 0 20px 4px rgba(34, 197, 94, 0.35),
        0 0 40px 8px rgba(34, 197, 94, 0.15),
        0 4px 12px -2px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }
    .canvas-block.selected.reqs-incomplete {
      box-shadow:
        0 0 0 2px rgba(239, 68, 68, 0.7),
        0 0 20px 4px rgba(239, 68, 68, 0.35),
        0 0 40px 8px rgba(239, 68, 68, 0.15),
        0 4px 12px -2px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .canvas-block .block-icon {
      font-size: 38px;
      margin-bottom: 10px;
      line-height: 1;
    }
    .canvas-block .block-header {
      font-weight: 600;
      font-size: 13px;
      color: var(--slate-800);
      margin-bottom: 6px;
      word-wrap: break-word;
    }
    .canvas-block .block-type {
      font-size: 10px;
      font-weight: 500;
      color: var(--color-brand-600);
      background: rgba(0, 0, 0, 0.12);
      padding: 3px 10px;
      border-radius: 20px;
      display: inline-block;
      margin-bottom: 8px;
    }
    .canvas-block .block-desc {
      font-size: 10px;
      color: var(--slate-500);
      line-height: 1.4;
      max-height: 40px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ============== CONTAINER (Glass with Pastel) ============== */
    .canvas-container {
      position: absolute;
      min-width: 200px;
      min-height: 150px;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 2px dashed rgba(148, 163, 184, 0.4);
      border-radius: var(--radius-lg);
      cursor: move;
      user-select: none;
      transition: all 0.2s ease;
    }
    /* Pastell-Farbvarianten für Container */
    .canvas-container.pastel-blue {
      background: linear-gradient(135deg, rgba(173, 216, 230, 0.35) 0%, rgba(255, 255, 255, 0.4) 100%);
      border-color: rgba(100, 149, 237, 0.5);
    }
    .canvas-container.pastel-mint {
      background: linear-gradient(135deg, rgba(152, 251, 152, 0.3) 0%, rgba(255, 255, 255, 0.4) 100%);
      border-color: rgba(60, 179, 113, 0.5);
    }
    .canvas-container.pastel-lavender {
      background: linear-gradient(135deg, rgba(230, 190, 230, 0.35) 0%, rgba(255, 255, 255, 0.4) 100%);
      border-color: rgba(186, 85, 211, 0.5);
    }
    .canvas-container.pastel-peach {
      background: linear-gradient(135deg, rgba(255, 218, 185, 0.4) 0%, rgba(255, 255, 255, 0.4) 100%);
      border-color: rgba(255, 140, 105, 0.5);
    }
    .canvas-container.pastel-lemon {
      background: linear-gradient(135deg, rgba(255, 250, 205, 0.45) 0%, rgba(255, 255, 255, 0.4) 100%);
      border-color: rgba(218, 165, 32, 0.5);
    }
    .canvas-container.pastel-rose {
      background: linear-gradient(135deg, rgba(255, 182, 193, 0.35) 0%, rgba(255, 255, 255, 0.4) 100%);
      border-color: rgba(219, 112, 147, 0.5);
    }
    .canvas-container.pastel-sky {
      background: linear-gradient(135deg, rgba(135, 206, 235, 0.35) 0%, rgba(255, 255, 255, 0.4) 100%);
      border-color: rgba(70, 130, 180, 0.5);
    }
    .canvas-container.pastel-sage {
      background: linear-gradient(135deg, rgba(188, 212, 188, 0.4) 0%, rgba(255, 255, 255, 0.4) 100%);
      border-color: rgba(107, 142, 85, 0.5);
    }
    .canvas-container:hover {
      filter: brightness(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .canvas-container.selected {
      border-style: solid;
      border-color: var(--color-brand-500);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.15);
    }

    /* Multi-Selection Counter */
    .selection-counter {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--color-brand-600);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
    }
    .selection-counter.visible {
      display: flex;
    }
    .selection-counter kbd {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }

    /* Marquee Selection Box */
    .selection-box {
      position: absolute;
      border: 2px dashed var(--color-brand-500);
      background: rgba(59, 130, 246, 0.1);
      pointer-events: none;
      z-index: 1000;
    }

    /* Copy/Paste Toast */
    .copy-paste-toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--slate-800);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
    }
    .copy-paste-toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .canvas-container .container-header {
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      font-weight: 600;
      font-size: 13px;
      color: var(--slate-700);
      border-bottom: 1px dashed rgba(148, 163, 184, 0.3);
    }
    .canvas-container .container-content {
      padding: 12px;
      min-height: 100px;
    }

    /* ============== ANCHORS (Connection Points) ============== */
    .anchor {
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--color-brand-500);
      border: 2px solid white;
      border-radius: 50%;
      cursor: crosshair;
      z-index: 10;
      opacity: 0;
      transition: all 0.15s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }
    .canvas-block:hover .anchor,
    .canvas-container:hover .anchor {
      opacity: 1;
    }
    .anchor:hover {
      background: var(--color-brand-600);
      transform: scale(1.4);
      opacity: 1;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    .anchor.active {
      background: var(--color-brand-600);
      opacity: 1;
      animation: anchor-pulse 1s infinite;
    }
    @keyframes anchor-pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4); }
      50% { transform: scale(1.3); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.6); }
    }
    .anchor-top { top: -6px; left: 50%; margin-left: -6px; }
    .anchor-bottom { bottom: -6px; left: 50%; margin-left: -6px; }
    .anchor-left { left: -6px; top: 50%; margin-top: -6px; }
    .anchor-right { right: -6px; top: 50%; margin-top: -6px; }

    /* ============== SVG CONNECTIONS ============== */
    .connections-svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    .connection {
      stroke: #64748b;
      stroke-width: 1.5;
      fill: none;
      pointer-events: stroke;
      cursor: pointer;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: all 0.2s ease;
    }
    .connection:hover {
      stroke: var(--color-brand-500);
      stroke-width: 2;
      filter: drop-shadow(0 0 3px rgba(235, 13, 63, 0.4));
    }
    .connection-shadow {
      stroke: rgba(0, 0, 0, 0.08);
      stroke-width: 4;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .connection-temp {
      stroke: var(--color-brand-500);
      stroke-width: 1.5;
      stroke-dasharray: 8, 6;
      fill: none;
      stroke-linecap: round;
      animation: dash-flow 0.5s linear infinite;
    }
    @keyframes dash-flow {
      to { stroke-dashoffset: -14; }
    }

    /* ============== RESIZE HANDLE ============== */
    .resize-handle {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 16px;
      height: 16px;
      cursor: se-resize;
      background: linear-gradient(135deg, transparent 50%, rgba(148, 163, 184, 0.5) 50%);
      border-radius: 0 0 var(--radius-lg) 0;
      transition: background 0.15s ease;
    }
    .resize-handle:hover {
      background: linear-gradient(135deg, transparent 50%, var(--color-brand-400) 50%);
    }
    
    /* ============== MODAL (Glass Elevated) ============== */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15, 23, 42, 0.2);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-overlay.open {
      display: flex;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: var(--radius-xl);
      min-width: 480px;
      max-width: 580px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow:
        0 8px 16px -4px rgba(0, 0, 0, 0.08),
        0 20px 25px -5px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      animation: modalSlideIn 0.25s ease;
    }
    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.95) translateY(-10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .modal-header {
      padding: 18px 24px;
      background: linear-gradient(135deg, #333333 0%, #1A1A1A 100%);
      color: white;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: var(--radius-md);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-body::-webkit-scrollbar {
      width: 6px;
    }
    .modal-body::-webkit-scrollbar-track {
      background: transparent;
    }
    .modal-body::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.3);
      border-radius: var(--radius-sm);
    }
    .modal-footer {
      padding: 16px 24px;
      background: rgba(255, 255, 255, 0.6);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      border-top: 1px solid rgba(148, 163, 184, 0.15);
    }

    .modal label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: var(--slate-600);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 6px;
      margin-top: 18px;
    }
    .modal label:first-child { margin-top: 0; }
    .modal input, .modal select, .modal textarea {
      width: 100%;
      padding: 11px 14px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-family: inherit;
      color: var(--slate-700);
      transition: all 0.2s ease;
    }
    .modal input:hover, .modal select:hover, .modal textarea:hover {
      background: rgba(255, 255, 255, 0.85);
      border-color: rgba(148, 163, 184, 0.3);
    }
    .modal input:focus, .modal select:focus, .modal textarea:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(0, 0, 0, 0.5);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }
    .modal textarea {
      min-height: 70px;
      resize: vertical;
    }
    .modal select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }

    /* ============== REQUIREMENTS CHECKLIST ============== */
    .requirements-list {
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-md);
      padding: 12px;
      max-height: 160px;
      overflow-y: auto;
    }
    .requirement-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }
    .requirement-item:last-child { border-bottom: none; }
    .requirement-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--color-brand-500);
    }
    .requirement-item input[type="text"] {
      flex: 1;
      padding: 6px 10px;
      font-size: 12px;
    }
    .requirement-item .delete-req {
      background: none;
      border: none;
      color: var(--slate-400);
      cursor: pointer;
      font-size: 16px;
      width: 28px;
      height: 28px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .requirement-item .delete-req:hover {
      color: var(--color-error);
      background: var(--color-error-light);
    }
    .add-requirement-btn {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      background: transparent;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--slate-500);
      border-radius: var(--radius-sm);
      transition: all 0.15s ease;
    }
    .add-requirement-btn:hover {
      background: rgba(0, 0, 0, 0.08);
      border-color: var(--color-brand-400);
      color: var(--color-brand-600);
    }

    /* ============== ICON PICKER ============== */
    .icon-picker {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-md);
      padding: 14px;
      max-height: 160px;
      overflow-y: auto;
    }
    .icon-option {
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid transparent;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
      color: var(--slate-600);
    }
    .icon-option:hover {
      background: rgba(255, 255, 255, 1);
      transform: scale(1.1);
      box-shadow: var(--shadow-node);
      color: var(--color-brand-600);
    }
    .icon-option.selected {
      border-color: var(--color-brand-500);
      background: rgba(0, 0, 0, 0.1);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.15);
      color: var(--color-brand-600);
    }
    .icon-option .icon-svg {
      width: 20px;
      height: 20px;
    }

    /* ============== SELECTED ICON DISPLAY ============== */
    .selected-icon-display {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-md);
      margin-bottom: 10px;
    }
    .selected-icon-display .icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: var(--shadow-node);
      color: var(--color-brand-600);
    }
    .selected-icon-display .icon .icon-svg {
      width: 28px;
      height: 28px;
    }
    .selected-icon-display .label {
      font-size: 12px;
      color: var(--slate-500);
    }

    /* ============== BUTTONS (Glass) ============== */
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.15s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, #333333 0%, #1A1A1A 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
    }
    .btn-primary:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      color: var(--slate-700);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.06);
      transform: translateY(-1px);
    }
    .btn-danger {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.95) 0%, rgba(220, 38, 38, 0.95) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
    }
    .btn-danger:hover {
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
      transform: translateY(-1px);
    }

    /* ============== USED-IN LIST ============== */
    .used-in-list {
      background: rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: var(--radius-md);
      padding: 12px;
      font-size: 12px;
      color: var(--slate-600);
    }
    .used-in-list div {
      padding: 3px 0;
    }

    /* ============== HIDDEN FILE INPUT ============== */
    #fileInput { display: none; }

    /* ============== CATEGORY COLORS ============== */
    .cat-fahrzeug { border-left-color: #3B82F6 !important; }
    .cat-ingestion { border-left-color: #8B5CF6 !important; }
    .cat-storage { border-left-color: #06B6D4 !important; }
    .cat-processing { border-left-color: #10B981 !important; }
    .cat-serving { border-left-color: #F59E0B !important; }
    .cat-frontend { border-left-color: #EF4444 !important; }
    .cat-external { border-left-color: #64748B !important; }

    /* ============== FOCUS VISIBLE ============== */
    *:focus-visible {
      outline: 2px solid rgba(0, 0, 0, 0.5);
      outline-offset: 2px;
    }

    /* ============== SVG ICONS ============== */
    .icon-svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 1.75;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
      flex-shrink: 0;
    }
    .icon-svg.icon-sm {
      width: 16px;
      height: 16px;
    }
    .icon-svg.icon-lg {
      width: 20px;
      height: 20px;
    }
    .icon-svg.icon-xl {
      width: 24px;
      height: 24px;
    }

    /* Sidebar buttons with icons */
    .sidebar-btn {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Column header with icon */
    .usecase-column-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .usecase-column-header .icon-svg {
      width: 14px;
      height: 14px;
    }

    /* Panel header with icon */
    .usecase-panel-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Toolbar with icon */
    .toolbar h1 {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .toolbar .icon-svg {
      width: 22px;
      height: 22px;
      stroke: var(--color-brand-500);
    }

    /* Canvas empty state icon */
    .canvas-empty .icon-svg {
      width: 56px;
      height: 56px;
      stroke: var(--slate-300);
      stroke-width: 1.5;
      margin-bottom: 16px;
    }

    /* ============== COMPONENT LIBRARY ============== */
    .lib-component-card {
      background: white;
      border: 2px solid #e5e5e5;
      border-radius: var(--radius-lg);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    .lib-component-card:hover {
      border-color: #999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .lib-component-card.selected {
      border-color: #1565C0;
      background: #E3F2FD;
      box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.2);
    }
    .lib-component-card.selected::after {
      content: '✓';
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      background: #1565C0;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }
    .lib-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .lib-card-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }
    .lib-card-title {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      line-height: 1.3;
    }
    .lib-card-shortname {
      font-size: 11px;
      color: #888;
      font-weight: 500;
      margin-top: 2px;
    }
    .lib-card-category {
      display: inline-block;
      font-size: 10px;
      font-weight: 600;
      color: white;
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .lib-card-description {
      font-size: 12px;
      color: #666;
      line-height: 1.5;
      margin-bottom: 10px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .lib-card-requirements {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .lib-card-req {
      font-size: 10px;
      background: #f0f0f0;
      color: #555;
      padding: 3px 7px;
      border-radius: var(--radius-sm);
    }
    .lib-category-section {
      grid-column: 1 / -1;
      padding: 12px 0 8px 0;
      border-bottom: 2px solid #e5e5e5;
      margin-bottom: 8px;
    }
    .lib-category-title {
      font-size: 13px;
      font-weight: 700;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .lib-category-count {
      font-size: 11px;
      font-weight: 500;
      color: #888;
      background: #f0f0f0;
      padding: 2px 8px;
      border-radius: 20px;
    }
  </style>
</head>
<body>
  <!-- Selection Counter -->
  <div class="selection-counter" id="selectionCounter">
    <span id="selectionCount">0</span> Elemente ausgewählt
    <kbd>Del</kbd> Löschen
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="contextMenuEdit()">
      <svg class="icon-svg" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Bearbeiten
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" onclick="contextMenuDelete()">
      <svg class="icon-svg" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
      Löschen
    </div>
  </div>

  <div class="app">
    <!-- Toolbar -->
    <div class="toolbar">
      <h1>
        <svg class="audi-rings" viewBox="0 0 106 30" style="height: 22px; width: auto; margin-right: 12px;">
          <!-- Audi Ringe - 4 ineinander verschlungene Ringe -->
          <circle cx="15" cy="15" r="13" fill="none" stroke="#000000" stroke-width="2"/>
          <circle cx="38" cy="15" r="13" fill="none" stroke="#000000" stroke-width="2"/>
          <circle cx="61" cy="15" r="13" fill="none" stroke="#000000" stroke-width="2"/>
          <circle cx="84" cy="15" r="13" fill="none" stroke="#000000" stroke-width="2"/>
        </svg>
        Data Platform Builder
      </h1>
      <div class="toolbar-actions">
        <button class="toolbar-btn" onclick="importProject()" title="Projekt laden">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Laden
        </button>
        <button class="toolbar-btn" onclick="exportProject()" title="Projekt speichern">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Speichern
        </button>
        <button class="toolbar-btn" onclick="exportAsShareable()" title="Als einzelne HTML-Datei exportieren (zum Teilen per Email)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <circle cx="18" cy="5" r="3"/>
            <circle cx="6" cy="12" r="3"/>
            <circle cx="18" cy="19" r="3"/>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
          </svg>
          Teilen
        </button>
        <button class="toolbar-btn toolbar-btn-danger" onclick="resetToDefault()" title="Auf Standardwerte zurücksetzen">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <polyline points="1 4 1 10 7 10"/>
            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
          </svg>
          Reset
        </button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-btn toolbar-btn-primary" onclick="openSystemView()" title="Alle Use Cases als System-Übersicht">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
          </svg>
          System-Sicht
        </button>
        <button class="toolbar-btn" onclick="openComponentLibrary()" title="Komponenten-Bibliothek">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
            <line x1="12" y1="6" x2="12" y2="10"/>
            <line x1="10" y1="8" x2="14" y2="8"/>
          </svg>
          Bibliothek
        </button>
        <button class="toolbar-btn" id="buildModeBtn" onclick="toggleBuildMode()" title="Build Mode - Fokussierte Ansicht">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
            <line x1="8" y1="21" x2="16" y2="21"/>
            <line x1="12" y1="17" x2="12" y2="21"/>
          </svg>
          Build Mode
        </button>
      </div>
    </div>

    <div class="main">
      <!-- Sidebar: Block-Katalog & Steuerung -->
      <div class="sidebar">
        <!-- Block-Katalog -->
        <div class="sidebar-header">
          <svg class="icon-svg" viewBox="0 0 24 24">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            <polyline points="3.29 7 12 12 20.71 7"/>
            <line x1="12" y1="22" x2="12" y2="12"/>
          </svg>
          Block-Katalog
        </div>
        <div class="sidebar-content" id="categoriesContainer">
          <!-- Categories will be rendered here -->
        </div>

        <!-- Aktionen -->
        <div class="sidebar-header">
          <svg class="icon-svg" viewBox="0 0 24 24">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
          </svg>
          Aktionen
        </div>
        <div class="sidebar-actions">
          <button class="sidebar-btn" onclick="addBlockToCategory()">
            <svg class="icon-svg" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Neuer Block
          </button>
          <button class="sidebar-btn" onclick="addContainer()">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" y1="22" x2="12" y2="12"/></svg>
            Neuer Container
          </button>
          <button class="sidebar-btn" onclick="addNewCategory()">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
            Neue Kategorie
          </button>
          <div class="sidebar-divider"></div>
          <button class="sidebar-btn" onclick="saveProject()">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Projekt speichern
          </button>
          <button class="sidebar-btn" onclick="loadProject()">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
            Projekt laden
          </button>
          <button class="sidebar-btn" onclick="exportProject()">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            Export
          </button>
        </div>
      </div>
      
      <!-- Workspace -->
      <div class="workspace">
        <!-- Canvas Row -->
        <div class="canvas-row">
          <!-- Canvas -->
          <div class="canvas-area">
            <div class="canvas" id="canvas">
              <svg class="connections-svg" id="connectionsSvg">
                <defs>
                  <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
                  </marker>
                </defs>
              </svg>
            </div>
            <!-- Canvas Controls (now outside canvas, fixed to viewport) -->
            <div class="canvas-controls">
              <button class="canvas-grid-toggle active" id="gridToggle" onclick="toggleSnapToGrid()" title="Snap to Grid (G)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/>
                </svg>
                Grid
              </button>
              <div style="display: flex; gap: 4px; align-items: center;">
                <button class="canvas-zoom-btn" onclick="zoomOut()" title="Zoom Out (-)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                  </svg>
                </button>
                <button class="canvas-zoom-btn" onclick="zoomIn()" title="Zoom In (+)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                    <line x1="11" y1="8" x2="11" y2="14"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                  </svg>
                </button>
                <button class="canvas-zoom-btn" onclick="fitToContent()" title="Fit to Content">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                    <rect x="9" y="9" width="6" height="6"/>
                  </svg>
                </button>
              </div>
              <div class="canvas-zoom-display" id="canvasZoomDisplay">100%</div>
            </div>
          </div>
          
          <!-- Use Case Panel (rechts vom Canvas) -->
          <div class="usecase-panel" id="usecasePanelContainer">
            <div class="usecase-panel-header">
              <svg class="icon-svg" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
              Use Case Details
            </div>
            <div class="usecase-panel-content" id="usecasePanel">
              <div style="color: #999; text-align: center; padding: 40px 20px;">
                <svg class="icon-svg icon-xl" viewBox="0 0 24 24" style="margin-bottom: 10px; opacity: 0.5;"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                <div>Wähle einen Use Case aus der Bibliothek<br>oder erstelle einen neuen</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Use Case Library (dynamically rendered) -->
        <div class="usecase-library">
          <!-- Phases will be rendered here by renderPhases() -->
        </div>
      </div>
    </div>
  </div>

  <!-- System View Overlay -->
  <div class="system-view-overlay" id="systemViewOverlay">
    <div class="system-view-container">
      <div class="system-view-header">
        <h2>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
          </svg>
          System-Übersicht
        </h2>
        <div class="system-view-header-actions">
          <button class="system-view-header-btn export" onclick="exportSystemPDF()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
            System-PDF Export
          </button>
          <button class="system-view-header-btn close" onclick="closeSystemView()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
            Schliessen
          </button>
        </div>
      </div>
      <div class="system-view-stats" id="systemViewStats">
        <!-- Stats rendered by JS -->
      </div>
      <div class="system-view-content" id="systemViewContent">
        <!-- Use Cases rendered by JS -->
      </div>
    </div>
  </div>

  <!-- Block Modal -->
  <div class="modal-overlay" id="blockModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <span id="blockModalTitle">
          <svg class="icon-svg" viewBox="0 0 24 24" style="margin-right: 6px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
          Block bearbeiten
        </span>
        <button class="modal-close" onclick="closeBlockModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="blockModalId">
        <input type="hidden" id="blockModalIcon" value="cpu">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label>Name *</label>
            <input type="text" id="blockModalName" placeholder="Block-Name">
          </div>
          <div>
            <label>Kategorie *</label>
            <select id="blockModalCategory"></select>
          </div>
        </div>

        <label>Icon</label>
        <div class="selected-icon-display">
          <div class="icon" id="blockModalIconPreview"></div>
          <div class="label">Klicke unten um ein Icon auszuwählen</div>
        </div>
        <div class="icon-picker" id="blockModalIconPicker">
          <!-- Icons werden per JS eingefügt -->
        </div>

        <label>Beschreibung</label>
        <textarea id="blockModalDesc" placeholder="Was macht dieser Block? Welche Funktion hat er im System?"></textarea>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label>Verantwortlich</label>
            <input type="text" id="blockModalOwner" placeholder="Team oder Person">
          </div>
          <div>
            <label>Status</label>
            <select id="blockModalStatus">
              <option value="offen">Offen</option>
              <option value="in-klaerung">In Klärung</option>
              <option value="definiert">Definiert</option>
              <option value="implementiert">Implementiert</option>
            </select>
          </div>
        </div>

        <label>Anforderungen (Checkliste)</label>
        <div class="requirements-list" id="blockModalReqs"></div>
        <button class="add-requirement-btn" onclick="addRequirement()">+ Anforderung hinzufügen</button>

        <label>Notizen / Offene Fragen</label>
        <textarea id="blockModalNotes" placeholder="Offene Fragen, Klärungsbedarf, technische Details..."></textarea>

        <label>Verwendet in Use Cases</label>
        <div class="used-in-list" id="blockModalUsedIn">-</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="blockModalDeleteBtn" onclick="deleteBlock()">Löschen</button>
        <button class="btn btn-secondary" onclick="closeBlockModal()">Abbrechen</button>
        <button class="btn btn-primary" onclick="saveBlockModal()">Speichern</button>
      </div>
    </div>
  </div>
  
  <!-- Container Modal -->
  <div class="modal-overlay" id="containerModal">
    <div class="modal">
      <div class="modal-header">
        <span>
          <svg class="icon-svg" viewBox="0 0 24 24" style="margin-right: 6px;"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" y1="22" x2="12" y2="12"/></svg>
          Container bearbeiten
        </span>
        <button class="modal-close" onclick="closeContainerModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="containerModalId">
        
        <label>Name</label>
        <input type="text" id="containerModalName" placeholder="Container-Name (z.B. Fahrzeug)">

        <label>Farbe</label>
        <div id="containerColorPicker" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
          <label class="color-option" style="cursor: pointer;">
            <input type="radio" name="containerColor" value="pastel-blue" style="display: none;">
            <span style="display: block; width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, rgba(173, 216, 230, 0.7), rgba(100, 149, 237, 0.5)); border: 2px solid transparent;" title="Blau"></span>
          </label>
          <label class="color-option" style="cursor: pointer;">
            <input type="radio" name="containerColor" value="pastel-mint" style="display: none;">
            <span style="display: block; width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, rgba(152, 251, 152, 0.6), rgba(60, 179, 113, 0.5)); border: 2px solid transparent;" title="Mint"></span>
          </label>
          <label class="color-option" style="cursor: pointer;">
            <input type="radio" name="containerColor" value="pastel-lavender" style="display: none;">
            <span style="display: block; width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, rgba(230, 190, 230, 0.7), rgba(186, 85, 211, 0.5)); border: 2px solid transparent;" title="Lavendel"></span>
          </label>
          <label class="color-option" style="cursor: pointer;">
            <input type="radio" name="containerColor" value="pastel-peach" style="display: none;">
            <span style="display: block; width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, rgba(255, 218, 185, 0.7), rgba(255, 140, 105, 0.5)); border: 2px solid transparent;" title="Pfirsich"></span>
          </label>
          <label class="color-option" style="cursor: pointer;">
            <input type="radio" name="containerColor" value="pastel-lemon" style="display: none;">
            <span style="display: block; width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, rgba(255, 250, 205, 0.8), rgba(218, 165, 32, 0.5)); border: 2px solid transparent;" title="Zitrone"></span>
          </label>
          <label class="color-option" style="cursor: pointer;">
            <input type="radio" name="containerColor" value="pastel-rose" style="display: none;">
            <span style="display: block; width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, rgba(255, 182, 193, 0.7), rgba(219, 112, 147, 0.5)); border: 2px solid transparent;" title="Rose"></span>
          </label>
          <label class="color-option" style="cursor: pointer;">
            <input type="radio" name="containerColor" value="pastel-sky" style="display: none;">
            <span style="display: block; width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, rgba(135, 206, 235, 0.7), rgba(70, 130, 180, 0.5)); border: 2px solid transparent;" title="Himmel"></span>
          </label>
          <label class="color-option" style="cursor: pointer;">
            <input type="radio" name="containerColor" value="pastel-sage" style="display: none;">
            <span style="display: block; width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, rgba(188, 212, 188, 0.7), rgba(107, 142, 85, 0.5)); border: 2px solid transparent;" title="Salbei"></span>
          </label>
        </div>

        <label>Beschreibung</label>
        <textarea id="containerModalDesc" placeholder="Was gruppiert dieser Container?"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteContainer()">Löschen</button>
        <button class="btn btn-secondary" onclick="closeContainerModal()">Abbrechen</button>
        <button class="btn btn-primary" onclick="saveContainerModal()">Speichern</button>
      </div>
    </div>
  </div>
  
  <!-- Category Modal -->
  <div class="modal-overlay" id="categoryModal">
    <div class="modal">
      <div class="modal-header">
        <span>
          <svg class="icon-svg" viewBox="0 0 24 24" style="margin-right: 6px;"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          Kategorie bearbeiten
        </span>
        <button class="modal-close" onclick="closeCategoryModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="categoryModalId">
        
        <label>Name</label>
        <input type="text" id="categoryModalName" placeholder="Kategorie-Name">
        
        <label>Farbe</label>
        <select id="categoryModalColor">
          <option value="#1A1A1A">⚫ Schwarz</option>
          <option value="#333333">◼️ Anthrazit</option>
          <option value="#4C4C4C">🔘 Dunkelgrau</option>
          <option value="#666666">⬛ Mittelgrau</option>
          <option value="#999999">◻️ Grau</option>
          <option value="#B3B3B3">⬜ Hellgrau</option>
          <option value="#EB0D3F">🔴 Signal (Warnung)</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteCategory()">Löschen</button>
        <button class="btn btn-secondary" onclick="closeCategoryModal()">Abbrechen</button>
        <button class="btn btn-primary" onclick="saveCategoryModal()">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Phase Modal -->
  <div class="modal-overlay" id="phaseModal">
    <div class="modal">
      <div class="modal-header">
        <span>
          <svg class="icon-svg" viewBox="0 0 24 24" style="margin-right: 6px;"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
          Phase bearbeiten
        </span>
        <button class="modal-close" onclick="closePhaseModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="phaseModalId">

        <label>Phase-Name</label>
        <input type="text" id="phaseModalName" placeholder="z.B. ENTWICKLUNG">

        <label>Icon</label>
        <select id="phaseModalIcon">
          <option value="wrench">🔧 Wrench (Entwicklung)</option>
          <option value="factory">🏭 Factory (Produktion)</option>
          <option value="shopping-cart">🛒 Shopping Cart (Verkauf)</option>
          <option value="car">🚗 Car (Nutzung)</option>
          <option value="settings">⚙️ Settings (Aftersales)</option>
        </select>

        <p style="font-size: 12px; color: var(--slate-500); margin-top: 8px;">
          Tipp: Doppelklick auf die Phase-Überschrift unten zum Bearbeiten
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deletePhase()" id="phaseDeleteBtn" style="margin-right: auto;">Löschen</button>
        <button class="btn btn-secondary" onclick="closePhaseModal()">Abbrechen</button>
        <button class="btn btn-primary" onclick="savePhaseModal()">Speichern</button>
      </div>
    </div>
  </div>

  <!-- New Block in Category Modal -->
  <div class="modal-overlay" id="newBlockModal">
    <div class="modal">
      <div class="modal-header">
        <span>+ Neuen Block anlegen</span>
        <button class="modal-close" onclick="closeNewBlockModal()">&times;</button>
      </div>
      <div class="modal-body">
        <label>Name</label>
        <input type="text" id="newBlockName" placeholder="Block-Name">

        <label>Kategorie</label>
        <select id="newBlockCategory"></select>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNewBlockModal()">Abbrechen</button>
        <button class="btn btn-primary" onclick="saveNewBlock()">Anlegen</button>
      </div>
    </div>
  </div>

  <!-- Component Library Modal -->
  <div class="modal-overlay" id="componentLibraryModal">
    <div class="modal" style="max-width: 1200px; width: 95%; max-height: 90vh;">
      <div class="modal-header">
        <span style="display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
          </svg>
          Automotive Komponenten-Bibliothek
        </span>
        <button class="modal-close" onclick="closeComponentLibrary()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 0; display: flex; flex-direction: column; max-height: calc(90vh - 140px);">
        <!-- Search & Filter Bar -->
        <div style="padding: 16px 20px; border-bottom: 1px solid #e5e5e5; background: #fafafa; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <input type="text" id="librarySearchInput" placeholder="Komponenten suchen..."
                   oninput="filterComponentLibrary()"
                   style="width: 100%; padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
          </div>
          <select id="libraryCategoryFilter" onchange="filterComponentLibrary()"
                  style="padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; min-width: 180px;">
            <option value="all">Alle Kategorien</option>
          </select>
          <div style="display: flex; gap: 8px; margin-left: auto;">
            <button class="btn btn-secondary" onclick="selectAllComponents()" style="padding: 8px 14px; font-size: 13px;">
              Alle auswählen
            </button>
            <button class="btn btn-secondary" onclick="deselectAllComponents()" style="padding: 8px 14px; font-size: 13px;">
              Keine auswählen
            </button>
          </div>
        </div>

        <!-- Stats Bar -->
        <div id="libraryStatsBar" style="padding: 10px 20px; background: #f5f5f5; border-bottom: 1px solid #e5e5e5; font-size: 13px; color: #666; display: flex; gap: 20px;">
          <span id="libStatTotal">0 Komponenten</span>
          <span id="libStatSelected" style="color: #1565C0; font-weight: 500;">0 ausgewählt</span>
        </div>

        <!-- Component Grid -->
        <div id="componentLibraryGrid" style="flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; align-content: start;">
          <!-- Components will be rendered here -->
        </div>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
        <div style="font-size: 13px; color: #666;">
          <span id="importTargetInfo">Ziel-Kategorie wählen:</span>
          <select id="importTargetCategory" style="margin-left: 8px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px;">
          </select>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-secondary" onclick="closeComponentLibrary()">Abbrechen</button>
          <button class="btn btn-primary" onclick="importSelectedComponents()" id="importComponentsBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right: 6px;">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Importieren (0)
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============== DEFAULT STATE (Example Configuration) ==============
    const DEFAULT_STATE = {
      categories: [
        { id: 1, name: 'VEHICLE', color: '#1565C0', icon: 'car' },
        { id: 2, name: 'VEHICLE BACKEND', color: '#7B1FA2', icon: 'globe' },
        { id: 3, name: 'DATA PROCESSING', color: '#00695C', icon: 'database' },
        { id: 4, name: 'ANALYTICS', color: '#C62828', icon: 'brain' },
        { id: 5, name: 'SERVICES', color: '#E65100', icon: 'cloud' },
        { id: 6, name: 'FRONTEND', color: '#1976D2', icon: 'smartphone' },
        { id: 7, name: 'CUSTOMER', color: '#00838F', icon: 'users' },
        { id: 8, name: 'AFTERSALES', color: '#37474F', icon: 'wrench' }
      ],
      blocks: [],
      containers: [],
      phases: [
        { id: 1, name: 'ENTWICKLUNG', icon: 'wrench' },
        { id: 2, name: 'PRODUKTION', icon: 'factory' },
        { id: 3, name: 'VERKAUF', icon: 'shopping-cart' },
        { id: 4, name: 'NUTZUNG', icon: 'car' },
        { id: 5, name: 'AFTERSALES', icon: 'settings' }
      ],
      useCases: [],
      currentUseCase: null,
      canvasElements: [],
      connections: [],
      nextId: 1
    };

    // ============== STATE MANAGEMENT ==============
    function loadState() {
      try {
        const saved = localStorage.getItem('automotiveBuilderState');
        if (saved) {
          const parsed = JSON.parse(saved);
          if (parsed.categories && parsed.blocks) {
            return parsed;
          }
        }
      } catch (e) {
        console.warn('Could not load state from localStorage:', e);
      }
      return JSON.parse(JSON.stringify(DEFAULT_STATE));
    }

    function saveState() {
      try {
        localStorage.setItem('automotiveBuilderState', JSON.stringify(state));
      } catch (e) {
        console.warn('Could not save state to localStorage:', e);
      }
    }

    let saveTimeout = null;
    function scheduleSave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveState, 500);
    }

    // Reset to default state
    function resetToDefault() {
      if (confirm('Alle Daten zurücksetzen? Dies kann nicht rückgängig gemacht werden.')) {
        localStorage.removeItem('automotiveBuilderState');
        location.reload();
      }
    }

    // Export project to JSON file (saves to Downloads/data folder)
    function exportProject() {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const timestamp = new Date().toISOString().slice(0, 10);
      const projectName = state.currentUseCase?.name || 'projekt';
      const filename = `${projectName.replace(/[^a-zA-Z0-9äöüÄÖÜß]/g, '_')}_${timestamp}.json`;
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Export as shareable single HTML file (for email)
    async function exportAsShareable() {
      showToast('Erstelle teilbare Datei...', 'info', 2000);

      try {
        // Get the current HTML
        const currentHTML = document.documentElement.outerHTML;

        // Create a standalone version with embedded state
        const stateJSON = JSON.stringify(state);

        // Create the shareable HTML with embedded state
        const shareableHTML = `<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Automotive Architecture Builder - Shared View</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"><\/script>
  <script>
    // Embedded project state
    window.EMBEDDED_STATE = ${stateJSON};
  <\/script>
  ${document.querySelector('style') ? '<style>' + document.querySelector('style').textContent + '</style>' : ''}
</head>
<body>
  <div style="padding: 20px; font-family: Inter, sans-serif; max-width: 1400px; margin: 0 auto;">
    <div style="background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); padding: 24px; border-radius: 12px; margin-bottom: 24px;">
      <h1 style="margin: 0 0 8px 0; color: #333;">Automotive Architecture Builder</h1>
      <p style="margin: 0; color: #666;">Projekt exportiert am ${new Date().toLocaleDateString('de-DE')} um ${new Date().toLocaleTimeString('de-DE')}</p>
    </div>

    <div id="projectContent"></div>

    <div style="margin-top: 40px; padding: 20px; background: #f5f5f5; border-radius: 8px; text-align: center;">
      <p style="margin: 0 0 12px 0; color: #666;">Diese Datei wurde mit dem Automotive Architecture Builder erstellt.</p>
      <p style="margin: 0; font-size: 12px; color: #999;">Um das Projekt zu bearbeiten, öffne die Original-Anwendung und importiere die JSON-Daten.</p>
      <button onclick="downloadProjectJSON()" style="margin-top: 16px; padding: 10px 20px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
        Projekt-Daten als JSON herunterladen
      </button>
    </div>
  </div>

  <script>
    function downloadProjectJSON() {
      const dataStr = JSON.stringify(window.EMBEDDED_STATE, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'projekt_daten.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Render project overview
    function renderProjectOverview() {
      const state = window.EMBEDDED_STATE;
      const container = document.getElementById('projectContent');

      let html = '';

      // Phases and Use Cases
      if (state.phases && state.phases.length > 0) {
        html += '<h2 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 8px;">Phasen & Use Cases</h2>';

        state.phases.forEach(phase => {
          const phaseUseCases = (state.useCases || []).filter(uc => uc.phaseId === phase.id);

          html += '<div style="margin: 20px 0; padding: 16px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
          html += '<h3 style="margin: 0 0 12px 0; color: ' + (phase.color || '#666') + ';">' + phase.name + '</h3>';

          if (phaseUseCases.length > 0) {
            phaseUseCases.forEach(uc => {
              const priorityColors = {'prio-1': '#C62828', 'prio-2': '#E65100', 'prio-3': '#1565C0'};
              const statusLabels = {'draft': 'Entwurf', 'active': 'Aktiv', 'done': 'Fertig'};

              html += '<div style="padding: 12px; margin: 8px 0; background: #fafafa; border-radius: 6px; border-left: 4px solid ' + (priorityColors[uc.priority] || '#999') + ';">';
              html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
              html += '<strong style="color: #333;">' + (uc.name || 'Unbenannt') + '</strong>';
              html += '<span style="font-size: 12px; padding: 2px 8px; background: #e0e0e0; border-radius: 4px;">' + (statusLabels[uc.status] || uc.status) + '</span>';
              html += '</div>';
              if (uc.description) {
                html += '<p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">' + uc.description + '</p>';
              }
              if (uc.elements && uc.elements.length > 0) {
                html += '<p style="margin: 8px 0 0 0; font-size: 12px; color: #999;">' + uc.elements.length + ' Elemente, ' + (uc.connections?.length || 0) + ' Verbindungen</p>';
              }
              html += '</div>';
            });
          } else {
            html += '<p style="color: #999; font-style: italic;">Keine Use Cases</p>';
          }

          html += '</div>';
        });
      }

      // Block Catalog Summary
      if (state.categories && state.categories.length > 0) {
        html += '<h2 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 8px; margin-top: 40px;">Block-Katalog</h2>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">';

        state.categories.forEach(cat => {
          const catBlocks = (state.blocks || []).filter(b => b.categoryId === cat.id);
          html += '<div style="padding: 16px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 4px solid ' + (cat.color || '#666') + ';">';
          html += '<h4 style="margin: 0 0 8px 0; color: ' + (cat.color || '#333') + ';">' + cat.name + '</h4>';
          html += '<p style="margin: 0; font-size: 14px; color: #666;">' + catBlocks.length + ' Blöcke</p>';
          if (catBlocks.length > 0) {
            html += '<ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px; color: #666;">';
            catBlocks.slice(0, 5).forEach(b => {
              html += '<li>' + b.name + '</li>';
            });
            if (catBlocks.length > 5) {
              html += '<li style="color: #999;">... und ' + (catBlocks.length - 5) + ' weitere</li>';
            }
            html += '</ul>';
          }
          html += '</div>';
        });

        html += '</div>';
      }

      container.innerHTML = html;
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', renderProjectOverview);
  <\/script>
</body>
</html>`;

        // Download the shareable HTML
        const blob = new Blob([shareableHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = `Automotive_Architecture_${timestamp}.html`;
        a.click();
        URL.revokeObjectURL(url);

        showToast('Datei erstellt! Du kannst sie jetzt per Email versenden.', 'success', 4000);

      } catch (error) {
        console.error('Export error:', error);
        showToast('Fehler beim Export: ' + error.message, 'error');
      }
    }

    // Import project from JSON file
    function importProject() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (imported.categories && imported.blocks) {
              if (confirm('Aktuelle Daten werden überschrieben. Fortfahren?')) {
                state = imported;
                saveState();
                location.reload();
              }
            } else {
              alert('Ungültiges Projektformat.');
            }
          } catch (err) {
            alert('Fehler beim Laden der Datei: ' + err.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // Import Use Cases (ohne bestehende Daten zu loeschen)
    function importUseCases() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);

            // Pruefe ob es ein Use Case Export ist
            if (imported.exportType !== 'usecases' || !imported.useCases) {
              alert('Ungueltiges Use Case Format. Bitte eine Use Case JSON-Datei auswaehlen.');
              return;
            }

            const result = processUseCaseImport(imported);

            if (result.success) {
              saveState();
              renderCategories();
              renderUseCases();

              let message = result.importedUseCases + ' Use Case(s) importiert.';
              if (result.importedBlocks > 0) {
                message += '\n' + result.importedBlocks + ' neue Bloecke erstellt.';
              }
              if (result.skippedUseCases > 0) {
                message += '\n' + result.skippedUseCases + ' Use Case(s) uebersprungen (bereits vorhanden).';
              }
              alert(message);

              // Ersten importierten Use Case auswaehlen
              if (result.firstImportedId) {
                selectUseCase(result.firstImportedId);
              }
            } else {
              alert('Fehler beim Import: ' + result.error);
            }
          } catch (err) {
            alert('Fehler beim Laden der Datei: ' + err.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function processUseCaseImport(imported) {
      const result = {
        success: true,
        importedUseCases: 0,
        importedBlocks: 0,
        skippedUseCases: 0,
        firstImportedId: null,
        error: null
      };

      try {
        // 1. Neue Bloecke erstellen falls noetig
        if (imported.newBlocks && imported.newBlocks.length > 0) {
          imported.newBlocks.forEach(newBlock => {
            // Pruefe ob Block bereits existiert
            const exists = state.blocks.find(b => b.name.toLowerCase() === newBlock.name.toLowerCase());
            if (!exists) {
              // Finde Kategorie
              let categoryId = state.categories[0].id;
              if (newBlock.category) {
                const cat = state.categories.find(c => c.name === newBlock.category);
                if (cat) categoryId = cat.id;
              }

              const block = {
                id: state.nextId++,
                categoryId: categoryId,
                name: newBlock.name,
                icon: newBlock.icon || 'box',
                description: newBlock.description || '',
                notes: '',
                owner: '',
                status: 'offen',
                requirements: (newBlock.requirements || []).map(req => ({
                  id: state.nextId++,
                  text: req,
                  completed: false
                }))
              };
              state.blocks.push(block);
              result.importedBlocks++;
            }
          });
        }

        // 2. Use Cases importieren
        imported.useCases.forEach(ucData => {
          // Pruefe ob Use Case mit gleichem Namen bereits existiert
          const existingUC = state.useCases.find(uc => uc.name.toLowerCase() === ucData.name.toLowerCase());
          if (existingUC) {
            result.skippedUseCases++;
            return;
          }

          // Block-Namen zu IDs mappen
          const blockNameToId = new Map();
          state.blocks.forEach(b => {
            blockNameToId.set(b.name.toLowerCase(), b.id);
          });

          // Neue Use Case ID
          const newUcId = state.nextId++;

          // Elements verarbeiten
          const newElements = [];
          const elementIdMap = new Map(); // Original Index -> neue Element ID

          if (ucData.elements && ucData.elements.length > 0) {
            ucData.elements.forEach((el, index) => {
              const newElId = state.nextId++;
              elementIdMap.set(index, newElId);

              if (el.type === 'container') {
                newElements.push({
                  id: newElId,
                  type: 'container',
                  name: el.name || 'Container',
                  description: el.description || '',
                  x: el.x || 100,
                  y: el.y || 100,
                  width: el.width || 300,
                  height: el.height || 200,
                  colorClass: el.colorClass || 'pastel-blue'
                });
              } else if (el.type === 'block') {
                // Block ID finden
                let blockId = el.blockId;
                if (!blockId && el.blockName) {
                  blockId = blockNameToId.get(el.blockName.toLowerCase());
                }

                if (blockId) {
                  newElements.push({
                    id: newElId,
                    type: 'block',
                    blockId: blockId,
                    x: el.x || 100,
                    y: el.y || 100
                  });
                } else {
                  console.warn('Block nicht gefunden:', el.blockName);
                }
              }
            });
          }

          // Connections verarbeiten
          const newConnections = [];
          if (ucData.connections && ucData.connections.length > 0) {
            ucData.connections.forEach(conn => {
              const fromId = elementIdMap.get(conn.fromIndex);
              const toId = elementIdMap.get(conn.toIndex);

              if (fromId && toId) {
                newConnections.push({
                  id: state.nextId++,
                  from: fromId,
                  fromAnchor: conn.fromAnchor || 'right',
                  to: toId,
                  toAnchor: conn.toAnchor || 'left'
                });
              }
            });
          }

          // Neuen Use Case erstellen
          const newUseCase = {
            id: newUcId,
            name: ucData.name,
            phaseId: ucData.phaseId || 4,
            description: ucData.description || '',
            businessValue: ucData.businessValue || '',
            owner: ucData.owner || '',
            priority: ucData.priority || 'prio-2',
            status: ucData.status || 'draft',
            elements: newElements,
            connections: newConnections
          };

          state.useCases.push(newUseCase);
          result.importedUseCases++;

          if (!result.firstImportedId) {
            result.firstImportedId = newUcId;
          }
        });

      } catch (err) {
        result.success = false;
        result.error = err.message;
      }

      return result;
    }

    // Export Use Cases (nur Use Cases, nicht gesamtes Projekt)
    function exportUseCases() {
      if (state.useCases.length === 0) {
        alert('Keine Use Cases zum Exportieren vorhanden.');
        return;
      }

      // Block IDs zu Namen mappen fuer bessere Lesbarkeit
      const blockIdToName = new Map();
      state.blocks.forEach(b => {
        blockIdToName.set(b.id, b.name);
      });

      const exportData = {
        exportType: 'usecases',
        exportDate: new Date().toISOString().slice(0, 10),
        useCases: state.useCases.map(uc => {
          // Elements mit Block-Namen statt IDs
          const elements = (uc.elements || []).map((el, index) => {
            if (el.type === 'container') {
              return {
                type: 'container',
                name: el.name,
                description: el.description,
                x: el.x,
                y: el.y,
                width: el.width,
                height: el.height,
                colorClass: el.colorClass
              };
            } else {
              return {
                type: 'block',
                blockName: blockIdToName.get(el.blockId) || 'Unknown',
                blockId: el.blockId,
                x: el.x,
                y: el.y
              };
            }
          });

          // Connections mit Index-Referenzen
          const elementIdToIndex = new Map();
          (uc.elements || []).forEach((el, index) => {
            elementIdToIndex.set(el.id, index);
          });

          const connections = (uc.connections || []).map(conn => ({
            fromIndex: elementIdToIndex.get(conn.from),
            fromAnchor: conn.fromAnchor,
            toIndex: elementIdToIndex.get(conn.to),
            toAnchor: conn.toAnchor
          }));

          return {
            name: uc.name,
            phaseId: uc.phaseId,
            description: uc.description,
            businessValue: uc.businessValue,
            owner: uc.owner,
            priority: uc.priority,
            status: uc.status,
            elements: elements,
            connections: connections
          };
        }),
        newBlocks: []
      };

      const dataStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const timestamp = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = 'usecases_export_' + timestamp + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // ============== STATE ==============
    let state = loadState();

    let selectedElements = new Set(); // Multi-Selection Set
    let isDragging = false;
    let dragOffsets = new Map(); // Offsets für jedes selektierte Element
    let connectionStart = null;

    // ============== MARQUEE SELECTION ==============
    let isMarqueeSelecting = false;
    let marqueeStart = { x: 0, y: 0 };
    let marqueeBox = null;

    // ============== CLIPBOARD (Copy/Paste) ==============
    let clipboard = {
      elements: [],
      connections: []
    };

    // ============== SELECTION COUNTER ==============
    function updateSelectionCounter() {
      const counter = document.getElementById('selectionCounter');
      const countEl = document.getElementById('selectionCount');
      if (counter && countEl) {
        const count = selectedElements.size;
        if (count > 1) {
          countEl.textContent = count;
          counter.classList.add('visible');
        } else {
          counter.classList.remove('visible');
        }
      }
    }

    function startMarqueeSelection(e) {
      const canvas = document.getElementById('canvas');
      const canvasRect = canvas.getBoundingClientRect();

      isMarqueeSelecting = true;
      marqueeStart = {
        x: (e.clientX - canvasRect.left) / canvasZoom,
        y: (e.clientY - canvasRect.top) / canvasZoom
      };

      // Auswahl-Box erstellen
      marqueeBox = document.createElement('div');
      marqueeBox.className = 'selection-box';
      marqueeBox.style.left = marqueeStart.x + 'px';
      marqueeBox.style.top = marqueeStart.y + 'px';
      marqueeBox.style.width = '0px';
      marqueeBox.style.height = '0px';
      canvas.appendChild(marqueeBox);
    }

    function updateMarqueeSelection(e) {
      if (!isMarqueeSelecting || !marqueeBox) return;

      const canvas = document.getElementById('canvas');
      const canvasRect = canvas.getBoundingClientRect();

      const currentX = (e.clientX - canvasRect.left) / canvasZoom;
      const currentY = (e.clientY - canvasRect.top) / canvasZoom;

      const left = Math.min(marqueeStart.x, currentX);
      const top = Math.min(marqueeStart.y, currentY);
      const width = Math.abs(currentX - marqueeStart.x);
      const height = Math.abs(currentY - marqueeStart.y);

      marqueeBox.style.left = left + 'px';
      marqueeBox.style.top = top + 'px';
      marqueeBox.style.width = width + 'px';
      marqueeBox.style.height = height + 'px';

      // Live-Vorschau: Elemente im Rechteck hervorheben
      if (state.currentUseCase && state.currentUseCase.elements) {
        const selectionRect = { x: left, y: top, width, height };

        state.currentUseCase.elements.forEach(element => {
          const elRect = getElementRect(element);
          const el = document.getElementById(`element-${element.id}`);

          if (el && rectsOverlap(selectionRect, elRect)) {
            el.classList.add('selected');
          } else if (el && !selectedElements.has(element.id)) {
            el.classList.remove('selected');
          }
        });
      }
    }

    function endMarqueeSelection(e) {
      if (!isMarqueeSelecting || !marqueeBox) return;

      const canvas = document.getElementById('canvas');
      const canvasRect = canvas.getBoundingClientRect();

      const currentX = (e.clientX - canvasRect.left) / canvasZoom;
      const currentY = (e.clientY - canvasRect.top) / canvasZoom;

      const left = Math.min(marqueeStart.x, currentX);
      const top = Math.min(marqueeStart.y, currentY);
      const width = Math.abs(currentX - marqueeStart.x);
      const height = Math.abs(currentY - marqueeStart.y);

      const selectionRect = { x: left, y: top, width, height };

      // Nur selektieren wenn Rechteck groß genug ist (min 5px)
      if (width > 5 && height > 5 && state.currentUseCase && state.currentUseCase.elements) {
        // Wenn kein Ctrl/Cmd, vorherige Auswahl löschen
        if (!e.ctrlKey && !e.metaKey) {
          selectedElements.clear();
        }

        state.currentUseCase.elements.forEach(element => {
          const elRect = getElementRect(element);
          if (rectsOverlap(selectionRect, elRect)) {
            selectedElements.add(element.id);
          }
        });

        // Visuelle Selektion aktualisieren
        document.querySelectorAll('.canvas-block, .canvas-container').forEach(el => {
          const id = parseInt(el.id.replace('element-', ''));
          if (selectedElements.has(id)) {
            el.classList.add('selected');
          } else {
            el.classList.remove('selected');
          }
        });

        updateSelectionCounter();
      }

      // Auswahl-Box entfernen
      if (marqueeBox && marqueeBox.parentNode) {
        marqueeBox.parentNode.removeChild(marqueeBox);
      }
      marqueeBox = null;
      isMarqueeSelecting = false;
    }

    function getElementRect(element) {
      if (element.type === 'container') {
        return {
          x: element.x,
          y: element.y,
          width: element.width || 200,
          height: element.height || 150
        };
      } else {
        // Block-Größe (Standard)
        return {
          x: element.x,
          y: element.y,
          width: 140,
          height: 120
        };
      }
    }

    function rectsOverlap(rect1, rect2) {
      return !(rect1.x + rect1.width < rect2.x ||
               rect2.x + rect2.width < rect1.x ||
               rect1.y + rect1.height < rect2.y ||
               rect2.y + rect2.height < rect1.y);
    }

    // ============== CANVAS ZOOM ==============
    let canvasZoom = 1;
    let zoomDisplayTimeout = null;

    function setCanvasZoom(zoom) {
      const canvas = document.getElementById('canvas');
      canvasZoom = Math.max(0.25, Math.min(2, zoom));
      canvas.style.transform = `scale(${canvasZoom})`;
      canvas.style.transformOrigin = 'top left';

      // Zoom-Anzeige aktualisieren
      const display = document.getElementById('canvasZoomDisplay');
      if (display) {
        display.textContent = `${Math.round(canvasZoom * 100)}%`;
        display.classList.add('visible');

        // Nach 1.5s ausblenden
        clearTimeout(zoomDisplayTimeout);
        zoomDisplayTimeout = setTimeout(() => {
          display.classList.remove('visible');
        }, 1500);
      }
    }

    function zoomIn() {
      setCanvasZoom(canvasZoom + 0.1);
    }

    function zoomOut() {
      setCanvasZoom(canvasZoom - 0.1);
    }

    function fitToContent() {
      if (!state.currentUseCase || !state.currentUseCase.elements || state.currentUseCase.elements.length === 0) {
        setCanvasZoom(1);
        const canvasArea = document.querySelector('.canvas-area');
        if (canvasArea) {
          canvasArea.scrollTop = 0;
          canvasArea.scrollLeft = 0;
        }
        return;
      }

      // Berechne die Bounding Box aller Elemente
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

      state.currentUseCase.elements.forEach(element => {
        if (element.type === 'block') {
          minX = Math.min(minX, element.x);
          minY = Math.min(minY, element.y);
          maxX = Math.max(maxX, element.x + 120); // Block width
          maxY = Math.max(maxY, element.y + 60); // Block height
        } else if (element.type === 'container') {
          minX = Math.min(minX, element.x);
          minY = Math.min(minY, element.y);
          maxX = Math.max(maxX, element.x + element.width);
          maxY = Math.max(maxY, element.y + element.height);
        }
      });

      // Fallback falls keine Elemente gefunden
      if (minX === Infinity) {
        setCanvasZoom(1);
        return;
      }

      // Füge Padding hinzu
      const padding = 50;
      minX -= padding;
      minY -= padding;
      maxX += padding;
      maxY += padding;

      const contentWidth = maxX - minX;
      const contentHeight = maxY - minY;

      const canvasArea = document.querySelector('.canvas-area');
      if (!canvasArea) return;

      const viewWidth = canvasArea.clientWidth;
      let viewHeight = canvasArea.clientHeight;

      // Berücksichtige die Höhe der Use Case Library (Phasen unten)
      const library = document.querySelector('.usecase-library');
      if (library) {
        const libraryHeight = library.offsetHeight;
        // Zusätzlicher Puffer damit Content nicht von Library überdeckt wird
        viewHeight -= libraryHeight + 20;
      }

      // Berechne den optimalen Zoom
      const zoomX = viewWidth / contentWidth;
      const zoomY = viewHeight / contentHeight;
      const optimalZoom = Math.min(zoomX, zoomY, 1); // Max 100%

      setCanvasZoom(optimalZoom);

      // Zentriere den Content
      setTimeout(() => {
        canvasArea.scrollLeft = minX * optimalZoom - (viewWidth - contentWidth * optimalZoom) / 2;
        canvasArea.scrollTop = minY * optimalZoom - (viewHeight - contentHeight * optimalZoom) / 2;
      }, 50);
    }

    // Zoom mit Mausrad
    (function initCanvasZoom() {
      const canvasArea = document.querySelector('.canvas-area');
      if (!canvasArea) return;

      canvasArea.addEventListener('wheel', (e) => {
        // Nur zoomen wenn Ctrl/Cmd gedrückt oder im Canvas-Bereich
        if (e.ctrlKey || e.metaKey || e.target.closest('.canvas')) {
          e.preventDefault();
          const delta = e.deltaY > 0 ? -0.1 : 0.1;
          setCanvasZoom(canvasZoom + delta);
        }
      }, { passive: false });
    })();

    // ============== CANVAS PAN (Middle Mouse Button) ==============
    let isPanning = false;
    let panStart = { x: 0, y: 0 };
    let scrollStart = { x: 0, y: 0 };

    document.addEventListener('mousedown', (e) => {
      // Mittlere Maustaste (Scrollrad-Klick)
      if (e.button === 1) {
        const canvasArea = e.target.closest('.canvas-area');
        if (canvasArea) {
          e.preventDefault();
          e.stopPropagation();
          isPanning = true;
          panStart = { x: e.clientX, y: e.clientY };
          scrollStart = { x: canvasArea.scrollLeft, y: canvasArea.scrollTop };
          document.body.style.cursor = 'grabbing';
        }
      }
    });

    document.addEventListener('mousemove', (e) => {
      if (!isPanning) return;
      e.preventDefault();
      const canvasArea = document.querySelector('.canvas-area');
      if (!canvasArea) return;
      const dx = e.clientX - panStart.x;
      const dy = e.clientY - panStart.y;
      canvasArea.scrollLeft = scrollStart.x - dx;
      canvasArea.scrollTop = scrollStart.y - dy;
    });

    document.addEventListener('mouseup', (e) => {
      if (isPanning) {
        isPanning = false;
        document.body.style.cursor = '';
      }
    });

    // Prevent default middle-click scroll icon
    window.addEventListener('mousedown', (e) => {
      if (e.button === 1) e.preventDefault();
    });

    // ============== LOAD COMPONENTS FROM LIBRARY ==============
    function loadComponentsFromLibrary() {
      // Only load if blocks are empty (fresh start)
      if (state.blocks.length === 0 && typeof AUTOMOTIVE_COMPONENTS !== 'undefined') {
        const categoryMapping = {
          'vehicle': 1,
          'vehicleBackend': 2,
          'dataProcessing': 3,
          'analytics': 4,
          'services': 5,
          'frontend': 6,
          'customer': 7,
          'aftersales': 8
        };

        let blockId = 1;
        for (const [catKey, category] of Object.entries(AUTOMOTIVE_COMPONENTS)) {
          const categoryId = categoryMapping[catKey];
          if (!categoryId) continue;

          for (const comp of category.components) {
            state.blocks.push({
              id: blockId++,
              categoryId: categoryId,
              name: comp.name,
              icon: comp.icon || 'cpu',
              description: comp.description || '',
              notes: '',
              owner: '',
              status: 'offen',
              requirements: comp.requirements || []
            });
          }
        }
        state.nextId = blockId;
        saveState();
        console.log(`📦 Loaded ${state.blocks.length} components from library`);
      }
    }

    // ============== INIT ==============
    function init() {
      loadComponentsFromLibrary();
      renderCategories();
      renderPhases();

      // Restore previously selected Use Case if available
      if (state.currentUseCase) {
        // Restore previously selected Use Case
        const ucId = state.currentUseCase.id;
        selectUseCase(ucId);
      }

      renderCanvas();
    }
    
    // ============== CATEGORIES ==============
    let draggedCategory = null;
    let draggedSortBlock = null;
    let dragSourceCategoryId = null;

    function renderCategories() {
      // Auto-save state
      scheduleSave();

      const container = document.getElementById('categoriesContainer');
      container.innerHTML = '';

      state.categories.forEach((cat, catIndex) => {
        const catBlocks = state.blocks.filter(b => b.categoryId === cat.id);
        const catIcon = cat.icon || 'folder';

        const div = document.createElement('div');
        div.className = 'category';
        div.draggable = true;
        div.dataset.categoryId = cat.id;
        div.dataset.categoryIndex = catIndex;

        // Category drag events
        div.addEventListener('dragstart', (e) => handleCategoryDragStart(e, cat.id, catIndex));
        div.addEventListener('dragend', handleCategoryDragEnd);
        div.addEventListener('dragover', handleCategoryDragOver);
        div.addEventListener('dragleave', handleCategoryDragLeave);
        div.addEventListener('drop', (e) => handleCategoryDrop(e, catIndex));

        div.innerHTML = `
          <div class="category-header" onclick="toggleCategory(this)" ondblclick="editCategory(${cat.id})" style="background: linear-gradient(135deg, ${cat.color}12 0%, rgba(255,255,255,0.6) 100%); border-left: 2px solid ${cat.color};">
            <span style="display:flex;align-items:center;gap:8px;">
              <span class="drag-handle" title="Kategorie verschieben">${getSvgIcon('grip-vertical', 14)}</span>
              <span style="display: inline-flex; align-items: center; color: ${cat.color}; opacity: 0.9;">${getSvgIcon(catIcon, 16)}</span>
              <span style="color: #333; font-weight: 600;">${cat.name}</span>
              <span style="color: ${cat.color}; font-size: 10px; opacity: 0.7;">(${catBlocks.length})</span>
            </span>
            <span class="toggle" style="color: ${cat.color}; opacity: 0.7;">▶</span>
          </div>
          <div class="category-items" data-category-id="${cat.id}" style="background: ${cat.color}06;">
            ${catBlocks.map((block, blockIndex) => `
              <div class="block-item"
                   draggable="true"
                   data-block-id="${block.id}"
                   data-block-index="${blockIndex}"
                   data-category-id="${cat.id}"
                   style="border-left-color: ${cat.color}; background: linear-gradient(135deg, ${cat.color}10 0%, rgba(255,255,255,0.9) 100%);"
                   ondblclick="editBlockFromCatalog(${block.id})">
                <span class="drag-handle" title="Block verschieben">${getSvgIcon('grip-vertical', 12)}</span>
                <span style="margin-right:6px; display: inline-flex; align-items: center; color: ${cat.color}; opacity: 0.85;">${getSvgIcon(block.icon || 'cpu', 14)}</span>${block.name}
              </div>
            `).join('')}
            <button class="add-block-btn" onclick="addBlockToCategory(${cat.id})">+ Block anlegen</button>
          </div>
        `;

        // Add block sorting events
        const categoryItems = div.querySelector('.category-items');
        categoryItems.addEventListener('dragover', (e) => handleBlockSortDragOver(e, cat.id));
        categoryItems.addEventListener('dragleave', handleBlockSortDragLeave);
        categoryItems.addEventListener('drop', (e) => handleBlockSortDrop(e, cat.id));

        // Add events to block items
        div.querySelectorAll('.block-item').forEach(blockEl => {
          const blockId = parseInt(blockEl.dataset.blockId);
          blockEl.addEventListener('dragstart', (e) => handleBlockSortDragStart(e, blockId, cat.id));
          blockEl.addEventListener('dragend', handleBlockSortDragEnd);
        });

        container.appendChild(div);
      });
    }

    // Category Drag & Drop handlers
    function handleCategoryDragStart(e, catId, catIndex) {
      // Only allow drag from handle
      if (!e.target.closest('.drag-handle') && e.target.closest('.category-header')) {
        e.preventDefault();
        return;
      }
      draggedCategory = { id: catId, index: catIndex };
      e.currentTarget.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', 'category-' + catId);
    }

    function handleCategoryDragEnd(e) {
      draggedCategory = null;
      document.querySelectorAll('.category').forEach(el => {
        el.classList.remove('dragging', 'drag-over');
      });
    }

    function handleCategoryDragOver(e) {
      if (!draggedCategory) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const category = e.currentTarget;
      if (!category.classList.contains('dragging')) {
        category.classList.add('drag-over');
      }
    }

    function handleCategoryDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function handleCategoryDrop(e, targetIndex) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');

      if (!draggedCategory || draggedCategory.index === targetIndex) return;

      // Reorder categories
      const [movedCategory] = state.categories.splice(draggedCategory.index, 1);
      state.categories.splice(targetIndex, 0, movedCategory);

      draggedCategory = null;
      renderCategories();
    }

    // Block Sorting Drag & Drop handlers (separate from canvas drag)
    function handleBlockSortDragStart(e, blockId, categoryId) {
      // Check if we should use sort mode or canvas mode
      const handle = e.target.closest('.drag-handle');
      if (handle) {
        // Sort mode - reordering blocks
        e.stopPropagation();
        draggedSortBlock = { id: blockId, categoryId: categoryId };
        dragSourceCategoryId = categoryId;
        e.currentTarget.classList.add('dragging-sort');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', 'sort-block-' + blockId);
      } else {
        // Canvas mode - dragging to canvas
        handleBlockDragStart(e, blockId);
      }
    }

    function handleBlockSortDragEnd(e) {
      draggedSortBlock = null;
      dragSourceCategoryId = null;
      document.querySelectorAll('.block-item').forEach(el => {
        el.classList.remove('dragging-sort', 'drag-over-sort', 'drag-over-sort-bottom');
      });
      document.querySelectorAll('.category-items').forEach(el => {
        el.classList.remove('drag-over-category');
      });
    }

    function handleBlockSortDragOver(e, targetCategoryId) {
      if (!draggedSortBlock) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';

      const categoryItems = e.currentTarget;
      const blockItem = e.target.closest('.block-item');

      // Clear previous indicators
      categoryItems.querySelectorAll('.block-item').forEach(el => {
        el.classList.remove('drag-over-sort', 'drag-over-sort-bottom');
      });

      if (blockItem && blockItem.dataset.blockId != draggedSortBlock.id) {
        const rect = blockItem.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        if (e.clientY < midY) {
          blockItem.classList.add('drag-over-sort');
        } else {
          blockItem.classList.add('drag-over-sort-bottom');
        }
      } else if (!blockItem) {
        categoryItems.classList.add('drag-over-category');
      }
    }

    function handleBlockSortDragLeave(e) {
      const categoryItems = e.currentTarget;
      if (!categoryItems.contains(e.relatedTarget)) {
        categoryItems.classList.remove('drag-over-category');
        categoryItems.querySelectorAll('.block-item').forEach(el => {
          el.classList.remove('drag-over-sort', 'drag-over-sort-bottom');
        });
      }
    }

    function handleBlockSortDrop(e, targetCategoryId) {
      e.preventDefault();
      e.stopPropagation();

      if (!draggedSortBlock) return;

      const categoryItems = e.currentTarget;
      categoryItems.classList.remove('drag-over-category');

      const block = state.blocks.find(b => b.id === draggedSortBlock.id);
      if (!block) return;

      const targetBlockEl = e.target.closest('.block-item');

      // Get all blocks in target category (in current order)
      const targetCatBlocks = state.blocks.filter(b => b.categoryId === targetCategoryId);

      // Remove block from its current position
      const blockIndex = state.blocks.findIndex(b => b.id === draggedSortBlock.id);
      state.blocks.splice(blockIndex, 1);

      // Update category if moving between categories
      block.categoryId = targetCategoryId;

      if (targetBlockEl && targetBlockEl.dataset.blockId != draggedSortBlock.id) {
        // Insert relative to target block
        const targetBlockId = parseInt(targetBlockEl.dataset.blockId);
        const targetIndex = state.blocks.findIndex(b => b.id === targetBlockId);
        const rect = targetBlockEl.getBoundingClientRect();
        const insertAfter = e.clientY > (rect.top + rect.height / 2);

        state.blocks.splice(insertAfter ? targetIndex + 1 : targetIndex, 0, block);
      } else {
        // Add at end of category - find last block of this category
        let insertIndex = state.blocks.length;
        for (let i = state.blocks.length - 1; i >= 0; i--) {
          if (state.blocks[i].categoryId === targetCategoryId) {
            insertIndex = i + 1;
            break;
          }
        }
        state.blocks.splice(insertIndex, 0, block);
      }

      draggedSortBlock = null;
      dragSourceCategoryId = null;
      renderCategories();
    }
    
    function toggleCategory(header) {
      header.parentElement.classList.toggle('open');
    }
    
    function addNewCategory() {
      document.getElementById('categoryModalId').value = '';
      document.getElementById('categoryModalName').value = '';
      document.getElementById('categoryModalColor').value = '#333333';
      document.getElementById('categoryModal').classList.add('open');
    }
    
    function editCategory(id) {
      const cat = state.categories.find(c => c.id === id);
      if (!cat) return;
      
      document.getElementById('categoryModalId').value = id;
      document.getElementById('categoryModalName').value = cat.name;
      document.getElementById('categoryModalColor').value = cat.color;
      document.getElementById('categoryModal').classList.add('open');
    }
    
    function saveCategoryModal() {
      const id = document.getElementById('categoryModalId').value;
      const name = document.getElementById('categoryModalName').value.trim();
      const color = document.getElementById('categoryModalColor').value;
      
      if (!name) { alert('Bitte Name eingeben'); return; }
      
      if (id) {
        const cat = state.categories.find(c => c.id === parseInt(id));
        if (cat) {
          cat.name = name;
          cat.color = color;
        }
      } else {
        state.categories.push({
          id: state.nextId++,
          name: name,
          color: color
        });
      }
      
      closeCategoryModal();
      renderCategories();
    }
    
    function deleteCategory() {
      const id = parseInt(document.getElementById('categoryModalId').value);
      if (!id) return;
      
      if (!confirm('Kategorie und alle zugehörigen Blocks löschen?')) return;
      
      state.categories = state.categories.filter(c => c.id !== id);
      state.blocks = state.blocks.filter(b => b.categoryId !== id);
      
      closeCategoryModal();
      renderCategories();
    }
    
    function closeCategoryModal() {
      document.getElementById('categoryModal').classList.remove('open');
    }
    
    // ============== BLOCKS (Master Catalog) ==============

    // SVG Icon Definitionen für Block-Auswahl
    // Automotive Architecture Icons mit Kategorien
    const blockIcons = {
      // Fahrzeug & Transport
      'car': '<path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/>',
      'truck': '<path d="M1 3h15v13H1z"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>',
      'bus': '<path d="M4 6v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4z"/><path d="M4 10h16"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/>',
      'wheel': '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><line x1="12" y1="2" x2="12" y2="8"/><line x1="12" y1="16" x2="12" y2="22"/><line x1="2" y1="12" x2="8" y2="12"/><line x1="16" y1="12" x2="22" y2="12"/>',
      'racing': '<path d="M12 2L4 7v8l8 5 8-5V7l-8-5z"/><path d="M12 22V12"/><path d="M20 7l-8 5-8-5"/>',
      'van': '<rect x="1" y="3" width="15" height="13" rx="2" ry="2"/><path d="M16 8h4l3 3v2h-7z"/><circle cx="5" cy="18" r="2"/><circle cx="17" cy="18" r="2"/>',
      'delivery': '<rect x="1" y="3" width="15" height="13" rx="2"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>',
      'wrench': '<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>',

      // ECU / Steuergerät
      'cpu': '<rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/>',
      'chip': '<rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 1v3M15 1v3M9 20v3M15 20v3M20 9h3M20 15h3M1 9h3M1 15h3"/>',
      'plug': '<path d="M12 22v-5"/><path d="M9 7V2"/><path d="M15 7V2"/><path d="M6 13V8a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4z"/>',
      'zap': '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
      'battery': '<rect x="1" y="6" width="18" height="12" rx="2" ry="2"/><line x1="23" y1="13" x2="23" y2="11"/><line x1="22" y1="10" x2="22" y2="14"/>',
      'shield': '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>',
      'sliders': '<line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/>',
      'settings': '<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>',

      // Backend & Server
      'server': '<rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/>',
      'monitor': '<rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>',
      'database': '<ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>',
      'building': '<rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22V12h6v10"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M8 10h.01"/><path d="M16 10h.01"/>',
      'factory': '<path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/>',
      'radio': '<circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"/>',
      'globe': '<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>',
      'cloud': '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>',

      // Datenbank & Storage
      'hard-drive': '<line x1="22" y1="12" x2="2" y2="12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" y1="16" x2="6.01" y2="16"/><line x1="10" y1="16" x2="10.01" y2="16"/>',
      'archive': '<path d="M21 8v13H3V8"/><path d="M1 3h22v5H1z"/><path d="M10 12h4"/>',
      'folder': '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>',
      'folder-open': '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><path d="M2 10h20"/>',
      'disc': '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>',
      'save': '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>',
      'layers': '<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>',
      'bar-chart': '<line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/>',

      // Streaming & Messaging
      'mail': '<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>',
      'inbox': '<polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>',
      'upload': '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>',
      'download': '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>',
      'refresh': '<polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>',
      'arrow-left-right': '<path d="M8 3L4 7l4 4"/><path d="M4 7h16"/><path d="M16 21l4-4-4-4"/><path d="M20 17H4"/>',
      'shuffle': '<polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/>',
      'megaphone': '<path d="M3 11l18-5v12L3 13v-2z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/>',

      // AI & Analyse
      'bot': '<rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/>',
      'brain': '<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/>',
      'trending-up': '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>',
      'trending-down': '<polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/>',
      'search': '<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>',
      'target': '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>',
      'lightbulb': '<path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/>',
      'sparkles': '<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/>',

      // Frontend & Mobile
      'smartphone': '<rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/>',
      'tablet': '<rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/>',
      'image': '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>',
      'layout': '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/>',
      'mouse': '<path d="M12 2a4 4 0 0 0-4 4v6a4 4 0 0 0 8 0V6a4 4 0 0 0-4-4z"/><path d="M12 6v4"/><path d="M8 18h8"/><path d="M10 22h4"/>',
      'type': '<polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/>',
      'palette': '<circle cx="13.5" cy="6.5" r="0.5"/><circle cx="17.5" cy="10.5" r="0.5"/><circle cx="8.5" cy="7.5" r="0.5"/><circle cx="6.5" cy="12.5" r="0.5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"/>',
      'eye': '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>',

      // Netzwerk & Security
      'globe-alt': '<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>',
      'link': '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>',
      'wifi': '<path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/>',
      'rss': '<path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/>',
      'shield-check': '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/>',
      'key': '<path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>',
      'lock': '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
      'satellite': '<path d="M13 7L9 3L5 7l4 4"/><path d="M17 11l4 4-4 4-4-4"/><path d="m8 12 4 4 6-6-4-4-6 6z"/><path d="m16 8 3-3"/><path d="M9 21a6 6 0 0 0-6-6"/>',

      // Personen & Teams
      'users': '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
      'user': '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
      'user-check': '<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/>',

      // UI / Drag Handle
      'grip-vertical': '<circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/>'
    };

    // Icon-Namen Liste für einfache Iteration
    const blockIconNames = Object.keys(blockIcons);

    // Helper: SVG Icon generieren
    function getSvgIcon(iconName, size = 18) {
      const iconPath = blockIcons[iconName];
      if (!iconPath) return '';
      return `<svg class="icon-svg" viewBox="0 0 24 24" width="${size}" height="${size}" style="stroke: currentColor; stroke-width: 1.75; stroke-linecap: round; stroke-linejoin: round; fill: none;">${iconPath}</svg>`;
    }

    function renderIconPicker(selectedIcon) {
      const picker = document.getElementById('blockModalIconPicker');
      picker.innerHTML = blockIconNames.map(iconName => `
        <div class="icon-option ${iconName === selectedIcon ? 'selected' : ''}"
             onclick="selectBlockIcon('${iconName}')" data-icon="${iconName}" title="${iconName}">
          ${getSvgIcon(iconName, 20)}
        </div>
      `).join('');
    }

    function selectBlockIcon(iconName) {
      document.getElementById('blockModalIcon').value = iconName;
      document.getElementById('blockModalIconPreview').innerHTML = getSvgIcon(iconName, 28);

      // Update selection visual
      document.querySelectorAll('.icon-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.icon === iconName);
      });
    }

    function addBlockToCategory(categoryId) {
      // Öffne das vollständige Block-Modal für neuen Block
      openBlockModal(null, null, categoryId);
    }

    function editBlockFromCatalog(blockId) {
      openBlockModal(blockId, null);
    }

    // ============== BLOCK MODAL ==============
    function openBlockModal(blockId, canvasElementId, defaultCategoryId) {
      const isNewBlock = !blockId;
      const block = isNewBlock ? null : state.blocks.find(b => b.id === blockId);

      // Modal Titel anpassen
      document.getElementById('blockModalTitle').innerHTML = isNewBlock
        ? `${getSvgIcon('sparkles', 18)} Neuen Block anlegen`
        : `${getSvgIcon('cpu', 18)} Block bearbeiten`;

      // Löschen-Button nur bei existierenden Blocks anzeigen
      document.getElementById('blockModalDeleteBtn').style.display = isNewBlock ? 'none' : 'block';

      // Felder füllen
      document.getElementById('blockModalId').value = blockId || '';
      document.getElementById('blockModalName').value = block?.name || '';
      document.getElementById('blockModalDesc').value = block?.description || '';
      document.getElementById('blockModalNotes').value = block?.notes || '';
      document.getElementById('blockModalOwner').value = block?.owner || '';
      document.getElementById('blockModalStatus').value = block?.status || 'offen';

      // Icon (default to 'cpu' for new blocks)
      const currentIcon = block?.icon || 'cpu';
      document.getElementById('blockModalIcon').value = currentIcon;
      document.getElementById('blockModalIconPreview').innerHTML = getSvgIcon(currentIcon, 28);
      renderIconPicker(currentIcon);

      // Category dropdown
      const catSelect = document.getElementById('blockModalCategory');
      const selectedCatId = block?.categoryId || defaultCategoryId || state.categories[0]?.id;
      catSelect.innerHTML = state.categories.map(c =>
        `<option value="${c.id}" ${c.id === selectedCatId ? 'selected' : ''}>${c.name}</option>`
      ).join('');

      // Requirements
      renderRequirements(block?.requirements || []);

      // Used in (nur bei existierenden Blocks)
      if (isNewBlock) {
        document.getElementById('blockModalUsedIn').innerHTML = '<div style="color:#999">Neuer Block - noch nicht verwendet</div>';
      } else {
        const usedIn = findBlockUsage(blockId);
        document.getElementById('blockModalUsedIn').innerHTML = usedIn.length > 0
          ? usedIn.map(uc => `<div>• ${uc}</div>`).join('')
          : '<div style="color:#999">Noch nicht verwendet</div>';
      }

      document.getElementById('blockModal').classList.add('open');
    }
    
    function renderRequirements(reqs) {
      const container = document.getElementById('blockModalReqs');
      container.innerHTML = reqs.map((req, idx) => `
        <div class="requirement-item">
          <input type="checkbox" ${req.checked ? 'checked' : ''} data-idx="${idx}">
          <input type="text" value="${req.text || ''}" data-idx="${idx}" placeholder="Anforderung eingeben...">
          <button class="delete-req" onclick="deleteRequirement(this)">&times;</button>
        </div>
      `).join('');

      if (reqs.length === 0) {
        container.innerHTML = '<div style="color:#999;padding:10px;text-align:center;">Keine Anforderungen</div>';
      }
    }
    
    function addRequirement() {
      const container = document.getElementById('blockModalReqs');
      // Entferne "Keine Anforderungen" Platzhalter
      const placeholder = container.querySelector('div[style*="color:#999"]');
      if (placeholder) placeholder.remove();

      const idx = container.querySelectorAll('.requirement-item').length;
      const reqDiv = document.createElement('div');
      reqDiv.className = 'requirement-item';
      reqDiv.innerHTML = `
        <input type="checkbox" data-idx="${idx}">
        <input type="text" value="" data-idx="${idx}" placeholder="Anforderung eingeben...">
        <button class="delete-req" onclick="deleteRequirement(this)">&times;</button>
      `;
      container.appendChild(reqDiv);
      reqDiv.querySelector('input[type="text"]').focus();
    }

    function deleteRequirement(btn) {
      // Button-Element übergeben - entferne das Requirement-Item
      const reqItem = btn.closest('.requirement-item');
      if (reqItem) reqItem.remove();

      // Zeige Platzhalter wenn leer
      const container = document.getElementById('blockModalReqs');
      if (container.querySelectorAll('.requirement-item').length === 0) {
        container.innerHTML = '<div style="color:#999;padding:10px;text-align:center;">Keine Anforderungen</div>';
      }
    }
    
    function saveBlockModal() {
      const blockIdStr = document.getElementById('blockModalId').value;
      const isNewBlock = !blockIdStr;
      const name = document.getElementById('blockModalName').value.trim();

      if (!name) {
        alert('Bitte einen Namen eingeben');
        return;
      }

      // Sammle alle Daten
      const blockData = {
        categoryId: parseInt(document.getElementById('blockModalCategory').value),
        name: name,
        icon: document.getElementById('blockModalIcon').value || 'cpu',
        description: document.getElementById('blockModalDesc').value,
        notes: document.getElementById('blockModalNotes').value,
        owner: document.getElementById('blockModalOwner').value,
        status: document.getElementById('blockModalStatus').value,
        requirements: []
      };

      // Requirements sammeln
      const reqItems = document.querySelectorAll('#blockModalReqs .requirement-item');
      blockData.requirements = Array.from(reqItems).map(item => ({
        text: item.querySelector('input[type="text"]').value,
        checked: item.querySelector('input[type="checkbox"]').checked
      }));

      if (isNewBlock) {
        // Neuen Block erstellen
        state.blocks.push({
          id: state.nextId++,
          ...blockData
        });
      } else {
        // Existierenden Block aktualisieren
        const blockId = parseInt(blockIdStr);
        const block = state.blocks.find(b => b.id === blockId);
        if (block) {
          Object.assign(block, blockData);
        }
      }

      closeBlockModal();
      renderCategories();
      renderCanvas();
    }
    
    function deleteBlock() {
      const blockId = parseInt(document.getElementById('blockModalId').value);
      if (!confirm('Block wirklich löschen?')) return;
      
      state.blocks = state.blocks.filter(b => b.id !== blockId);
      state.canvasElements = state.canvasElements.filter(e => e.blockId !== blockId);
      
      closeBlockModal();
      renderCategories();
      renderCanvas();
    }
    
    function closeBlockModal() {
      document.getElementById('blockModal').classList.remove('open');
    }
    
    function findBlockUsage(blockId) {
      const usages = [];
      state.useCases.forEach(uc => {
        if (uc.elements && uc.elements.some(e => e.blockId === blockId)) {
          usages.push(uc.name);
        }
      });
      return usages;
    }
    
    // ============== CONTAINERS ==============
    function addContainer() {
      if (!state.currentUseCase) {
        alert('Bitte zuerst einen Use Case auswählen oder erstellen');
        return;
      }
      
      const container = {
        id: state.nextId++,
        type: 'container',
        name: 'Neuer Container',
        description: '',
        x: 100,
        y: 100,
        width: 250,
        height: 180
      };
      
      state.currentUseCase.elements.push(container);
      renderCanvas();
    }
    
    function openContainerModal(elementId) {
      if (!state.currentUseCase) return;

      const element = state.currentUseCase.elements.find(e => e.id === elementId);
      if (!element || element.type !== 'container') return;

      const modal = document.getElementById('containerModal');
      const idInput = document.getElementById('containerModalId');
      const nameInput = document.getElementById('containerModalName');
      const descInput = document.getElementById('containerModalDesc');

      idInput.value = String(elementId);
      nameInput.value = element.name || '';
      descInput.value = element.description || '';

      // Farbe setzen
      const colorRadios = document.querySelectorAll('input[name="containerColor"]');
      colorRadios.forEach(radio => {
        radio.checked = (radio.value === element.colorClass);
        // Visual feedback für ausgewählte Farbe
        const span = radio.nextElementSibling;
        if (span) {
          span.style.borderColor = radio.checked ? '#333' : 'transparent';
          span.style.transform = radio.checked ? 'scale(1.1)' : 'scale(1)';
        }
      });

      // Event Listener für Farbauswahl
      colorRadios.forEach(radio => {
        radio.onchange = () => {
          colorRadios.forEach(r => {
            const s = r.nextElementSibling;
            if (s) {
              s.style.borderColor = r.checked ? '#333' : 'transparent';
              s.style.transform = r.checked ? 'scale(1.1)' : 'scale(1)';
            }
          });
        };
      });

      modal.classList.add('open');
    }
    
    function saveContainerModal() {
      const elementIdStr = document.getElementById('containerModalId').value;
      const elementId = parseInt(elementIdStr);

      if (isNaN(elementId) || !state.currentUseCase) {
        closeContainerModal();
        return;
      }

      const element = state.currentUseCase.elements.find(e => e.id === elementId);
      if (!element) {
        closeContainerModal();
        return;
      }

      const newName = document.getElementById('containerModalName').value.trim();
      element.name = newName || 'Container'; // Fallback wenn leer
      element.description = document.getElementById('containerModalDesc').value;

      // Farbe speichern
      const selectedColor = document.querySelector('input[name="containerColor"]:checked');
      if (selectedColor) {
        element.colorClass = selectedColor.value;
      }

      closeContainerModal();
      renderCanvas();
    }
    
    function deleteContainer() {
      const elementId = parseInt(document.getElementById('containerModalId').value);
      if (!confirm('Container wirklich löschen?')) return;
      
      if (state.currentUseCase) {
        state.currentUseCase.elements = state.currentUseCase.elements.filter(e => e.id !== elementId);
        state.currentUseCase.connections = (state.currentUseCase.connections || [])
          .filter(c => c.from !== elementId && c.to !== elementId);
      }
      
      closeContainerModal();
      renderCanvas();
    }
    
    function closeContainerModal() {
      document.getElementById('containerModal').classList.remove('open');
    }
    
    // ============== PHASES ==============
    function renderPhases() {
      const library = document.querySelector('.usecase-library');
      if (!library) return;

      library.innerHTML = state.phases.map(phase => {
        const phaseUseCases = state.useCases.filter(uc => uc.phaseId === phase.id);

        return `
          <div class="usecase-column" data-phase-id="${phase.id}">
            <div class="usecase-column-header" ondblclick="editPhase(${phase.id})" style="cursor: pointer;">
              ${getPhaseIcon(phase.icon)}
              ${phase.name}
            </div>
            <div class="usecase-column-content">
              ${phaseUseCases.map(uc => `
                <div class="usecase-card ${state.currentUseCase?.id === uc.id ? 'active' : ''}"
                     onclick="selectUseCase(${uc.id})"
                     ondblclick="selectUseCase(${uc.id})">
                  <div class="uc-name">${uc.name}</div>
                  <div class="uc-info">${uc.elements?.length || 0} Elemente</div>
                </div>
              `).join('')}
            </div>
            <button class="add-usecase-btn" onclick="createNewUseCase(${phase.id})">
              <svg class="icon-svg" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Neu
            </button>
          </div>
        `;
      }).join('') + `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; gap: 12px;">
          <button class="btn btn-secondary" onclick="addNewPhase()" style="height: fit-content; width: 100%; max-width: 160px;">
            <svg class="icon-svg" viewBox="0 0 24 24" style="margin-right: 4px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Neue Phase
          </button>
          <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
            <button class="btn btn-secondary" onclick="importUseCases()" style="font-size: 11px; padding: 6px 10px;" title="Use Cases aus JSON importieren">
              <svg class="icon-svg" viewBox="0 0 24 24" style="width: 14px; height: 14px; margin-right: 4px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Import
            </button>
            <button class="btn btn-secondary" onclick="exportUseCases()" style="font-size: 11px; padding: 6px 10px;" title="Use Cases als JSON exportieren">
              <svg class="icon-svg" viewBox="0 0 24 24" style="width: 14px; height: 14px; margin-right: 4px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Export
            </button>
          </div>
        </div>
      `;
    }

    function getPhaseIcon(iconName) {
      const icons = {
        'wrench': '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
        'factory': '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>',
        'shopping-cart': '<svg class="icon-svg" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>',
        'car': '<svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>',
        'settings': '<svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>'
      };
      return icons[iconName] || icons['settings'];
    }

    function addNewPhase() {
      document.getElementById('phaseModalId').value = '';
      document.getElementById('phaseModalName').value = '';
      document.getElementById('phaseModalIcon').value = 'settings';
      document.getElementById('phaseDeleteBtn').style.display = 'none';
      document.getElementById('phaseModal').classList.add('open');
    }

    function editPhase(phaseId) {
      const phase = state.phases.find(p => p.id === phaseId);
      if (!phase) return;

      document.getElementById('phaseModalId').value = phase.id;
      document.getElementById('phaseModalName').value = phase.name;
      document.getElementById('phaseModalIcon').value = phase.icon;
      document.getElementById('phaseDeleteBtn').style.display = 'block';
      document.getElementById('phaseModal').classList.add('open');
    }

    function savePhaseModal() {
      const id = document.getElementById('phaseModalId').value;
      const name = document.getElementById('phaseModalName').value.trim();
      const icon = document.getElementById('phaseModalIcon').value;

      if (!name) {
        alert('Bitte einen Namen eingeben');
        return;
      }

      if (id) {
        // Edit existing phase
        const phase = state.phases.find(p => p.id === parseInt(id));
        if (phase) {
          phase.name = name;
          phase.icon = icon;
        }
      } else {
        // Create new phase
        state.phases.push({
          id: state.nextId++,
          name: name,
          icon: icon
        });
      }

      closePhaseModal();
      renderPhases();
      scheduleSave();
    }

    function deletePhase() {
      const id = parseInt(document.getElementById('phaseModalId').value);
      if (!id) return;

      const phaseUseCases = state.useCases.filter(uc => uc.phaseId === id);
      if (phaseUseCases.length > 0) {
        if (!confirm(`Phase und ${phaseUseCases.length} Use Case(s) löschen?`)) return;
      } else {
        if (!confirm('Phase wirklich löschen?')) return;
      }

      state.phases = state.phases.filter(p => p.id !== id);
      state.useCases = state.useCases.filter(uc => uc.phaseId !== id);

      if (state.currentUseCase?.phaseId === id) {
        state.currentUseCase = null;
      }

      closePhaseModal();
      renderPhases();
      renderUseCasePanel();
      renderCanvas();
      scheduleSave();
    }

    function closePhaseModal() {
      document.getElementById('phaseModal').classList.remove('open');
    }

    // ============== USE CASES ==============
    function createNewUseCase(phaseId) {
      const uc = {
        id: state.nextId++,
        name: 'Neuer Use Case',
        phaseId: phaseId,
        description: '',
        businessValue: '',
        owner: '',
        priority: 'prio-2',
        status: 'draft',
        elements: [],
        connections: []
      };

      state.useCases.push(uc);
      selectUseCase(uc.id);
      renderPhases();
    }
    
    function renderUseCases() {
      // Just re-render phases (which includes use cases)
      renderPhases();
    }

    function selectUseCase(ucId) {
      state.currentUseCase = state.useCases.find(uc => uc.id === ucId);
      renderPhases();
      renderUseCasePanel();
      renderCanvas();
    }
    
    function renderUseCasePanel() {
      const panel = document.getElementById('usecasePanel');

      if (!state.currentUseCase) {
        panel.innerHTML = `
          <div style="color: #999; text-align: center; padding: 40px 20px;">
            <svg class="icon-svg icon-xl" viewBox="0 0 24 24" style="margin-bottom: 10px; opacity: 0.5;"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
            <div>Wähle einen Use Case aus der Bibliothek<br>oder erstelle einen neuen</div>
          </div>
        `;
        return;
      }

      const uc = state.currentUseCase;
      const blockCount = uc.elements?.filter(e => e.type !== 'container').length || 0;
      const containerCount = uc.elements?.filter(e => e.type === 'container').length || 0;
      const connectionCount = uc.connections?.length || 0;

      panel.innerHTML = `
        <div class="uc-row">
          <div>
            <label>Name</label>
            <input type="text" id="ucName" value="${uc.name}" onchange="updateUseCase()">
          </div>
          <div>
            <label>Phase</label>
            <select id="ucPhase" onchange="changeUseCasePhase()">
              ${state.phases.map(p => `
                <option value="${p.id}" ${uc.phaseId === p.id ? 'selected' : ''}>${p.name}</option>
              `).join('')}
            </select>
          </div>
        </div>

        <label>Beschreibung</label>
        <textarea id="ucDesc" onchange="updateUseCase()" placeholder="Was macht dieser Use Case?">${uc.description || ''}</textarea>

        <label>Business Value</label>
        <textarea id="ucValue" onchange="updateUseCase()" placeholder="ROI, Nutzen, Einsparungen...">${uc.businessValue || ''}</textarea>

        <div class="uc-row" style="margin-top: 16px;">
          <div>
            <label>Owner</label>
            <input type="text" id="ucOwner" value="${uc.owner || ''}" onchange="updateUseCase()" placeholder="Team">
          </div>
          <div>
            <label>Priorität</label>
            <select id="ucPriority" onchange="updateUseCase()">
              <option value="prio-1" ${uc.priority === 'prio-1' ? 'selected' : ''}>Prio 1</option>
              <option value="prio-2" ${uc.priority === 'prio-2' ? 'selected' : ''}>Prio 2</option>
              <option value="prio-3" ${uc.priority === 'prio-3' ? 'selected' : ''}>Prio 3</option>
            </select>
          </div>
        </div>

        <label>Status</label>
        <select id="ucStatus" onchange="updateUseCase()">
          <option value="draft" ${uc.status === 'draft' ? 'selected' : ''}>Entwurf</option>
          <option value="defined" ${uc.status === 'defined' ? 'selected' : ''}>Definiert</option>
          <option value="in-progress" ${uc.status === 'in-progress' ? 'selected' : ''}>In Umsetzung</option>
          <option value="done" ${uc.status === 'done' ? 'selected' : ''}>Fertig</option>
        </select>

        <div class="uc-stats">
          <div class="uc-stat">
            <div class="uc-stat-value">${blockCount}</div>
            <div class="uc-stat-label">Blocks</div>
          </div>
          <div class="uc-stat">
            <div class="uc-stat-value">${containerCount}</div>
            <div class="uc-stat-label">Container</div>
          </div>
          <div class="uc-stat">
            <div class="uc-stat-value">${connectionCount}</div>
            <div class="uc-stat-label">Verbind.</div>
          </div>
        </div>

        <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="exportUseCaseToPDF()">
          <svg class="icon-svg" viewBox="0 0 24 24" style="width:14px;height:14px;margin-right:6px;vertical-align:middle;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          PDF Export
        </button>

        <button class="btn btn-danger" style="width:100%; margin-top:10px;" onclick="deleteUseCase()">
          Use Case löschen
        </button>
      `;
    }
    
    function updateUseCase() {
      if (!state.currentUseCase) return;
      
      state.currentUseCase.name = document.getElementById('ucName').value;
      state.currentUseCase.description = document.getElementById('ucDesc').value;
      state.currentUseCase.businessValue = document.getElementById('ucValue').value;
      state.currentUseCase.owner = document.getElementById('ucOwner').value;
      state.currentUseCase.priority = document.getElementById('ucPriority').value;
      state.currentUseCase.status = document.getElementById('ucStatus').value;
      
      renderUseCases();
    }
    
    function changeUseCasePhase() {
      if (!state.currentUseCase) return;

      const newPhaseId = parseInt(document.getElementById('ucPhase').value);

      if (state.currentUseCase.phaseId === newPhaseId) return;

      state.currentUseCase.phaseId = newPhaseId;

      renderPhases();
      scheduleSave();
    }

    function deleteUseCase() {
      if (!state.currentUseCase) return;
      if (!confirm('Use Case wirklich löschen?')) return;

      state.useCases = state.useCases.filter(uc => uc.id !== state.currentUseCase.id);
      state.currentUseCase = null;

      renderPhases();
      renderUseCasePanel();
      renderCanvas();
      scheduleSave();
    }
    
    // ============== CANVAS ==============
    function renderCanvas() {
      // Auto-save state
      scheduleSave();

      const canvas = document.getElementById('canvas');
      const canvasArea = document.querySelector('.canvas-area');

      // Clear existing elements (keep SVG)
      canvas.querySelectorAll('.canvas-block, .canvas-container').forEach(el => el.remove());
      canvasArea.querySelectorAll('.canvas-header, .canvas-empty').forEach(el => el.remove());

      if (!state.currentUseCase) {
        document.getElementById('connectionsSvg').innerHTML = `
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
            </marker>
          </defs>
        `;

        // Show empty state
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'canvas-empty';
        emptyDiv.innerHTML = `
          <svg class="icon-svg icon-xl" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
          <h3>Kein Use Case ausgewählt</h3>
          <p>Wähle einen Use Case aus der Bibliothek unten<br>oder erstelle einen neuen</p>
        `;
        canvasArea.appendChild(emptyDiv);
        return;
      }

      const uc = state.currentUseCase;

      // Render Canvas Header
      const phase = state.phases.find(p => p.id === uc.phaseId);

      const statusLabels = {
        draft: 'Entwurf',
        defined: 'Definiert',
        'in-progress': 'In Umsetzung',
        done: 'Fertig'
      };

      const header = document.createElement('div');
      header.className = 'canvas-header';
      header.innerHTML = `
        <h2>${uc.name}</h2>
        <span class="uc-phase-badge">${phase?.name || 'Keine Phase'}</span>
        <span class="uc-status-badge">${statusLabels[uc.status] || uc.status}</span>
      `;
      canvasArea.insertBefore(header, canvas);

      // Render containers first (so blocks appear on top)
      state.currentUseCase.elements
        .filter(e => e.type === 'container')
        .forEach(el => renderContainerElement(el));

      // Render blocks
      state.currentUseCase.elements
        .filter(e => e.type !== 'container')
        .forEach(el => renderBlockElement(el));

      // Render connections
      renderConnections();
    }

    function renderBlockElement(element) {
      const block = state.blocks.find(b => b.id === element.blockId);
      if (!block) return;

      const cat = state.categories.find(c => c.id === block.categoryId);
      const iconName = block.icon || 'cpu';
      const desc = block.description ? block.description.substring(0, 60) + (block.description.length > 60 ? '...' : '') : '';

      // Anforderungs-Status prüfen
      const reqs = block.requirements || [];
      let reqsStatusClass = '';
      if (reqs.length === 0) {
        // Keine Anforderungen = nicht befüllt = rot
        reqsStatusClass = ' reqs-incomplete';
      } else {
        const allComplete = reqs.every(r => r.checked && r.text.trim() !== '');
        reqsStatusClass = allComplete ? ' reqs-complete' : ' reqs-incomplete';
      }

      const div = document.createElement('div');
      div.className = 'canvas-block' + (selectedElements.has(element.id) ? ' selected' : '') + reqsStatusClass;
      div.id = `element-${element.id}`;
      div.style.left = element.x + 'px';
      div.style.top = element.y + 'px';
      div.style.borderColor = cat?.color || '#666';
      const catColor = cat?.color || '#666';
      div.style.background = `linear-gradient(145deg, ${catColor}0D 0%, rgba(255,255,255,0.96) 40%, rgba(255,255,255,0.98) 100%)`;

      div.innerHTML = `
        <div class="block-icon" style="color: ${catColor};">${getSvgIcon(iconName, 24)}</div>
        <div class="block-header">${block.name}</div>
        <div class="block-type" style="background: ${catColor}25; color: ${catColor}; border: 2px solid ${catColor}; font-weight: 600;">${cat?.name || ''}</div>
        ${desc ? `<div class="block-desc">${desc}</div>` : ''}
        <div class="anchor anchor-top" data-anchor="top"></div>
        <div class="anchor anchor-bottom" data-anchor="bottom"></div>
        <div class="anchor anchor-left" data-anchor="left"></div>
        <div class="anchor anchor-right" data-anchor="right"></div>
      `;
      
      // Events
      div.addEventListener('mousedown', (e) => handleElementMouseDown(e, element));
      div.addEventListener('dblclick', () => openBlockModal(element.blockId, element.id));
      div.addEventListener('contextmenu', (e) => showContextMenu(e, element.id));
      
      // Anchor events
      div.querySelectorAll('.anchor').forEach(anchor => {
        anchor.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          e.preventDefault();
          startConnection(element.id, anchor.dataset.anchor);
        });
        anchor.addEventListener('mouseup', (e) => {
          e.stopPropagation();
          if (connectionStart && connectionStart.elementId !== element.id) {
            completeConnection(element.id, anchor.dataset.anchor);
          }
        });
        anchor.addEventListener('mouseenter', (e) => {
          if (connectionStart) {
            anchor.classList.add('active');
          }
        });
        anchor.addEventListener('mouseleave', (e) => {
          if (connectionStart && connectionStart.elementId !== element.id) {
            anchor.classList.remove('active');
          }
        });
      });

      document.getElementById('canvas').appendChild(div);
    }

    // Pastell-Farben für Container
    const containerPastelColors = ['pastel-blue', 'pastel-mint', 'pastel-lavender', 'pastel-peach', 'pastel-lemon', 'pastel-rose', 'pastel-sky', 'pastel-sage'];

    function renderContainerElement(element) {
      // Farbe zuweisen falls noch keine gespeichert
      if (!element.colorClass) {
        const containers = state.currentUseCase?.elements.filter(e => e.type === 'container') || [];
        const idx = containers.findIndex(c => c.id === element.id);
        element.colorClass = containerPastelColors[idx % containerPastelColors.length];
      }

      const div = document.createElement('div');
      div.className = 'canvas-container ' + element.colorClass + (selectedElements.has(element.id) ? ' selected' : '');
      div.id = `element-${element.id}`;
      div.style.left = element.x + 'px';
      div.style.top = element.y + 'px';
      div.style.width = element.width + 'px';
      div.style.height = element.height + 'px';

      div.innerHTML = `
        <div class="container-header">
          <svg class="icon-svg icon-sm" viewBox="0 0 24 24" style="margin-right: 4px;"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" y1="22" x2="12" y2="12"/></svg>
          ${element.name}
        </div>
        <div class="container-content"></div>
        <div class="anchor anchor-top" data-anchor="top"></div>
        <div class="anchor anchor-bottom" data-anchor="bottom"></div>
        <div class="anchor anchor-left" data-anchor="left"></div>
        <div class="anchor anchor-right" data-anchor="right"></div>
        <div class="resize-handle"></div>
      `;
      
      // Events
      div.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('resize-handle')) {
          startResize(e, element);
        } else if (!e.target.classList.contains('anchor')) {
          handleElementMouseDown(e, element);
        }
      });
      div.addEventListener('dblclick', () => openContainerModal(element.id));
      div.addEventListener('contextmenu', (e) => showContextMenu(e, element.id));

      // Anchor events
      div.querySelectorAll('.anchor').forEach(anchor => {
        anchor.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          e.preventDefault();
          startConnection(element.id, anchor.dataset.anchor);
        });
        anchor.addEventListener('mouseup', (e) => {
          e.stopPropagation();
          if (connectionStart && connectionStart.elementId !== element.id) {
            completeConnection(element.id, anchor.dataset.anchor);
          }
        });
        anchor.addEventListener('mouseenter', (e) => {
          if (connectionStart) {
            anchor.classList.add('active');
          }
        });
        anchor.addEventListener('mouseleave', (e) => {
          if (connectionStart && connectionStart.elementId !== element.id) {
            anchor.classList.remove('active');
          }
        });
      });

      document.getElementById('canvas').appendChild(div);
    }

    // ============== SNAP TO GRID ==============
    const GRID_SIZE = 20; // Rastergröße in Pixeln
    let snapToGrid = true; // Standard: aktiviert

    function snapValue(value) {
      if (!snapToGrid) return value;
      return Math.round(value / GRID_SIZE) * GRID_SIZE;
    }

    function toggleSnapToGrid() {
      snapToGrid = !snapToGrid;
      const canvas = document.getElementById('canvas');
      const btn = document.getElementById('gridToggle');

      if (snapToGrid) {
        canvas.classList.remove('no-grid');
        btn.classList.add('active');
      } else {
        canvas.classList.add('no-grid');
        btn.classList.remove('active');
      }
    }

    // ============== BUILD MODE ==============
    let buildModeActive = false;

    function toggleBuildMode() {
      buildModeActive = !buildModeActive;
      const btn = document.getElementById('buildModeBtn');

      if (buildModeActive) {
        document.body.classList.add('build-mode');
        btn.classList.add('build-mode-active');
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
            <line x1="8" y1="21" x2="16" y2="21"/>
            <line x1="12" y1="17" x2="12" y2="21"/>
          </svg>
          Exit Build
        `;
      } else {
        document.body.classList.remove('build-mode');
        btn.classList.remove('build-mode-active');
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
            <line x1="8" y1="21" x2="16" y2="21"/>
            <line x1="12" y1="17" x2="12" y2="21"/>
          </svg>
          Build Mode
        `;
      }
    }

    // ============== DRAG & DROP ==============
    function handleBlockDragStart(event, blockId) {
      event.dataTransfer.setData('blockId', blockId);
    }

    const canvas = document.getElementById('canvas');

    canvas.addEventListener('dragover', (e) => e.preventDefault());

    canvas.addEventListener('drop', (e) => {
      e.preventDefault();

      if (!state.currentUseCase) {
        alert('Bitte zuerst einen Use Case auswählen oder erstellen');
        return;
      }

      const blockId = parseInt(e.dataTransfer.getData('blockId'));
      if (!blockId) return;

      const rect = canvas.getBoundingClientRect();
      // Zoom berücksichtigen bei Drop + Snap to Grid
      const rawX = (e.clientX - rect.left) / canvasZoom - 50;
      const rawY = (e.clientY - rect.top) / canvasZoom - 20;

      // Create canvas element (instance of block)
      const element = {
        id: state.nextId++,
        type: 'block',
        blockId: blockId,
        x: snapValue(rawX),
        y: snapValue(rawY)
      };

      state.currentUseCase.elements.push(element);
      renderCanvas();
    });

    // ============== ELEMENT INTERACTION ==============
    let dragStartTimeout = null;
    let mouseDownPos = { x: 0, y: 0 };

    function handleElementMouseDown(e, element) {
      if (e.target.classList.contains('anchor')) return;

      const isMultiSelect = e.ctrlKey || e.metaKey; // Ctrl (Windows/Linux) oder Cmd (Mac)
      const blockEl = e.target.closest('.canvas-block, .canvas-container');

      if (isMultiSelect) {
        // Multi-Selection: Element zur Auswahl hinzufügen oder entfernen
        if (selectedElements.has(element.id)) {
          selectedElements.delete(element.id);
          if (blockEl) blockEl.classList.remove('selected');
        } else {
          selectedElements.add(element.id);
          if (blockEl) blockEl.classList.add('selected');
        }
      } else {
        // Normale Selektion: Wenn Element bereits selektiert, Selection beibehalten
        if (!selectedElements.has(element.id)) {
          // Vorherige Selektion entfernen
          document.querySelectorAll('.canvas-block.selected, .canvas-container.selected').forEach(el => {
            el.classList.remove('selected');
          });
          selectedElements.clear();
          selectedElements.add(element.id);
          if (blockEl) blockEl.classList.add('selected');
        }
      }

      updateSelectionCounter();

      mouseDownPos = { x: e.clientX, y: e.clientY };

      // Offsets für alle selektierten Elemente berechnen
      dragOffsets.clear();
      const canvasEl = document.getElementById('canvas');
      const canvasRect = canvasEl.getBoundingClientRect();

      selectedElements.forEach(elId => {
        const el = state.currentUseCase.elements.find(e => e.id === elId);
        if (el) {
          dragOffsets.set(elId, {
            x: (e.clientX - canvasRect.left) / canvasZoom - el.x,
            y: (e.clientY - canvasRect.top) / canvasZoom - el.y
          });
        }
      });

      // Verzögerung bevor Drag startet, um Doppelklick zu ermöglichen
      dragStartTimeout = setTimeout(() => {
        isDragging = true;
      }, 150);
    }
    
    document.addEventListener('mousemove', (e) => {
      // Wenn Maus bewegt wird und Elemente ausgewählt, sofort Drag starten
      if (selectedElements.size > 0 && !isDragging && dragStartTimeout) {
        const dx = Math.abs(e.clientX - mouseDownPos.x);
        const dy = Math.abs(e.clientY - mouseDownPos.y);
        if (dx > 3 || dy > 3) {
          clearTimeout(dragStartTimeout);
          dragStartTimeout = null;
          isDragging = true;
        }
      }

      if (!isDragging || selectedElements.size === 0 || !state.currentUseCase) return;

      const canvasEl = document.getElementById('canvas');
      const canvasRect = canvasEl.getBoundingClientRect();

      // Alle selektierten Elemente bewegen
      selectedElements.forEach(elId => {
        const element = state.currentUseCase.elements.find(el => el.id === elId);
        if (!element) return;

        const offset = dragOffsets.get(elId) || { x: 0, y: 0 };

        // Zoom berücksichtigen bei Koordinatenberechnung + Snap to Grid
        const rawX = (e.clientX - canvasRect.left) / canvasZoom - offset.x;
        const rawY = (e.clientY - canvasRect.top) / canvasZoom - offset.y;
        element.x = snapValue(rawX);
        element.y = snapValue(rawY);

        const el = document.getElementById(`element-${element.id}`);
        if (el) {
          el.style.left = element.x + 'px';
          el.style.top = element.y + 'px';
        }
      });

      renderConnections();
    });
    
    // ============== RESIZE ==============
    let isResizing = false;
    let resizeElement = null;

    document.addEventListener('mouseup', () => {
      if (dragStartTimeout) {
        clearTimeout(dragStartTimeout);
        dragStartTimeout = null;
      }
      isDragging = false;
      isResizing = false;
      resizeElement = null;
    });

    function startResize(e, element) {
      e.stopPropagation();
      isResizing = true;
      resizeElement = element;
    }

    document.addEventListener('mousemove', (e) => {
      if (!isResizing || !resizeElement) return;

      const canvasRect = canvas.getBoundingClientRect();
      // Zoom berücksichtigen + Snap to Grid
      const mouseX = (e.clientX - canvasRect.left) / canvasZoom;
      const mouseY = (e.clientY - canvasRect.top) / canvasZoom;
      const newWidth = snapValue(mouseX - resizeElement.x);
      const newHeight = snapValue(mouseY - resizeElement.y);

      resizeElement.width = Math.max(GRID_SIZE * 8, newWidth); // Min 160px
      resizeElement.height = Math.max(GRID_SIZE * 5, newHeight); // Min 100px

      const el = document.getElementById(`element-${resizeElement.id}`);
      if (el) {
        el.style.width = resizeElement.width + 'px';
        el.style.height = resizeElement.height + 'px';
      }

      renderConnections();
    });
    
    // ============== CONNECTIONS ==============
    let tempLineEnd = null;

    function startConnection(elementId, anchor) {
      // Starte neue Verbindung nur wenn keine aktiv
      if (connectionStart) return;

      connectionStart = { elementId, anchor };
      document.body.style.cursor = 'crosshair';

      // Markiere den aktiven Anker
      const el = document.getElementById(`element-${elementId}`);
      if (el) {
        const anchorEl = el.querySelector(`.anchor-${anchor}`);
        if (anchorEl) anchorEl.classList.add('active');
      }

      // Starte temporäre Linie
      tempLineEnd = null;
      renderConnections();
    }

    function completeConnection(targetElementId, targetAnchor) {
      if (!connectionStart) return;
      if (connectionStart.elementId === targetElementId) {
        cancelConnection();
        return;
      }

      // Verbindung erstellen
      if (!state.currentUseCase.connections) {
        state.currentUseCase.connections = [];
      }

      state.currentUseCase.connections.push({
        id: state.nextId++,
        from: connectionStart.elementId,
        fromAnchor: connectionStart.anchor,
        to: targetElementId,
        toAnchor: targetAnchor
      });

      cancelConnection();
      renderUseCasePanel(); // Update stats
    }

    function cancelConnection() {
      // Entferne aktive Anker-Markierung
      document.querySelectorAll('.anchor.active').forEach(a => a.classList.remove('active'));
      connectionStart = null;
      tempLineEnd = null;
      document.body.style.cursor = 'default';
      renderConnections();
    }

    // Mausbewegung für temporäre Linie
    document.addEventListener('mousemove', (e) => {
      if (!connectionStart) return;

      const canvasRect = canvas.getBoundingClientRect();
      // Zoom berücksichtigen
      tempLineEnd = {
        x: (e.clientX - canvasRect.left) / canvasZoom,
        y: (e.clientY - canvasRect.top) / canvasZoom
      };
      renderConnections();
    });

    // Mouseup irgendwo = Verbindung abbrechen (außer auf Anker)
    document.addEventListener('mouseup', (e) => {
      if (connectionStart && !e.target.classList.contains('anchor')) {
        cancelConnection();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // ESC zum Abbrechen
      if (e.key === 'Escape' && connectionStart) {
        cancelConnection();
      }
      // B für Build Mode (nur wenn kein Input fokussiert)
      if (e.key === 'b' || e.key === 'B') {
        const activeEl = document.activeElement;
        if (activeEl.tagName !== 'INPUT' && activeEl.tagName !== 'TEXTAREA' && !activeEl.isContentEditable) {
          toggleBuildMode();
        }
      }
    });

    function deleteConnection(connId) {
      if (!state.currentUseCase?.connections) return;
      if (confirm('Verbindung löschen?')) {
        state.currentUseCase.connections = state.currentUseCase.connections.filter(c => c.id !== connId);
        renderConnections();
      }
    }

    function renderConnections() {
      const svg = document.getElementById('connectionsSvg');
      svg.innerHTML = `
        <defs>
          <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="strokeWidth">
            <path d="M 0 0 L 8 3 L 0 6 L 2 3 Z" fill="#64748b" />
          </marker>
          <marker id="arrowhead-hover" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto" markerUnits="strokeWidth">
            <path d="M 0 0 L 8 3 L 0 6 L 2 3 Z" fill="#EB0D3F" />
          </marker>
          <filter id="connection-glow" x="-20%" y="-20%" width="140%" height="140%">
            <feGaussianBlur stdDeviation="2" result="blur"/>
            <feMerge>
              <feMergeNode in="blur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
      `;

      // Temporäre Linie während des Verbindens
      if (connectionStart && tempLineEnd) {
        const fromEl = document.getElementById(`element-${connectionStart.elementId}`);
        if (fromEl) {
          const fromPos = getAnchorPosition(fromEl, connectionStart.anchor);
          const tempPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          tempPath.setAttribute('class', 'connection-temp');

          // Smooth curve for temp line too
          const dx = tempLineEnd.x - fromPos.x;
          const dy = tempLineEnd.y - fromPos.y;
          const cx = fromPos.x + dx * 0.5;
          const cy = fromPos.y + dy * 0.5;
          tempPath.setAttribute('d', `M ${fromPos.x} ${fromPos.y} Q ${cx} ${fromPos.y}, ${tempLineEnd.x} ${tempLineEnd.y}`);
          svg.appendChild(tempPath);
        }
      }

      if (!state.currentUseCase?.connections) return;

      state.currentUseCase.connections.forEach(conn => {
        const fromEl = document.getElementById(`element-${conn.from}`);
        const toEl = document.getElementById(`element-${conn.to}`);

        if (!fromEl || !toEl) return;

        const fromPos = getAnchorPosition(fromEl, conn.fromAnchor);
        const toPos = getAnchorPosition(toEl, conn.toAnchor);

        // Berechne Kontrollpunkte für glatte Kurve
        const dx = toPos.x - fromPos.x;
        const dy = toPos.y - fromPos.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        // Dynamischer Offset basierend auf Distanz
        const offset = Math.max(40, Math.min(distance * 0.4, 120));

        let cp1x, cp1y, cp2x, cp2y;

        if (conn.fromAnchor === 'right' || conn.fromAnchor === 'left') {
          cp1x = fromPos.x + (conn.fromAnchor === 'right' ? offset : -offset);
          cp1y = fromPos.y;
        } else {
          cp1x = fromPos.x;
          cp1y = fromPos.y + (conn.fromAnchor === 'bottom' ? offset : -offset);
        }

        if (conn.toAnchor === 'right' || conn.toAnchor === 'left') {
          cp2x = toPos.x + (conn.toAnchor === 'right' ? offset : -offset);
          cp2y = toPos.y;
        } else {
          cp2x = toPos.x;
          cp2y = toPos.y + (conn.toAnchor === 'bottom' ? offset : -offset);
        }

        const pathD = `M ${fromPos.x} ${fromPos.y} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${toPos.x} ${toPos.y}`;

        // Shadow path (rendered first, behind main path)
        const shadowPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        shadowPath.setAttribute('class', 'connection-shadow');
        shadowPath.setAttribute('d', pathD);
        svg.appendChild(shadowPath);

        // Main connection path
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('class', 'connection');
        path.setAttribute('data-conn-id', conn.id);
        path.setAttribute('marker-end', 'url(#arrowhead)');
        path.style.pointerEvents = 'stroke';
        path.setAttribute('d', pathD);

        // Klick zum Löschen
        path.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteConnection(conn.id);
        });

        // Hover-Effekt
        path.addEventListener('mouseenter', () => {
          path.setAttribute('marker-end', 'url(#arrowhead-hover)');
          shadowPath.style.stroke = 'rgba(235, 13, 63, 0.15)';
        });
        path.addEventListener('mouseleave', () => {
          path.setAttribute('marker-end', 'url(#arrowhead)');
          shadowPath.style.stroke = 'rgba(0, 0, 0, 0.08)';
        });

        svg.appendChild(path);
      });
    }

    function getAnchorPosition(el, anchor) {
      // Direkt CSS-Position verwenden (unabhängig von Zoom)
      const x = parseFloat(el.style.left) || 0;
      const y = parseFloat(el.style.top) || 0;
      // offsetWidth/Height sind bereits in Canvas-Koordinaten (nicht gezoomt)
      const w = el.offsetWidth;
      const h = el.offsetHeight;

      switch(anchor) {
        case 'top': return { x: x + w/2, y: y };
        case 'bottom': return { x: x + w/2, y: y + h };
        case 'left': return { x: x, y: y + h/2 };
        case 'right': return { x: x + w, y: y + h/2 };
        default: return { x: x + w/2, y: y + h/2 };
      }
    }
    
    // ============== SAVE / LOAD ==============
    function saveProject() {
      const json = JSON.stringify(state, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'architecture-project.json';
      a.click();
      
      URL.revokeObjectURL(url);
    }
    
    function loadProject() {
      document.getElementById('fileInput').click();
    }
    
    function handleFileLoad(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          state = JSON.parse(e.target.result);
          state.currentUseCase = null;
          
          renderCategories();
          renderUseCases();
          renderUseCasePanel();
          renderCanvas();
          
          alert('Projekt geladen!');
        } catch (err) {
          alert('Fehler beim Laden: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
    
    function exportProject() {
      // TODO: Export as PDF/Word
      alert('Export-Funktion kommt im Design-Update');
    }
    
    // ============== CONTEXT MENU ==============
    let contextMenuElement = null;

    function showContextMenu(e, elementId) {
      e.preventDefault();
      contextMenuElement = elementId;
      const menu = document.getElementById('contextMenu');
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
      menu.classList.add('visible');
    }

    function hideContextMenu() {
      const menu = document.getElementById('contextMenu');
      menu.classList.remove('visible');
      contextMenuElement = null;
    }

    function contextMenuEdit() {
      if (!contextMenuElement || !state.currentUseCase) return;
      const element = state.currentUseCase.elements.find(el => el.id === contextMenuElement);
      if (element) {
        if (element.type === 'container') {
          openContainerModal(element.id);
        } else {
          openBlockModal(element.blockId, element.id);
        }
      }
      hideContextMenu();
    }

    function contextMenuDelete() {
      if (!contextMenuElement || !state.currentUseCase) return;
      deleteElement(contextMenuElement);
      hideContextMenu();
    }

    function deleteElement(elementId) {
      if (!state.currentUseCase) return;
      state.currentUseCase.elements = state.currentUseCase.elements.filter(el => el.id !== elementId);
      state.currentUseCase.connections = (state.currentUseCase.connections || [])
        .filter(c => c.from !== elementId && c.to !== elementId);
      selectedElements.delete(elementId);
      updateSelectionCounter();
      renderCanvas();
    }

    function deleteSelectedElements() {
      if (!state.currentUseCase || selectedElements.size === 0) return;
      const elementsToDelete = [...selectedElements];
      elementsToDelete.forEach(elId => {
        state.currentUseCase.elements = state.currentUseCase.elements.filter(el => el.id !== elId);
        state.currentUseCase.connections = (state.currentUseCase.connections || [])
          .filter(c => c.from !== elId && c.to !== elId);
      });
      selectedElements.clear();
      updateSelectionCounter();
      renderCanvas();
    }

    // ============== COPY/PASTE ==============
    function copySelectedElements() {
      if (!state.currentUseCase || selectedElements.size === 0) return;

      // Elemente kopieren
      clipboard.elements = [];
      const selectedIds = [...selectedElements];

      selectedIds.forEach(elId => {
        const element = state.currentUseCase.elements.find(el => el.id === elId);
        if (element) {
          // Deep copy des Elements
          clipboard.elements.push(JSON.parse(JSON.stringify(element)));
        }
      });

      // Verbindungen zwischen den kopierten Elementen kopieren
      clipboard.connections = [];
      if (state.currentUseCase.connections) {
        state.currentUseCase.connections.forEach(conn => {
          if (selectedIds.includes(conn.from) && selectedIds.includes(conn.to)) {
            clipboard.connections.push(JSON.parse(JSON.stringify(conn)));
          }
        });
      }

      // Visuelles Feedback
      showToast(`${clipboard.elements.length} Element${clipboard.elements.length > 1 ? 'e' : ''} kopiert`);
    }

    function pasteElements() {
      if (!state.currentUseCase || clipboard.elements.length === 0) return;

      // ID-Mapping für alte zu neue IDs
      const idMapping = new Map();

      // Offset für eingefügte Elemente (leicht versetzt)
      const offsetX = 20;
      const offsetY = 20;

      // Neue Elemente erstellen
      const newElements = [];
      clipboard.elements.forEach(element => {
        const newId = state.nextId++;
        idMapping.set(element.id, newId);

        const newElement = {
          ...JSON.parse(JSON.stringify(element)),
          id: newId,
          x: element.x + offsetX,
          y: element.y + offsetY
        };

        newElements.push(newElement);
        state.currentUseCase.elements.push(newElement);
      });

      // Verbindungen mit neuen IDs erstellen
      clipboard.connections.forEach(conn => {
        const newFromId = idMapping.get(conn.from);
        const newToId = idMapping.get(conn.to);

        if (newFromId && newToId) {
          if (!state.currentUseCase.connections) {
            state.currentUseCase.connections = [];
          }
          state.currentUseCase.connections.push({
            id: state.nextId++,
            from: newFromId,
            fromAnchor: conn.fromAnchor,
            to: newToId,
            toAnchor: conn.toAnchor
          });
        }
      });

      // Neue Elemente selektieren
      selectedElements.clear();
      newElements.forEach(el => selectedElements.add(el.id));

      updateSelectionCounter();
      renderCanvas();
      saveState();

      // Visuelles Feedback
      showToast(`${newElements.length} Element${newElements.length > 1 ? 'e' : ''} eingefügt`);
    }

    function selectAllElements() {
      if (!state.currentUseCase || !state.currentUseCase.elements) return;

      selectedElements.clear();
      state.currentUseCase.elements.forEach(el => {
        selectedElements.add(el.id);
      });

      // Visuelle Selektion aktualisieren
      document.querySelectorAll('.canvas-block, .canvas-container').forEach(el => {
        el.classList.add('selected');
      });

      updateSelectionCounter();
    }

    function showToast(message) {
      // Existierenden Toast entfernen
      const existingToast = document.querySelector('.copy-paste-toast');
      if (existingToast) {
        existingToast.remove();
      }

      // Neuen Toast erstellen
      const toast = document.createElement('div');
      toast.className = 'copy-paste-toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      // Animation
      setTimeout(() => toast.classList.add('visible'), 10);
      setTimeout(() => {
        toast.classList.remove('visible');
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }

    // Hide context menu on click outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.context-menu')) {
        hideContextMenu();
      }
    });

    // ============== KEYBOARD ==============
    document.addEventListener('keydown', (e) => {
      // Nicht reagieren wenn in Input/Textarea/Select oder contenteditable
      const tag = e.target.tagName.toLowerCase();
      const isEditable = e.target.isContentEditable;
      const isFormElement = tag === 'input' || tag === 'textarea' || tag === 'select';

      // Prüfen ob ein Modal offen ist
      const modalOpen = document.querySelector('.modal-overlay.open');

      if (isFormElement || isEditable || modalOpen) {
        // Bei Escape Modal schließen
        if (e.key === 'Escape' && modalOpen) {
          modalOpen.classList.remove('open');
        }
        return; // Keine weitere Aktion bei offenen Modals oder in Formularelementen
      }

      if ((e.key === 'Delete' || e.key === 'Backspace') && selectedElements.size > 0 && state.currentUseCase) {
        e.preventDefault();
        deleteSelectedElements();
      }

      // Ctrl+C - Kopieren
      if ((e.ctrlKey || e.metaKey) && e.key === 'c' && selectedElements.size > 0 && state.currentUseCase) {
        e.preventDefault();
        copySelectedElements();
      }

      // Ctrl+V - Einfügen
      if ((e.ctrlKey || e.metaKey) && e.key === 'v' && clipboard.elements.length > 0 && state.currentUseCase) {
        e.preventDefault();
        pasteElements();
      }

      // Ctrl+X - Ausschneiden
      if ((e.ctrlKey || e.metaKey) && e.key === 'x' && selectedElements.size > 0 && state.currentUseCase) {
        e.preventDefault();
        copySelectedElements();
        deleteSelectedElements();
      }

      // Ctrl+A - Alles auswählen
      if ((e.ctrlKey || e.metaKey) && e.key === 'a' && state.currentUseCase) {
        e.preventDefault();
        selectAllElements();
      }

      if (e.key === 'Escape') {
        hideContextMenu();
        connectionStart = null;
        document.body.style.cursor = 'default';
      }

      // G zum Umschalten von Snap to Grid
      if (e.key === 'g' || e.key === 'G') {
        toggleSnapToGrid();
      }

      // Zoom Shortcuts
      if (e.key === '+' || e.key === '=') {
        e.preventDefault();
        zoomIn();
      }
      if (e.key === '-' || e.key === '_') {
        e.preventDefault();
        zoomOut();
      }
      if (e.key === '0') {
        e.preventDefault();
        fitToContent();
      }
    });

    // ============== MARQUEE SELECTION ON CANVAS ==============
    canvas.addEventListener('mousedown', (e) => {
      // Nur starten wenn auf Canvas oder SVG geklickt (nicht auf Blöcke)
      if (e.target === canvas || e.target.classList.contains('connections-svg') || e.target.closest('svg.connections-svg')) {
        // Wenn kein Ctrl/Cmd, vorherige Auswahl löschen
        if (!e.ctrlKey && !e.metaKey) {
          selectedElements.clear();
          document.querySelectorAll('.canvas-block.selected, .canvas-container.selected').forEach(el => {
            el.classList.remove('selected');
          });
          updateSelectionCounter();
        }
        startMarqueeSelection(e);
      }
    });

    document.addEventListener('mousemove', (e) => {
      if (isMarqueeSelecting) {
        updateMarqueeSelection(e);
      }
    });

    document.addEventListener('mouseup', (e) => {
      if (isMarqueeSelecting) {
        endMarqueeSelection(e);
      }
    });

    // ============== SYSTEM VIEW ==============
    function openSystemView() {
      // Reset selection - alle Use Cases auswaehlen
      selectedSystemUseCases.clear();
      state.useCases.forEach(uc => selectedSystemUseCases.add(uc.id));

      const overlay = document.getElementById('systemViewOverlay');
      overlay.classList.add('open');
      renderSystemView();
    }

    function closeSystemView() {
      const overlay = document.getElementById('systemViewOverlay');
      overlay.classList.remove('open');
    }

    // ============== COMPONENT LIBRARY ==============
    let selectedLibraryComponents = new Set();

    function openComponentLibrary() {
      selectedLibraryComponents.clear();
      const overlay = document.getElementById('componentLibraryModal');
      overlay.classList.add('open');
      populateLibraryCategoryFilter();
      populateImportTargetCategory();
      renderComponentLibrary();
    }

    function closeComponentLibrary() {
      const overlay = document.getElementById('componentLibraryModal');
      overlay.classList.remove('open');
    }

    function populateLibraryCategoryFilter() {
      const select = document.getElementById('libraryCategoryFilter');
      select.innerHTML = '<option value="all">Alle Kategorien</option>';

      if (typeof AUTOMOTIVE_COMPONENTS !== 'undefined') {
        for (const [key, category] of Object.entries(AUTOMOTIVE_COMPONENTS)) {
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = category.categoryName + ' (' + category.components.length + ')';
          select.appendChild(opt);
        }
      }
    }

    function populateImportTargetCategory() {
      const select = document.getElementById('importTargetCategory');
      select.innerHTML = '';

      // Add option to use original categories
      const optAuto = document.createElement('option');
      optAuto.value = 'auto';
      optAuto.textContent = 'Automatisch (Original-Kategorien)';
      select.appendChild(optAuto);

      // Add existing categories
      state.categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = cat.name;
        select.appendChild(opt);
      });
    }

    function renderComponentLibrary() {
      const grid = document.getElementById('componentLibraryGrid');
      const searchQuery = (document.getElementById('librarySearchInput')?.value || '').toLowerCase();
      const categoryFilter = document.getElementById('libraryCategoryFilter')?.value || 'all';

      if (typeof AUTOMOTIVE_COMPONENTS === 'undefined') {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">Komponenten-Bibliothek nicht geladen. Bitte Seite neu laden.</div>';
        return;
      }

      let html = '';
      let totalCount = 0;
      let filteredCount = 0;

      for (const [catKey, category] of Object.entries(AUTOMOTIVE_COMPONENTS)) {
        // Apply category filter
        if (categoryFilter !== 'all' && categoryFilter !== catKey) continue;

        // Filter components by search
        const filteredComponents = category.components.filter(comp => {
          if (!searchQuery) return true;
          return comp.name.toLowerCase().includes(searchQuery) ||
                 comp.shortName.toLowerCase().includes(searchQuery) ||
                 comp.description.toLowerCase().includes(searchQuery) ||
                 (comp.requirements || []).some(r => r.toLowerCase().includes(searchQuery));
        });

        if (filteredComponents.length === 0) continue;

        // Category header
        html += '<div class="lib-category-section">';
        html += '<div class="lib-category-title">';
        html += '<span style="width: 12px; height: 12px; border-radius: 4px; background: ' + category.categoryColor + ';"></span>';
        html += category.categoryName;
        html += '<span class="lib-category-count">' + filteredComponents.length + '</span>';
        html += '</div></div>';

        // Components
        filteredComponents.forEach(comp => {
          const compId = catKey + ':' + comp.id;
          const isSelected = selectedLibraryComponents.has(compId);
          totalCount++;
          filteredCount++;

          html += '<div class="lib-component-card' + (isSelected ? ' selected' : '') + '" onclick="toggleLibraryComponent(\'' + compId + '\')">';

          // Category badge
          html += '<div class="lib-card-category" style="background: ' + category.categoryColor + ';">' + category.categoryName + '</div>';

          // Header with icon and title
          html += '<div class="lib-card-header">';
          html += '<div class="lib-card-icon" style="background: ' + category.categoryColor + '22;">' + comp.icon + '</div>';
          html += '<div>';
          html += '<div class="lib-card-title">' + comp.name + '</div>';
          html += '<div class="lib-card-shortname">' + comp.shortName + '</div>';
          html += '</div></div>';

          // Description
          html += '<div class="lib-card-description">' + comp.description + '</div>';

          // Requirements
          if (comp.requirements && comp.requirements.length > 0) {
            html += '<div class="lib-card-requirements">';
            comp.requirements.slice(0, 4).forEach(req => {
              html += '<span class="lib-card-req">' + req + '</span>';
            });
            if (comp.requirements.length > 4) {
              html += '<span class="lib-card-req">+' + (comp.requirements.length - 4) + '</span>';
            }
            html += '</div>';
          }

          html += '</div>';
        });
      }

      if (filteredCount === 0) {
        html = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">Keine Komponenten gefunden.</div>';
      }

      grid.innerHTML = html;
      updateLibraryStats(totalCount);
    }

    function toggleLibraryComponent(compId) {
      if (selectedLibraryComponents.has(compId)) {
        selectedLibraryComponents.delete(compId);
      } else {
        selectedLibraryComponents.add(compId);
      }

      // Update card visual
      const cards = document.querySelectorAll('.lib-component-card');
      cards.forEach(card => {
        const onclick = card.getAttribute('onclick');
        if (onclick && onclick.includes(compId)) {
          card.classList.toggle('selected', selectedLibraryComponents.has(compId));
        }
      });

      updateLibraryStats();
    }

    function selectAllComponents() {
      if (typeof AUTOMOTIVE_COMPONENTS === 'undefined') return;

      const searchQuery = (document.getElementById('librarySearchInput')?.value || '').toLowerCase();
      const categoryFilter = document.getElementById('libraryCategoryFilter')?.value || 'all';

      for (const [catKey, category] of Object.entries(AUTOMOTIVE_COMPONENTS)) {
        if (categoryFilter !== 'all' && categoryFilter !== catKey) continue;

        category.components.forEach(comp => {
          if (!searchQuery ||
              comp.name.toLowerCase().includes(searchQuery) ||
              comp.shortName.toLowerCase().includes(searchQuery) ||
              comp.description.toLowerCase().includes(searchQuery)) {
            selectedLibraryComponents.add(catKey + ':' + comp.id);
          }
        });
      }

      renderComponentLibrary();
    }

    function deselectAllComponents() {
      selectedLibraryComponents.clear();
      renderComponentLibrary();
    }

    function filterComponentLibrary() {
      renderComponentLibrary();
    }

    function updateLibraryStats(total) {
      const totalEl = document.getElementById('libStatTotal');
      const selectedEl = document.getElementById('libStatSelected');
      const btnEl = document.getElementById('importComponentsBtn');

      if (typeof total === 'undefined') {
        total = 0;
        if (typeof AUTOMOTIVE_COMPONENTS !== 'undefined') {
          for (const category of Object.values(AUTOMOTIVE_COMPONENTS)) {
            total += category.components.length;
          }
        }
      }

      const selectedCount = selectedLibraryComponents.size;

      if (totalEl) totalEl.textContent = total + ' Komponenten';
      if (selectedEl) selectedEl.textContent = selectedCount + ' ausgewaehlt';
      if (btnEl) btnEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="margin-right: 6px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Importieren (' + selectedCount + ')';
    }

    function importSelectedComponents() {
      if (selectedLibraryComponents.size === 0) {
        alert('Bitte waehlen Sie mindestens eine Komponente aus.');
        return;
      }

      const targetCategorySelect = document.getElementById('importTargetCategory');
      const targetValue = targetCategorySelect?.value || 'auto';

      // Category mapping for auto mode
      const categoryMapping = {
        'vehicleSystems': 'ENTWICKLUNG',
        'dataIngestion': 'PRODUKTION',
        'dataPlatform': 'Audi Services',
        'processing': 'Audi Services',
        'mlAi': 'Audi Services',
        'backendServices': 'NUTZUNG',
        'frontends': 'NUTZUNG',
        'external': 'Third Party'
      };

      let importedCount = 0;
      const existingBlockNames = new Set(state.blocks.map(b => b.name.toLowerCase()));

      selectedLibraryComponents.forEach(compId => {
        const [catKey, compIdPart] = compId.split(':');
        const category = AUTOMOTIVE_COMPONENTS[catKey];
        if (!category) return;

        const component = category.components.find(c => c.id === compIdPart);
        if (!component) return;

        // Skip if block with same name already exists
        if (existingBlockNames.has(component.name.toLowerCase())) {
          console.log('Block existiert bereits:', component.name);
          return;
        }

        // Determine target category
        let targetCategoryId;
        if (targetValue === 'auto') {
          const mappedCategoryName = categoryMapping[catKey] || 'Audi Services';
          const targetCat = state.categories.find(c => c.name === mappedCategoryName);
          targetCategoryId = targetCat ? targetCat.id : state.categories[0].id;
        } else {
          targetCategoryId = parseInt(targetValue);
        }

        // Create new block
        const newBlock = {
          id: state.nextId++,
          categoryId: targetCategoryId,
          name: component.name,
          icon: getIconNameFromEmoji(component.icon),
          description: component.description,
          notes: 'Importiert aus Komponenten-Bibliothek: ' + category.categoryName,
          owner: '',
          status: 'offen',
          requirements: (component.requirements || []).map((req, idx) => ({
            id: state.nextId++,
            text: req,
            completed: false
          }))
        };

        state.blocks.push(newBlock);
        existingBlockNames.add(component.name.toLowerCase());
        importedCount++;
      });

      if (importedCount > 0) {
        scheduleSave();
        renderCategories();
        closeComponentLibrary();
        alert(importedCount + ' Komponente(n) erfolgreich importiert!');
      } else {
        alert('Keine neuen Komponenten importiert. Moeglicherweise existieren alle bereits.');
      }
    }

    function getIconNameFromEmoji(emoji) {
      // Map emojis to icon names used in the app
      const emojiToIcon = {
        '🖥️': 'cpu', '🔲': 'chip', '🔋': 'battery', '👁️': 'eye',
        '📱': 'smartphone', '📡': 'radio', '🔀': 'git-merge', '💡': 'lightbulb',
        '⚡': 'zap', '📥': 'download', '🌐': 'globe', '📊': 'bar-chart',
        '🔄': 'refresh-cw', '📁': 'folder', '🏭': 'factory', '🔌': 'power',
        '🚛': 'truck', '🤝': 'users', '🥉': 'database', '🥈': 'database',
        '🥇': 'database', '💾': 'hard-drive', '📚': 'book', '🎯': 'target',
        '📋': 'clipboard', '✅': 'check-circle', '🔗': 'link', '🔐': 'lock',
        '🌊': 'droplet', '🔧': 'wrench', '📈': 'trending-up', '⏱️': 'clock',
        '🧠': 'brain', '🤖': 'cpu', '🔍': 'search', '🔮': 'eye',
        '💬': 'message-circle', '📝': 'edit', '⚖️': 'sliders',
        '📲': 'smartphone', '👤': 'user', '🚗': 'car', '🎛️': 'sliders',
        '🏢': 'building', '🗺️': 'map', '🌤️': 'cloud', '🚦': 'alert-circle',
        '🛡️': 'shield', '📜': 'file-text'
      };
      return emojiToIcon[emoji] || 'box';
    }

    // State fuer ausgewaehlte Use Cases in System View
    let selectedSystemUseCases = new Set();

    function renderSystemView() {
      // Initial alle Use Cases auswaehlen
      if (selectedSystemUseCases.size === 0 && state.useCases.length > 0) {
        state.useCases.forEach(uc => selectedSystemUseCases.add(uc.id));
      }

      // Gefilterte Use Cases basierend auf Auswahl
      const filteredUseCases = state.useCases.filter(uc => selectedSystemUseCases.has(uc.id));

      // Stats berechnen (nur von ausgewaehlten Use Cases)
      const totalUseCases = state.useCases.length;
      const selectedCount = filteredUseCases.length;
      let totalConnections = 0;
      let totalRequirements = 0;
      let completedRequirements = 0;

      // Unique Blocks sammeln mit Positionen
      const uniqueBlocksMap = new Map();

      filteredUseCases.forEach(uc => {
        const blockElements = uc.elements?.filter(e => e.type !== 'container') || [];
        totalConnections += (uc.connections || []).length;

        blockElements.forEach(element => {
          const block = state.blocks.find(b => b.id === element.blockId);
          if (block && !uniqueBlocksMap.has(block.id)) {
            uniqueBlocksMap.set(block.id, {
              block: block,
              useCases: [],
              positions: []
            });
          }
          if (block && uniqueBlocksMap.has(block.id)) {
            const entry = uniqueBlocksMap.get(block.id);
            if (!entry.useCases.includes(uc.name)) {
              entry.useCases.push(uc.name);
            }
            entry.positions.push({ x: element.x, y: element.y });
          }
        });
      });

      // Stats aus unique Blocks berechnen
      uniqueBlocksMap.forEach(entry => {
        if (entry.block.requirements) {
          totalRequirements += entry.block.requirements.length;
          completedRequirements += entry.block.requirements.filter(r => r.checked).length;
        }
      });

      const reqPercentage = totalRequirements > 0 ? Math.round((completedRequirements / totalRequirements) * 100) : 0;

      // Stats rendern
      document.getElementById('systemViewStats').innerHTML = `
        <div class="system-view-stat">
          <div class="system-view-stat-value">${selectedCount}/${totalUseCases}</div>
          <div class="system-view-stat-label">Use Cases</div>
        </div>
        <div class="system-view-stat">
          <div class="system-view-stat-value">${uniqueBlocksMap.size}</div>
          <div class="system-view-stat-label">Komponenten</div>
        </div>
        <div class="system-view-stat">
          <div class="system-view-stat-value">${totalConnections}</div>
          <div class="system-view-stat-label">Verbindungen</div>
        </div>
        <div class="system-view-stat">
          <div class="system-view-stat-value">${reqPercentage}%</div>
          <div class="system-view-stat-label">Anforderungen</div>
        </div>
      `;

      const content = document.getElementById('systemViewContent');

      if (totalUseCases === 0) {
        content.innerHTML = `
          <div class="system-view-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 15px; opacity: 0.4;">
              <rect x="3" y="3" width="7" height="7"/>
              <rect x="14" y="3" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/>
              <rect x="3" y="14" width="7" height="7"/>
            </svg>
            <div>Keine Use Cases vorhanden</div>
            <div style="font-size: 12px; margin-top: 5px;">Erstelle Use Cases um das System zu bewerten</div>
          </div>
        `;
        return;
      }

      // Canvas mit allen Bloecken als visuelles Diagramm
      let canvasHTML = '';
      if (uniqueBlocksMap.size > 0) {
        // Bloecke nach Kategorie gruppieren
        const blocksByCategory = new Map();
        uniqueBlocksMap.forEach(entry => {
          const catId = entry.block.categoryId || 'none';
          if (!blocksByCategory.has(catId)) {
            blocksByCategory.set(catId, []);
          }
          blocksByCategory.get(catId).push(entry);
        });

        // Positionen berechnen fuer Grid-Layout
        const blockWidth = 130;
        const blockHeight = 70;
        const gapX = 20;
        const gapY = 30;
        const startX = 30;
        let currentY = 30;

        let blocksInCanvas = '';
        let totalWidth = 0;
        let totalHeight = 0;

        blocksByCategory.forEach((entries, catId) => {
          const cat = state.categories.find(c => c.id === catId);
          const catName = cat?.name || 'Sonstige';

          // Kategorie-Header
          blocksInCanvas += `
            <div style="position: absolute; left: ${startX}px; top: ${currentY}px;
                        font-size: 11px; font-weight: 600; color: #999; text-transform: uppercase; letter-spacing: 0.5px;">
              ${catName}
            </div>
          `;
          currentY += 25;

          // Bloecke in dieser Kategorie
          let col = 0;
          const maxCols = 8;
          entries.forEach((entry, idx) => {
            const x = startX + (col * (blockWidth + gapX));
            const y = currentY;

            const reqCount = entry.block.requirements?.length || 0;
            const reqDone = entry.block.requirements?.filter(r => r.checked).length || 0;
            const reqColor = reqCount === 0 ? '#ccc' : (reqDone === reqCount ? '#0d9a0d' : '#666');

            blocksInCanvas += `
              <div class="system-view-canvas-block" style="left: ${x}px; top: ${y}px;">
                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 110px;">${entry.block.name}</span>
                <span class="system-view-canvas-block-cat">${reqDone}/${reqCount} Anf.</span>
              </div>
            `;

            totalWidth = Math.max(totalWidth, x + blockWidth + 30);
            totalHeight = Math.max(totalHeight, y + blockHeight + 30);

            col++;
            if (col >= maxCols) {
              col = 0;
              currentY += blockHeight + gapY;
            }
          });

          // Naechste Kategorie
          currentY += blockHeight + gapY + 20;
        });

        // Skalierung berechnen
        const canvasViewWidth = 1500;
        const canvasViewHeight = 400;
        const scaleX = canvasViewWidth / Math.max(totalWidth, 1);
        const scaleY = canvasViewHeight / Math.max(totalHeight, 1);
        const scale = Math.min(scaleX, scaleY, 1);

        canvasHTML = `
          <div class="system-view-canvas-wrapper">
            <div class="system-view-canvas" id="systemViewCanvas">
              <div class="system-view-canvas-inner" style="transform: scale(${scale}); width: ${totalWidth}px; height: ${totalHeight}px;">
                ${blocksInCanvas}
              </div>
            </div>
          </div>
        `;
      } else {
        canvasHTML = `
          <div class="system-view-canvas-wrapper">
            <div class="system-view-empty" style="padding: 60px;">
              <div style="color: #999;">Keine Komponenten in den ausgewaehlten Use Cases</div>
            </div>
          </div>
        `;
      }

      // Use Cases unten als auswaehlbare Liste
      const useCasesHTML = `
        <div class="system-view-usecases-section">
          <div class="system-view-section-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
            </svg>
            Use Cases (${selectedCount} von ${totalUseCases} ausgewaehlt)
          </div>
          <div class="system-view-usecases">
            ${state.useCases.map(uc => {
              const phase = state.phases.find(p => p.id === uc.phaseId);
              const isSelected = selectedSystemUseCases.has(uc.id);
              const blockCount = uc.elements?.filter(e => e.type !== 'container').length || 0;

              return `
                <div class="system-view-usecase ${isSelected ? 'selected' : ''}" onclick="toggleSystemUseCase(${uc.id})">
                  <div class="system-view-usecase-checkbox">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" width="12" height="12">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                  </div>
                  <div class="system-view-usecase-info">
                    <div class="system-view-usecase-title">${uc.name}</div>
                    <div class="system-view-usecase-meta">${phase?.name || 'Keine Phase'} · ${blockCount} Komponenten</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      content.innerHTML = canvasHTML + useCasesHTML;
    }

    function toggleSystemUseCase(ucId) {
      if (selectedSystemUseCases.has(ucId)) {
        selectedSystemUseCases.delete(ucId);
      } else {
        selectedSystemUseCases.add(ucId);
      }
      renderSystemView();
    }

    // ============== SYSTEM PDF EXPORT ==============
    async function exportSystemPDF() {
      console.log('exportSystemPDF started');

      try {
        // Nur ausgewaehlte Use Cases exportieren
        const selectedUseCases = state.useCases.filter(uc => selectedSystemUseCases.has(uc.id));
        console.log('selectedUseCases:', selectedUseCases.length);

        if (selectedUseCases.length === 0) {
          alert('Keine Use Cases ausgewaehlt.');
          return;
        }

        if (!window.jspdf) {
          alert('PDF Bibliothek nicht geladen. Bitte Seite neu laden.');
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 20;
        const contentWidth = pageWidth - (margin * 2);
        let yPos = margin;

        // Farben
        const colors = {
          darkGray: [51, 51, 51],
          mediumGray: [102, 102, 102],
          lightGray: [153, 153, 153],
          veryLightGray: [245, 245, 245],
          success: [0, 135, 81],
          warning: [255, 170, 0],
          accent: [187, 0, 0]
        };

        // ASCII Konvertierung - gibt immer einen gueltigen String zurueck
        function toASCII(text) {
          if (!text) return '-';
          return String(text)
            .replace(/ä/g, 'ae').replace(/Ä/g, 'Ae')
            .replace(/ö/g, 'oe').replace(/Ö/g, 'Oe')
            .replace(/ü/g, 'ue').replace(/Ü/g, 'Ue')
            .replace(/ß/g, 'ss')
            .replace(/–/g, '-').replace(/—/g, '-')
            .replace(/[^\x00-\x7F]/g, '') || '-';
        }

        function checkNewPage(neededHeight) {
          if (yPos + neededHeight > pageHeight - margin) {
            doc.addPage();
            yPos = margin;
            return true;
          }
          return false;
        }

        // =====================================================
        // === DECKBLATT ===
        // =====================================================

        // Audi Ringe
        doc.setDrawColor(51, 51, 51);
        doc.setLineWidth(0.4);
        const ringRadius = 6;
        const ringSpacing = 9;
        for (let i = 0; i < 4; i++) {
          doc.circle(margin + (i * ringSpacing) + ringRadius, 35, ringRadius, 'S');
        }

        // Titel
        doc.setFontSize(28);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(51, 51, 51);
        doc.text('Data Platform', margin, 60);
        doc.text('System-Dokumentation', margin, 72);

        yPos = 90;

        // Trennlinie
        doc.setDrawColor(153, 153, 153);
        doc.setLineWidth(0.3);
        doc.line(margin, yPos, margin + 60, yPos);
        yPos += 15;

        // System-Statistiken (nur von ausgewaehlten Use Cases)
        const uniqueBlocksMap = new Map();
        let totalConnections = 0;
        let totalRequirements = 0;
        let completedRequirements = 0;

        selectedUseCases.forEach(uc => {
          const blockElements = uc.elements?.filter(e => e.type !== 'container') || [];
          totalConnections += (uc.connections || []).length;
          blockElements.forEach(element => {
            const block = state.blocks.find(b => b.id === element.blockId);
            if (block && !uniqueBlocksMap.has(block.id)) {
              uniqueBlocksMap.set(block.id, block);
            }
          });
        });

        uniqueBlocksMap.forEach(block => {
          if (block.requirements) {
            totalRequirements += block.requirements.length;
            completedRequirements += block.requirements.filter(r => r.checked).length;
          }
        });

        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(102, 102, 102);

        const stats = [
          { label: 'Use Cases', value: String(selectedUseCases.length) },
          { label: 'Komponenten', value: String(uniqueBlocksMap.size) },
          { label: 'Verbindungen', value: String(totalConnections) },
          { label: 'Anforderungen', value: completedRequirements + '/' + totalRequirements }
        ];

        stats.forEach(stat => {
          doc.setFont('helvetica', 'bold');
          doc.text(stat.label + ':', margin, yPos);
          doc.setFont('helvetica', 'normal');
          doc.text(stat.value, margin + 35, yPos);
          yPos += 6;
        });

        // Footer Deckblatt
        doc.setFontSize(8);
        doc.setTextColor(153, 153, 153);
        doc.text('Erstellt am ' + new Date().toLocaleDateString('de-DE'), margin, pageHeight - 15);
        doc.text('Data Platform Builder', pageWidth - margin, pageHeight - 15, { align: 'right' });

        // =====================================================
        // === EXECUTIVE SUMMARY ===
        // =====================================================
        doc.addPage();
        yPos = margin;

        // Header
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(51, 51, 51);
        doc.text('Executive Summary', margin, yPos);
        doc.setDrawColor(153, 153, 153);
        doc.setLineWidth(0.4);
        doc.line(margin, yPos + 2, margin + 50, yPos + 2);
        yPos += 15;

        // KPI Boxes
        const kpiWidth = (contentWidth - 15) / 4;
        const kpiHeight = 28;
        const kpis = [
          { value: String(selectedUseCases.length), label: 'Use Cases' },
          { value: String(uniqueBlocksMap.size), label: 'Komponenten' },
          { value: String(totalConnections), label: 'Verbindungen' },
          { value: Math.round((completedRequirements / Math.max(totalRequirements, 1)) * 100) + '%', label: 'Erfuellung' }
        ];

        kpis.forEach((kpi, i) => {
          const kpiX = margin + (i * (kpiWidth + 5));
          doc.setFillColor(245, 245, 245);
          doc.roundedRect(kpiX, yPos, kpiWidth, kpiHeight, 2, 2, 'F');
          doc.setFontSize(20);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(51, 51, 51);
          doc.text(kpi.value, kpiX + kpiWidth/2, yPos + 14, { align: 'center' });
          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(102, 102, 102);
          doc.text(kpi.label, kpiX + kpiWidth/2, yPos + 22, { align: 'center' });
        });
        yPos += kpiHeight + 15;

        // Kategorien-Statistik
        const categoryStats = {};
        uniqueBlocksMap.forEach(block => {
          const cat = state.categories.find(c => c.id === block.categoryId);
          const catName = cat ? toASCII(cat.name) : 'Sonstige';
          categoryStats[catName] = (categoryStats[catName] || 0) + 1;
        });

        if (Object.keys(categoryStats).length > 0) {
          doc.setFontSize(11);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(51, 51, 51);
          doc.text('Komponenten nach Kategorie', margin, yPos);
          yPos += 8;

          Object.entries(categoryStats).forEach(([catName, count]) => {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(102, 102, 102);
            doc.text(catName, margin + 5, yPos);
            doc.setTextColor(51, 51, 51);
            doc.text(String(count), margin + 80, yPos);
            yPos += 5;
          });
          yPos += 10;
        }

        // Anforderungserfuellung mit Fortschrittsbalken
        if (totalRequirements > 0) {
          doc.setFontSize(11);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(51, 51, 51);
          doc.text('Anforderungserfuellung', margin, yPos);
          yPos += 8;

          const reqPercentage = Math.round((completedRequirements / totalRequirements) * 100);
          const barWidth = 120;
          const barHeight = 10;

          // Hintergrund
          doc.setFillColor(230, 230, 230);
          doc.roundedRect(margin + 5, yPos, barWidth, barHeight, 2, 2, 'F');

          // Fortschritt
          if (reqPercentage > 0) {
            if (reqPercentage === 100) {
              doc.setFillColor(0, 135, 81); // Gruen
            } else if (reqPercentage >= 50) {
              doc.setFillColor(255, 170, 0); // Orange
            } else {
              doc.setFillColor(187, 0, 0); // Rot
            }
            doc.roundedRect(margin + 5, yPos, (barWidth * reqPercentage) / 100, barHeight, 2, 2, 'F');
          }

          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(51, 51, 51);
          doc.text(completedRequirements + '/' + totalRequirements + ' (' + reqPercentage + '%)', margin + barWidth + 12, yPos + 7);
          yPos += 20;
        }

        // Status-Legende
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setFillColor(0, 135, 81);
        doc.circle(margin + 8, yPos, 3, 'F');
        doc.setTextColor(102, 102, 102);
        doc.text('Abgeschlossen (100%)', margin + 15, yPos + 1);

        doc.setFillColor(255, 170, 0);
        doc.circle(margin + 75, yPos, 3, 'F');
        doc.text('In Bearbeitung', margin + 82, yPos + 1);

        doc.setFillColor(230, 230, 230);
        doc.circle(margin + 135, yPos, 3, 'F');
        doc.text('Offen (0%)', margin + 142, yPos + 1);

        // =====================================================
        // === ARCHITEKTUR-UEBERSICHT (farbige Komponenten) ===
        // =====================================================
        if (uniqueBlocksMap.size > 0) {
          doc.addPage();
          yPos = margin;

          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(51, 51, 51);
          doc.text('Architektur-Uebersicht', margin, yPos);
          doc.setDrawColor(153, 153, 153);
          doc.setLineWidth(0.4);
          doc.line(margin, yPos + 2, margin + 55, yPos + 2);
          yPos += 8;

          doc.setFontSize(9);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(102, 102, 102);
          doc.text(uniqueBlocksMap.size + ' Komponenten - farbcodiert nach Anforderungserfuellung', margin, yPos);
          yPos += 12;

          // Komponenten als Grid mit Farbcodierung
          const blockWidth = 52;
          const blockHeight = 28;
          const blocksPerRow = 3;
          const gapX = 7;
          const gapY = 8;
          let col = 0;
          let rowStartY = yPos;

          Array.from(uniqueBlocksMap.values()).forEach((block, idx) => {
            const reqCount = block.requirements?.length || 0;
            const reqDone = block.requirements?.filter(r => r.checked).length || 0;
            const cat = state.categories.find(c => c.id === block.categoryId);

            // Neue Seite wenn noetig
            if (yPos + blockHeight > pageHeight - margin - 10) {
              doc.addPage();
              yPos = margin + 10;
              rowStartY = yPos;
              col = 0;
            }

            const blockX = margin + (col * (blockWidth + gapX));
            const blockY = rowStartY;

            // Farbcodierung basierend auf Anforderungen
            if (reqCount === 0) {
              // Keine Anforderungen - grau
              doc.setFillColor(240, 240, 240);
              doc.setDrawColor(200, 200, 200);
            } else if (reqDone === reqCount) {
              // Alle erledigt - gruen
              doc.setFillColor(232, 245, 233);
              doc.setDrawColor(0, 135, 81);
            } else if (reqDone > 0) {
              // In Bearbeitung - orange
              doc.setFillColor(255, 243, 224);
              doc.setDrawColor(255, 170, 0);
            } else {
              // Nichts erledigt - rot/grau
              doc.setFillColor(255, 235, 238);
              doc.setDrawColor(187, 0, 0);
            }

            doc.setLineWidth(1.5);
            doc.roundedRect(blockX, blockY, blockWidth, blockHeight, 3, 3, 'FD');

            // Block Name
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(51, 51, 51);
            const blockName = toASCII(block.name);
            const truncName = blockName.length > 18 ? blockName.substring(0, 16) + '..' : blockName;
            doc.text(truncName, blockX + blockWidth/2, blockY + 10, { align: 'center' });

            // Kategorie
            if (cat) {
              doc.setFontSize(6);
              doc.setFont('helvetica', 'normal');
              doc.setTextColor(120, 120, 120);
              const catName = toASCII(cat.name);
              const truncCat = catName.length > 20 ? catName.substring(0, 18) + '..' : catName;
              doc.text(truncCat, blockX + blockWidth/2, blockY + 16, { align: 'center' });
            }

            // Anforderungen Status
            doc.setFontSize(7);
            if (reqCount === 0) {
              doc.setTextColor(150, 150, 150);
              doc.text('keine Anf.', blockX + blockWidth/2, blockY + 23, { align: 'center' });
            } else {
              if (reqDone === reqCount) {
                doc.setTextColor(0, 135, 81);
              } else if (reqDone > 0) {
                doc.setTextColor(200, 130, 0);
              } else {
                doc.setTextColor(187, 0, 0);
              }
              doc.text(reqDone + '/' + reqCount + ' Anf.', blockX + blockWidth/2, blockY + 23, { align: 'center' });
            }

            col++;
            if (col >= blocksPerRow) {
              col = 0;
              rowStartY += blockHeight + gapY;
              yPos = rowStartY;
            }
          });

          // Nach Grid yPos aktualisieren
          if (col > 0) {
            yPos = rowStartY + blockHeight + gapY;
          }
        }

        // =====================================================
        // === KOMPONENTEN DETAILLIERT ===
        // =====================================================
        if (uniqueBlocksMap.size > 0) {
          doc.addPage();
          yPos = margin;

          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(51, 51, 51);
          doc.text('Komponenten-Details', margin, yPos);
          doc.setDrawColor(153, 153, 153);
          doc.setLineWidth(0.4);
          doc.line(margin, yPos + 2, margin + 52, yPos + 2);
          yPos += 12;

          Array.from(uniqueBlocksMap.values()).forEach((block, idx) => {
            const cat = state.categories.find(c => c.id === block.categoryId);
            const reqCount = block.requirements?.length || 0;
            const reqDone = block.requirements?.filter(r => r.checked).length || 0;

            checkNewPage(28);

            // Status-Farbe links
            if (reqCount === 0) {
              doc.setFillColor(200, 200, 200);
            } else if (reqDone === reqCount) {
              doc.setFillColor(0, 135, 81);
            } else if (reqDone > 0) {
              doc.setFillColor(255, 170, 0);
            } else {
              doc.setFillColor(187, 0, 0);
            }
            doc.rect(margin, yPos - 3, 3, 20, 'F');

            // Block Box
            doc.setFillColor(250, 250, 250);
            doc.roundedRect(margin + 5, yPos - 3, contentWidth - 5, 20, 2, 2, 'F');

            // Nummer
            doc.setFontSize(8);
            doc.setTextColor(153, 153, 153);
            doc.text(String(idx + 1), margin + 8, yPos + 3);

            // Name
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(51, 51, 51);
            doc.text(toASCII(block.name), margin + 16, yPos + 3);

            // Kategorie
            if (cat) {
              doc.setFontSize(8);
              doc.setFont('helvetica', 'normal');
              doc.setTextColor(153, 153, 153);
              doc.text(toASCII(cat.name), pageWidth - margin - 5, yPos + 3, { align: 'right' });
            }

            // Anforderungen Status
            if (reqCount > 0) {
              doc.setFontSize(8);
              if (reqDone === reqCount) {
                doc.setTextColor(0, 135, 81);
              } else if (reqDone > 0) {
                doc.setTextColor(200, 130, 0);
              } else {
                doc.setTextColor(187, 0, 0);
              }
              doc.text(reqDone + '/' + reqCount + ' Anforderungen', margin + 16, yPos + 10);
            }

            // Beschreibung
            if (block.description) {
              doc.setFontSize(8);
              doc.setFont('helvetica', 'normal');
              doc.setTextColor(102, 102, 102);
              const descLines = doc.splitTextToSize(toASCII(block.description), contentWidth - 25);
              if (descLines.length > 2) descLines.length = 2;
              doc.text(descLines, margin + 16, yPos + 14);
            }

            yPos += 24;
          });
        }

        // =====================================================
        // === USE CASE SEITEN ===
        // =====================================================

        for (let ucIndex = 0; ucIndex < selectedUseCases.length; ucIndex++) {
          const uc = selectedUseCases[ucIndex];
          const phase = state.phases.find(p => p.id === uc.phaseId);
          const blocks = uc.elements?.filter(e => e.type !== 'container') || [];
          const containers = uc.elements?.filter(e => e.type === 'container') || [];
          const connections = uc.connections || [];

          // Neue Seite fuer jeden Use Case
          doc.addPage();
          yPos = margin;

          // Use Case Header
          doc.setFillColor(245, 245, 245);
          doc.roundedRect(margin, yPos - 5, contentWidth, 20, 2, 2, 'F');

          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(51, 51, 51);
          doc.text((ucIndex + 1) + '. ' + toASCII(uc.name), margin + 5, yPos + 5);

          doc.setFontSize(9);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(102, 102, 102);
          doc.text(phase ? toASCII(phase.name) : 'Keine Phase', pageWidth - margin - 5, yPos + 5, { align: 'right' });

          yPos += 22;

          // Beschreibung
          if (uc.description) {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(102, 102, 102);
            const descLines = doc.splitTextToSize(toASCII(uc.description), contentWidth);
            doc.text(descLines, margin, yPos);
            yPos += descLines.length * 4 + 5;
          }

          // Komponenten-Liste (ohne Screenshot - einfacher und schneller)
          if (blocks.length > 0) {
            checkNewPage(30);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(51, 51, 51);
            doc.text('Komponenten (' + blocks.length + ')', margin, yPos);
            yPos += 6;

            blocks.forEach((element, idx) => {
              const block = state.blocks.find(b => b.id === element.blockId);
              if (!block) return;

              checkNewPage(12);
              const cat = state.categories.find(c => c.id === block.categoryId);

              doc.setFontSize(9);
              doc.setFont('helvetica', 'normal');
              doc.setTextColor(51, 51, 51);
              doc.text((idx + 1) + '. ' + toASCII(block.name), margin + 5, yPos);

              if (cat) {
                doc.setFontSize(7);
                doc.setTextColor(153, 153, 153);
                doc.text('[' + toASCII(cat.name) + ']', margin + 60, yPos);
              }

              // Anforderungen zaehlen
              const reqCount = block.requirements?.length || 0;
              const reqDone = block.requirements?.filter(r => r.checked).length || 0;
              if (reqCount > 0) {
                doc.setFontSize(7);
                if (reqDone === reqCount) {
                  doc.setTextColor(0, 135, 81);
                } else {
                  doc.setTextColor(102, 102, 102);
                }
                doc.text(reqDone + '/' + reqCount, pageWidth - margin - 5, yPos, { align: 'right' });
              }

              yPos += 5;
            });
            yPos += 5;
          }

          // Verbindungen
          if (connections.length > 0) {
            checkNewPage(20);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(51, 51, 51);
            doc.text('Datenfluesse (' + connections.length + ')', margin, yPos);
            yPos += 6;

            connections.slice(0, 10).forEach(conn => {
              checkNewPage(5);

              const fromEl = uc.elements.find(e => e.id === conn.from);
              const toEl = uc.elements.find(e => e.id === conn.to);

              let fromName = 'Unbekannt', toName = 'Unbekannt';
              if (fromEl) {
                if (fromEl.type === 'container') fromName = fromEl.name || 'Container';
                else fromName = state.blocks.find(b => b.id === fromEl.blockId)?.name || 'Block';
              }
              if (toEl) {
                if (toEl.type === 'container') toName = toEl.name || 'Container';
                else toName = state.blocks.find(b => b.id === toEl.blockId)?.name || 'Block';
              }

              doc.setFontSize(8);
              doc.setTextColor(102, 102, 102);
              doc.text(toASCII(fromName) + ' --> ' + toASCII(toName), margin + 5, yPos);
              yPos += 4;
            });

            if (connections.length > 10) {
              doc.setFontSize(7);
              doc.setTextColor(153, 153, 153);
              doc.text('... und ' + (connections.length - 10) + ' weitere', margin + 5, yPos);
              yPos += 4;
            }
          }
        }

        // =====================================================
        // === FOOTER AUF ALLEN SEITEN ===
        // =====================================================
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(153, 153, 153);
          doc.text(i + ' / ' + totalPages, pageWidth / 2, pageHeight - 10, { align: 'center' });
        }

        // Speichern
        doc.save('System_Dokumentation.pdf');
        console.log('PDF saved successfully');

        // Canvas wiederherstellen
        if (state.currentUseCase) {
          renderCanvas();
        }
      } catch (error) {
        console.error('PDF Export Error:', error);
        alert('Fehler beim PDF Export: ' + error.message);
      }
    }

    // ============== PDF EXPORT ==============
    async function exportUseCaseToPDF() {
      if (!state.currentUseCase) {
        alert('Bitte wähle zuerst einen Use Case aus.');
        return;
      }

      const uc = state.currentUseCase;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');

      const pageWidth = 210;
      const pageHeight = 297;
      const margin = 20;
      const contentWidth = pageWidth - (margin * 2);
      let yPos = margin;

      // Audi-inspirierte Farben (dezent, professionell)
      const colors = {
        black: [0, 0, 0],
        darkGray: [51, 51, 51],
        mediumGray: [102, 102, 102],
        lightGray: [153, 153, 153],
        veryLightGray: [245, 245, 245],
        accent: [187, 0, 0], // Audi Rot dezent
        success: [0, 135, 81],
        warning: [255, 170, 0]
      };

      // Helper: Konvertiere Umlaute zu ASCII (jsPDF kann keine Unicode)
      function toASCII(text) {
        if (!text) return '';
        return text
          .replace(/ä/g, 'ae').replace(/Ä/g, 'Ae')
          .replace(/ö/g, 'oe').replace(/Ö/g, 'Oe')
          .replace(/ü/g, 'ue').replace(/Ü/g, 'Ue')
          .replace(/ß/g, 'ss')
          .replace(/–/g, '-').replace(/—/g, '-')
          .replace(/→/g, '->').replace(/←/g, '<-')
          .replace(/[^\x00-\x7F]/g, ''); // Entferne alle anderen Non-ASCII
      }

      // Helper: Text mit automatischem Umbruch
      function addWrappedText(text, x, y, maxWidth, lineHeight = 4.5) {
        const lines = doc.splitTextToSize(toASCII(text), maxWidth);
        doc.text(lines, x, y);
        return y + (lines.length * lineHeight);
      }

      // Helper: Neue Seite wenn nötig
      function checkNewPage(neededHeight) {
        if (yPos + neededHeight > pageHeight - margin) {
          doc.addPage();
          yPos = margin;
          addPageHeader();
          return true;
        }
        return false;
      }

      // Helper: Seiten-Header (fuer Folgeseiten)
      function addPageHeader() {
        doc.setDrawColor(...colors.lightGray);
        doc.setLineWidth(0.3);
        doc.line(margin, 12, pageWidth - margin, 12);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...colors.lightGray);
        doc.text(toASCII(uc.name), margin, 10);
        doc.text('Data Platform Builder', pageWidth - margin, 10, { align: 'right' });
        doc.setTextColor(0);
        yPos = 20;
      }

      // Helper: Section Header (kompakte Abstände)
      function addSectionHeader(title, subtitle = null) {
        checkNewPage(20);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...colors.darkGray);
        doc.text(title, margin, yPos);

        // Dezente Unterlinie
        doc.setDrawColor(...colors.lightGray);
        doc.setLineWidth(0.4);
        doc.line(margin, yPos + 1.5, margin + doc.getTextWidth(title), yPos + 1.5);

        if (subtitle) {
          yPos += 5;
          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...colors.mediumGray);
          doc.text(subtitle, margin, yPos);
        }

        doc.setTextColor(0);
        yPos += 6;
      }

      // =====================================================
      // === SEITE 1: DECKBLATT ===
      // =====================================================

      // Audi Ringe (elegant, dünn)
      doc.setDrawColor(...colors.darkGray);
      doc.setLineWidth(0.4);
      const ringRadius = 6;
      const ringSpacing = 9;
      const ringsStartX = margin;
      const ringsY = 35;
      for (let i = 0; i < 4; i++) {
        doc.circle(ringsStartX + (i * ringSpacing) + ringRadius, ringsY, ringRadius, 'S');
      }

      // Titel
      doc.setFontSize(28);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...colors.darkGray);
      const titleLines = doc.splitTextToSize(toASCII(uc.name), contentWidth);
      doc.text(titleLines, margin, 60);

      const titleHeight = titleLines.length * 10;
      yPos = 60 + titleHeight + 5;

      // Untertitel
      doc.setFontSize(12);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...colors.mediumGray);
      doc.text('Use Case Dokumentation', margin, yPos);
      yPos += 15;

      // Elegante Trennlinie
      doc.setDrawColor(...colors.lightGray);
      doc.setLineWidth(0.3);
      doc.line(margin, yPos, margin + 60, yPos);
      yPos += 15;

      // Meta-Informationen Box
      const phase = state.phases.find(p => p.id === uc.phaseId);
      const statusLabels = {
        draft: 'Entwurf',
        defined: 'Definiert',
        'in-progress': 'In Umsetzung',
        done: 'Abgeschlossen'
      };
      const priorityLabels = {
        'prio-1': 'Prioritaet 1 - Must Have',
        'prio-2': 'Prioritaet 2 - Should Have',
        'prio-3': 'Prioritaet 3 - Nice to Have'
      };

      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...colors.mediumGray);

      const metaItems = [
        { label: 'Phase', value: toASCII(phase?.name) || 'Nicht zugeordnet' },
        { label: 'Status', value: statusLabels[uc.status] || uc.status },
        { label: 'Prioritaet', value: priorityLabels[uc.priority] || 'Nicht definiert' },
        { label: 'Owner', value: toASCII(uc.owner) || 'Nicht zugewiesen' }
      ];

      metaItems.forEach(item => {
        doc.setFont('helvetica', 'bold');
        doc.text(item.label + ':', margin, yPos);
        doc.setFont('helvetica', 'normal');
        doc.text(toASCII(item.value), margin + 25, yPos);
        yPos += 6;
      });

      yPos += 10;

      // Beschreibung
      if (uc.description) {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...colors.darkGray);
        yPos = addWrappedText(uc.description, margin, yPos, contentWidth, 5);
        yPos += 10;
      }

      // Business Value
      if (uc.businessValue) {
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...colors.mediumGray);
        doc.text('Business Value', margin, yPos);
        yPos += 5;
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...colors.darkGray);
        yPos = addWrappedText(uc.businessValue, margin, yPos, contentWidth, 4.5);
      }

      // Footer auf Deckblatt
      doc.setFontSize(8);
      doc.setTextColor(...colors.lightGray);
      doc.text(`Erstellt am ${new Date().toLocaleDateString('de-DE')}`, margin, pageHeight - 15);
      doc.text('Data Platform Builder', pageWidth - margin, pageHeight - 15, { align: 'right' });

      // =====================================================
      // === SEITE 2: ARCHITEKTUR-DIAGRAMM (VOLLBILD) ===
      // =====================================================
      doc.addPage();
      yPos = margin;

      addSectionHeader('Architektur-Uebersicht', 'Vollstaendige Systemarchitektur des Use Cases');

      // Canvas Screenshot erstellen - VOLLSTÄNDIG unabhängig vom Zoom
      try {
        if (uc.elements && uc.elements.length > 0) {
          // Speichere aktuellen Zoom
          const originalZoom = canvasZoom;

          // Berechne Bounding Box aller Elemente
          let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
          uc.elements.forEach(element => {
            if (element.type === 'block') {
              minX = Math.min(minX, element.x);
              minY = Math.min(minY, element.y);
              maxX = Math.max(maxX, element.x + 120);
              maxY = Math.max(maxY, element.y + 60);
            } else if (element.type === 'container') {
              minX = Math.min(minX, element.x);
              minY = Math.min(minY, element.y);
              maxX = Math.max(maxX, element.x + element.width);
              maxY = Math.max(maxY, element.y + element.height);
            }
          });

          // Setze Zoom auf 100% für Screenshot
          setCanvasZoom(1);

          // Warte kurz auf Render
          await new Promise(resolve => setTimeout(resolve, 100));

          const canvasEl = document.getElementById('canvas');
          if (canvasEl) {
            // Berechne den Bereich der zu erfassen ist
            const padding = 40;
            const captureX = Math.max(0, minX - padding);
            const captureY = Math.max(0, minY - padding);
            const captureWidth = (maxX - minX) + (padding * 2);
            const captureHeight = (maxY - minY) + (padding * 2);

            const screenshot = await html2canvas(canvasEl, {
              backgroundColor: '#ffffff',
              scale: 1.5, // Reduziert fuer kleinere Dateigroesse
              x: captureX,
              y: captureY,
              width: captureWidth,
              height: captureHeight,
              scrollX: 0,
              scrollY: 0
            });

            // Zoom zuruecksetzen
            setCanvasZoom(originalZoom);

            // JPEG mit Komprimierung statt PNG (viel kleiner)
            const imgData = screenshot.toDataURL('image/jpeg', 0.7);

            // Berechne optimale Groesse fuer PDF (mit Abstand unten)
            const availableWidth = contentWidth;
            const availableHeight = pageHeight - yPos - margin - 45; // Deutlich mehr Platz unten

            const imgAspect = screenshot.width / screenshot.height;
            const pageAspect = availableWidth / availableHeight;

            let finalWidth, finalHeight;
            if (imgAspect > pageAspect) {
              // Breiter als hoch - an Breite anpassen
              finalWidth = availableWidth;
              finalHeight = availableWidth / imgAspect;
            } else {
              // Höher als breit - an Höhe anpassen
              finalHeight = availableHeight;
              finalWidth = availableHeight * imgAspect;
            }

            // Zentrieren
            const imgX = margin + (availableWidth - finalWidth) / 2;

            // Dezenter Rahmen
            doc.setDrawColor(...colors.lightGray);
            doc.setLineWidth(0.3);
            doc.roundedRect(imgX - 2, yPos - 2, finalWidth + 4, finalHeight + 4, 2, 2, 'S');

            doc.addImage(imgData, 'JPEG', imgX, yPos, finalWidth, finalHeight);
            yPos += finalHeight + 15;
          }
        } else {
          doc.setFontSize(10);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...colors.lightGray);
          doc.text('Keine Architektur-Elemente vorhanden.', margin, yPos);
          yPos += 15;
        }
      } catch (err) {
        console.error('Screenshot error:', err);
        doc.setFontSize(10);
        doc.setTextColor(...colors.mediumGray);
        doc.text('Diagramm konnte nicht erstellt werden.', margin, yPos);
        yPos += 15;
      }

      // Daten fuer alle folgenden Seiten vorbereiten
      const blocks = uc.elements?.filter(e => e.type !== 'container') || [];
      const containers = uc.elements?.filter(e => e.type === 'container') || [];
      const connections = uc.connections || [];

      // =====================================================
      // === SEITE 3: EXECUTIVE SUMMARY ===
      // =====================================================
      doc.addPage();
      yPos = margin;
      addPageHeader();

      addSectionHeader('Executive Summary', 'Zusammenfassung und Kennzahlen');

      // Statistiken
      const totalBlocks = blocks.length;
      const totalContainers = containers.length;
      const totalConnections = connections.length;

      // KPI Boxes
      const kpiWidth = (contentWidth - 10) / 3;
      const kpiHeight = 25;
      const kpis = [
        { value: totalBlocks, label: 'Komponenten' },
        { value: totalContainers, label: 'Container' },
        { value: totalConnections, label: 'Verbindungen' }
      ];

      kpis.forEach((kpi, i) => {
        const kpiX = margin + (i * (kpiWidth + 5));
        doc.setFillColor(...colors.veryLightGray);
        doc.roundedRect(kpiX, yPos, kpiWidth, kpiHeight, 2, 2, 'F');
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...colors.darkGray);
        doc.text(String(kpi.value), kpiX + kpiWidth/2, yPos + 12, { align: 'center' });
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...colors.mediumGray);
        doc.text(kpi.label, kpiX + kpiWidth/2, yPos + 20, { align: 'center' });
      });

      yPos += kpiHeight + 12;

      // Kategorien
      const categoryStats = {};
      blocks.forEach(element => {
        const block = state.blocks.find(b => b.id === element.blockId);
        if (block) {
          const cat = state.categories.find(c => c.id === block.categoryId);
          const catName = toASCII(cat?.name) || 'Unbekannt';
          categoryStats[catName] = (categoryStats[catName] || 0) + 1;
        }
      });

      if (Object.keys(categoryStats).length > 0) {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...colors.darkGray);
        doc.text('Komponenten nach Kategorie', margin, yPos);
        yPos += 6;
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        Object.entries(categoryStats).forEach(([catName, count]) => {
          doc.setTextColor(...colors.mediumGray);
          doc.text(catName, margin + 5, yPos);
          doc.setTextColor(...colors.darkGray);
          doc.text(String(count), margin + 80, yPos);
          yPos += 5;
        });
        yPos += 6;
      }

      // Anforderungserfuellung
      let totalRequirements = 0;
      let completedRequirements = 0;
      blocks.forEach(element => {
        const block = state.blocks.find(b => b.id === element.blockId);
        if (block?.requirements) {
          totalRequirements += block.requirements.length;
          completedRequirements += block.requirements.filter(r => r.checked).length;
        }
      });

      if (totalRequirements > 0) {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...colors.darkGray);
        doc.text('Anforderungserfuellung', margin, yPos);
        yPos += 6;
        const reqPercentage = Math.round((completedRequirements / totalRequirements) * 100);
        const barWidth = 100;
        const barHeight = 8;
        doc.setFillColor(230, 230, 230);
        doc.roundedRect(margin + 5, yPos, barWidth, barHeight, 2, 2, 'F');
        if (reqPercentage > 0) {
          const fillColor = reqPercentage === 100 ? colors.success :
                           reqPercentage >= 50 ? colors.warning : colors.accent;
          doc.setFillColor(...fillColor);
          doc.roundedRect(margin + 5, yPos, (barWidth * reqPercentage) / 100, barHeight, 2, 2, 'F');
        }
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...colors.darkGray);
        doc.text(`${completedRequirements}/${totalRequirements} (${reqPercentage}%)`, margin + barWidth + 10, yPos + 6);
      }

      // =====================================================
      // === SEITE 4+: KOMPONENTEN DETAILLIERT ===
      // =====================================================
      if (blocks.length > 0) {
        doc.addPage();
        yPos = margin;
        addPageHeader();

        addSectionHeader('Komponenten', `${blocks.length} Komponenten in dieser Architektur`);

        blocks.forEach((element, index) => {
          const block = state.blocks.find(b => b.id === element.blockId);
          if (!block) return;

          const cat = state.categories.find(c => c.id === block.categoryId);

          // Berechne benoetigte Hoehe fuer die gesamte Box
          const blockDesc = toASCII(block.description || '');
          const descLines = blockDesc ? doc.splitTextToSize(blockDesc, contentWidth - 25) : [];
          const reqCount = block.requirements?.length || 0;

          // Box-Hoehe: Header(15) + Beschreibung + Anforderungen-Header(8) + Anforderungen + Padding
          let boxHeight = 18; // Basis fuer Header
          if (descLines.length > 0) {
            boxHeight += descLines.length * 4.5 + 4;
          }
          if (reqCount > 0) {
            boxHeight += 10 + (reqCount * 5.5); // Header + Anforderungen
          }
          boxHeight += 5; // Padding unten

          checkNewPage(boxHeight + 10);

          const boxStartY = yPos - 3;

          // Komponenten-Box zeichnen
          doc.setFillColor(...colors.veryLightGray);
          doc.setDrawColor(...colors.lightGray);
          doc.setLineWidth(0.3);
          doc.roundedRect(margin, boxStartY, contentWidth, boxHeight, 2, 2, 'FD');

          // Nummer-Badge (dezent, kleiner)
          doc.setFillColor(...colors.mediumGray);
          doc.circle(margin + 6, yPos + 4, 3.5, 'F');
          doc.setFontSize(7);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(255, 255, 255);
          doc.text(String(index + 1), margin + 6, yPos + 5.2, { align: 'center' });
          doc.setTextColor(0);

          // Name
          doc.setFontSize(11);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(...colors.darkGray);
          doc.text(toASCII(block.name), margin + 14, yPos + 5);

          // Kategorie-Tag (rechtsbuendig)
          if (cat) {
            const catText = toASCII(cat.name);
            doc.setFontSize(7);
            const catWidth = doc.getTextWidth(catText) + 6;
            const catX = pageWidth - margin - catWidth - 5;
            doc.setFillColor(220, 220, 220);
            doc.roundedRect(catX, yPos + 0.5, catWidth, 7, 1, 1, 'F');
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...colors.mediumGray);
            doc.text(catText, catX + catWidth/2, yPos + 5, { align: 'center' });
          }

          yPos += 14;

          // Beschreibung (innerhalb Box)
          if (descLines.length > 0) {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...colors.mediumGray);
            doc.text(descLines, margin + 8, yPos);
            yPos += descLines.length * 4.5 + 4;
          }

          // Anforderungen (innerhalb Box)
          if (block.requirements && block.requirements.length > 0) {
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...colors.mediumGray);
            doc.text('Anforderungen:', margin + 8, yPos);
            yPos += 5;

            doc.setFont('helvetica', 'normal');
            block.requirements.forEach(req => {
              // Status-Indikator
              if (req.checked) {
                doc.setFillColor(...colors.success);
              } else {
                doc.setFillColor(...colors.lightGray);
              }
              doc.circle(margin + 12, yPos - 1, 1.5, 'F');

              doc.setFontSize(8);
              doc.setTextColor(...colors.darkGray);
              const reqText = toASCII(req.text || '');
              const truncated = reqText.length > 80 ? reqText.substring(0, 77) + '...' : reqText;
              doc.text(truncated, margin + 17, yPos);
              yPos += 5.5;
            });
          }

          // Position nach der Box
          yPos = boxStartY + boxHeight + 6;
        });
      }

      // === CONTAINER ===
      if (containers.length > 0) {
        checkNewPage(40);
        addSectionHeader('Container / Bereiche', `${containers.length} logische Gruppierungen`);

        containers.forEach((container, index) => {
          checkNewPage(20);

          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(...colors.darkGray);
          doc.text(`${index + 1}. ${toASCII(container.name) || 'Container'}`, margin, yPos);
          yPos += 5;

          if (container.description) {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...colors.mediumGray);
            yPos = addWrappedText(container.description, margin + 8, yPos, contentWidth - 12, 4);
          }
          yPos += 6;
        });
      }

      // === VERBINDUNGEN ===
      if (connections.length > 0) {
        checkNewPage(40);
        addSectionHeader('Datenfluesse', `${connections.length} Verbindungen zwischen Komponenten`);

        // Gruppiere Verbindungen nach Quell-Kategorie
        const flowsBySource = {};
        connections.forEach(conn => {
          const fromElement = uc.elements.find(e => e.id === conn.from);
          const toElement = uc.elements.find(e => e.id === conn.to);

          let fromName = 'Unbekannt', toName = 'Unbekannt';
          let fromCat = 'System';

          if (fromElement) {
            if (fromElement.type === 'container') {
              fromName = toASCII(fromElement.name) || 'Container';
              fromCat = 'Container';
            } else {
              const block = state.blocks.find(b => b.id === fromElement.blockId);
              fromName = toASCII(block?.name) || 'Block';
              const cat = state.categories.find(c => c.id === block?.categoryId);
              fromCat = toASCII(cat?.name) || 'System';
            }
          }

          if (toElement) {
            if (toElement.type === 'container') {
              toName = toASCII(toElement.name) || 'Container';
            } else {
              const block = state.blocks.find(b => b.id === toElement.blockId);
              toName = toASCII(block?.name) || 'Block';
            }
          }

          if (!flowsBySource[fromCat]) flowsBySource[fromCat] = [];
          flowsBySource[fromCat].push({ from: fromName, to: toName });
        });

        // Ausgabe nach Kategorien
        Object.entries(flowsBySource).forEach(([sourceCat, flows]) => {
          checkNewPage(15 + flows.length * 6);

          doc.setFontSize(9);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(...colors.darkGray);
          doc.text(`Von ${sourceCat}:`, margin, yPos);
          yPos += 6;

          doc.setFont('helvetica', 'normal');
          flows.forEach(flow => {
            doc.setTextColor(...colors.mediumGray);
            // Einfacher ASCII-Pfeil statt Unicode
            doc.text(`    ${flow.from}  -->  ${flow.to}`, margin, yPos);
            yPos += 5;
          });
          yPos += 4;
        });
      }

      // =====================================================
      // === FOOTER AUF ALLEN SEITEN ===
      // =====================================================
      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(...colors.lightGray);
        doc.text(`${i} / ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
      }

      // PDF speichern
      const filename = `${uc.name.replace(/[^a-zA-Z0-9äöüÄÖÜß]/g, '_')}_Dokumentation.pdf`;
      doc.save(filename);
    }

    // ============== START ==============
    init();
  </script>
</body>
</html>
